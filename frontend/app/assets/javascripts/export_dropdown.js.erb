$(function () {
  $(document).on("loadedrecordform.aspace", function(event) {

    // allow option sidebar to stay open when
    // elements are clicked
    $('.record-toolbar').on('change click keyup', '.dropdown-submenu input', function(e) {
      e.stopPropagation();
    });

    const exportHandlers = {
      'download-ead-action': {
        dropdownSelector: '#download-ead-dropdown',
        dataAttr: 'download-ead-url',
        getParams: () => ({
          include_unpublished: $("input#include-unpublished").is(':checked'),
          include_daos: $("input#include-daos").is(':checked'),
          include_uris: $("input#include-uris").is(':checked'),
          numbered_cs: $("input#numbered-cs").is(':checked'),
          ead3: $("input#ead3").is(':checked')
        }),
        openMethod: 'location'
      },
      'download-marc-action': {
        dropdownSelector: '#download-marc-dropdown',
        dataAttr: 'download-marc-url',
        getParams: () => ({
          include_unpublished_marc: $("input#include-unpublished-marc").is(':checked')
        }),
        openMethod: 'location'
      },
      'print-to-pdf-action': {
        dropdownSelector: '#print-to-pdf-dropdown',
        dataAttr: 'print-to-pdf-url',
        getParams: () => ({
          include_unpublished: $("input#include-unpublished-pdf").is(':checked'),
          include_uris: $("input#include-uris-pdf").is(':checked')
        }),
        openMethod: 'newTab'
      },
      'download-mets-action': {
        dropdownSelector: '#download-mets-dropdown',
        dataAttr: 'download-mets-url',
        getParams: () => ({
          dmd_scheme: $("input#js-dmd_scheme_mods").is(':checked') ? "mods" : "dc"
        }),
        openMethod: 'location'
      }
    };
    const actionClasses = Object.keys(exportHandlers);

    actionClasses.forEach(function(actionClass) {
      $('.record-toolbar').on('click', `a.${actionClass}`, function(e) {
        e.stopPropagation();
        e.preventDefault();

        const config = exportHandlers[actionClass];
        const url = AS.quickTemplate(
          decodeURIComponent($(config.dropdownSelector).data(config.dataAttr)),
          config.getParams()
        );

        if (config.openMethod === 'newTab') {
          window.open(url, '_blank');
        } else {
          location.href = url;
        }

        $('#export-dropdown-toggle').dropdown('hide');
      });
    });
  });
});
