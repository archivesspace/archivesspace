<div class="repository-header py-2">
  <nav class="navbar navbar-expand-md navbar-light bg-light">
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>
    <div class="navbar-collapse collapse" id="navbarContent">
      <% if session[:user] and session[:repo_id] %>
        <ul class="nav navbar-nav">
          <li class="px-4"<% if controller_name === "welcome" %>class="active px-4"<% end %>>
            <%= link_to raw('<span class="glyphicon glyphicon-home"></span><span class="sr-only">' + t("breadcrumb.home") + '</span>'), :controller => :welcome, :action => :index %>
          </li>
          <li class="dropdown browse-container px-4">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown"><%= t("actions.browse") %> <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class='dropdown-item'><%= link_to t("accession._plural"), :controller => :accessions, :action => :index %></li>
              <li class='dropdown-item'><%= link_to t("resource._plural"), :controller => :resources, :action => :index %></li>
              <li class='dropdown-item'><%= link_to t("digital_object._plural"), :controller => :digital_objects, :action => :index %></li>
              <li class="divider"></li>
              <li class='dropdown-item'><%= link_to t("subject._plural"), :controller => :subjects, :action => :index %></li>
              <li class='dropdown-item'><%= link_to t("agent._plural"), :controller => :agents, :action => :index %></li>
              <li class='dropdown-item'><%= link_to t("container_profile._plural"), :controller => :container_profiles, :action => :index %></li>
              <li class='dropdown-item'><%= link_to t("location._plural"), :controller => :locations, :action => :index %></li>
              <li class='dropdown-item'><%= link_to t("event._plural"), :controller => :events, :action => :index %></li>
              <li class='dropdown-item'><%= link_to t("collection_management._plural"), :controller => :collection_management, :action => :index %></li>
              <li class='dropdown-item'><%= link_to t("classification._plural"), :controller => :classifications, :action => :index %></li>
              <li class='dropdown-item'><%= link_to t("assessment._plural"), :controller => :assessments, :action => :index %></li>
              <li class="divider"></li>
              <li class='dropdown-item'><%= link_to t("job._plural"), :controller => :jobs, :action => :index %></li>
            </ul>
          </li>
          <% if ['update_accession_record', 'update_resource_record', 'update_digital_object_record',
                  'update_subject_record', 'update_event_record',
                  'update_agent_record', 'update_location_record', 'update_container_profile'].find {|p| user_can?(p)} %>
            <li class="dropdown create-container px-4">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"><%= t("navbar.create") %> <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <% if ['update_accession_record', 'update_resource_record', 'update_digital_object_record'].find {|p| user_can?(p)} %>
                  <% if user_can?('update_accession_record') %>
                    <li class='dropdown-item'><%= link_to t("accession._singular"), :controller => :accessions, :action => :new %></li>
                  <% end %>
                  <% if user_can?('update_resource_record') %>
                    <li class='dropdown-item'><%= link_to t("resource._singular"), :controller => :resources, :action => :new %></li>
                  <% end %>
                  <% if user_can?('update_digital_object_record') %>
                    <li class='dropdown-item'><%= link_to t("digital_object._singular"), :controller => :digital_objects, :action => :new %></li>
                  <% end %>

                  <% if ['update_subject_record', 'update_event_record',
                          'update_agent_record', 'update_location_record', 'update_container_profile'].find {|p| user_can?(p)} %>
                    <li class="divider"></li>
                  <% end %>
                <% end %>
                <% if user_can?('update_subject_record') %>
                  <li class='dropdown-item'><%= link_to t("subject._singular"), :controller => :subjects, :action => :new %></li>
                <% end %>
                <% if user_can?('update_agent_record') %>
                  <li class="dropdown-submenu dropdown-item">
                    <a href="javascript:void(0);"><%= t("agent._singular") %></a>
                    <ul class="dropdown-menu">
                      <li class='dropdown-item'><%= link_to t("agent_person._singular"), :controller => :agents, :action => :new, :agent_type => :agent_person %></li>
                      <li class='dropdown-item'><%= link_to t("agent_family._singular"), :controller => :agents, :action => :new, :agent_type => :agent_family %></li>
                      <li class='dropdown-item'><%= link_to t("agent_corporate_entity._singular"), :controller => :agents, :action => :new, :agent_type => :agent_corporate_entity %></li>
                      <li class='dropdown-item'><%= link_to t("agent_software._singular"), :controller => :agents, :action => :new, :agent_type => :agent_software %></li>
                    </ul>
                  </li>
                <% end %>
                <% if user_can?('update_container_profile_record') %>
                  <li class='dropdown-item'><%= link_to t("container_profile._singular"), :controller => :container_profiles, :action => :new %></li>
                <% end %>
                <% if user_can?('update_location_record') %>
                  <li class="dropdown-submenu dropdown-item">
                    <a href="javascript:void(0);"><%= t("location._singular") %></a>
                    <ul class="dropdown-menu">
                      <li class='dropdown-item'><%= link_to t("location._frontend.action.single"), :controller => :locations, :action => :new %></li>
                      <li class='dropdown-item'><%= link_to t("location._frontend.action.batch"), :controller => :locations, :action => :batch %></li>
                    </ul>
                  </li>
                <% end %>
                <% if user_can?('update_event_record') %>
                  <li class='dropdown-item'><%= link_to t("event._singular"), :controller => :events, :action => :new %></li>
                <% end %>
                <% if user_can?('update_classification_record') %>
                  <li class='dropdown-item'><%= link_to t("classification._singular"), :controller => :classifications, :action => :new %></li>
                <% end %>
                <% if user_can?('update_assessment_record') %>
                  <li class='dropdown-item'><%= link_to t("assessment._singular"), :controller => :assessments, :action => :new %></li>
                <% end %>

                <% if user_can?('create_job') %>
                  <li class="divider"></li>

                  <li class="dropdown-submenu dropdown-item">
                    <a href="javascript:void(0);"><%= t("job._singular") %></a>
                    <ul class="dropdown-menu">
                      <% job_types.each do |type, perms| %>
                        <% next if type == 'generate_slugs_job' && !AppConfig[:use_human_readable_urls] %>
                        <% next if type == 'generate_arks_job' && !AppConfig[:arks_enabled] %>
                        <%# We only want to trigger bulk imports from within a resource record %>
                        <% next if type == 'bulk_import_job' %>
                        <% if perms['create_permissions'].reject{|perm| user_can?(perm)}.empty? %>
                          <li class='dropdown-item'><%= link_to t("job.types.#{type}", :default => type), :controller => :jobs, :action => :new, :job_type => type %></li>
                        <% end %>
                      <% end %>
                    </ul>
                  </li>

                <% end %>
              </ul>
            </li>
          <% end %>
          <li class="px-4">
            <%= form_tag(url_for(:controller => :search, :action => :do_search), :method => :get, :class => "navbar-form pull-left") do %>
              <div class="input-group bg-white border rounded">
                <label for="global-search-box" class="sr-only sr-only-focusable"><%= t("navbar.search_placeholder") %></label>
                <input id="global-search-box" type="text" class="form-control border-left-0 border-top-0 border-bottom-0" placeholder="<%= t("navbar.search_placeholder") %>" name="q" value="<%= params[:q] %>"/>
                <div class="input-group-append">
                  <button id="global-search-button" class="btn btn-default" title="<%= t("navbar.search_button_title") %>" aria-label="<%= t("navbar.search_button_title") %>"><span class="glyphicon glyphicon-search"></span></button>
                  <button class="btn btn-default search-switcher last border-left" title="<%= t("navbar.show_advanced_search_button_title") %>" aria-label="<%= t("navbar.show_advanced_search_button_title") %>" aria-expanded="false" <% if params["advanced"] %>style="display:none"<% end %>><span class='glyphicon glyphicon-chevron-down'></span></button>
                </div>
              </div>
            <% end %>
          </li>
          <li class="px-4 d-flex w-100">
            <div class="advanced-search-container" <% if params["advanced"].blank? or params["advanced"]  === 'false' %>style="display: none"<% end %>>
              <%= render_aspace_partial :partial => "shared/advanced_search" %>
            </div>
          </li>
        </ul>
          <ul class="nav navbar-nav ml-auto">
            <li class="repo-container">
              <div class="btn-group bg-white border rounded align-items-center">
                <a href="<%= url_for :controller => :repositories, :action => :show, :id => session[:repo_id] %>" class="btn btn-default navbar-btn">
                  <span class="repository-label has-popover" tabindex="0" data-trigger="focus hover" data-placement="bottom" data-html='true' data-toggle='popover' data-title="<span class='icomoon icon-repository'>&#160;</span><%= CGI::escapeHTML(current_repo['repo_code']) %>" data-content="<%= CGI::escapeHTML(current_repo['name']) %>">
                    <span class="icomoon icon-repository"></span><span class="current-repository-id"><% if current_repo %><%= current_repo['repo_code'] %><% end %></span>
                    <% unless current_repo.publish %>
                      <span class="label label-warning"><%= t("navbar.unpublished") %></span>
                    <% end %>
                  </span>
                </a>
                <div class="btn-group border-left">
                  <a class="btn btn-default navbar-btn dropdown-toggle last" data-toggle="dropdown" href="#" title="<%= t("navbar.repository_settings") %>" aria-label="<%= t("navbar.repository_settings") %>"><span class="glyphicon glyphicon-cog"></span> <span class="caret"></span></a>
                  <ul class="dropdown-menu dropdown-menu-right">
                    <% found_an_item = false %>
                    <% if user_can?('manage_repository') %>
                      <% found_an_item = true %>
                      <li class='dropdown-item'><%= link_to t("navbar.manage_groups"), :controller => :groups, :action => :index %></li>
                      <li class='dropdown-item'><%= link_to t("user._frontend.section.manage_access"), :controller => :users, :action => :manage_access %></li>
                    <% end %>
                    <% if user_can?('manage_assessment_attributes') %>
                      <li class='dropdown-item'><%= link_to t("navbar.manage_assessment_attributes"), :controller => :assessment_attributes, :action => :edit %></li>
                    <% end %>
                    <% if user_can?('view_repository') %>
                      <% found_an_item = true %>
                      <li class='dropdown-item'><%= link_to t("navbar.manage_top_containers"), :controller => :top_containers, :action => :index %></li>
                    <% end %>
                    <% if found_an_item %>
                      <li class="divider"></li>
                    <% end %>
                    <% if user_can?('transfer_repository') && @repositories.length > 1 %>
                      <li class='dropdown-item'><%= link_to t("repository._frontend.section.transfer"), :controller => :repositories, :action => :transfer, :id => session[:repo_id] %></li>
                      <li class="divider"></li>
                    <% end %>
                    <% if user_can?('create_job') %>
                        <li class='dropdown-item'><%= link_to t("job._plural"), :controller => :jobs, :action => :index %></li>
                        <li class='dropdown-item'><%= link_to t("bulk_import.templates"), :controller => :bulk_import_templates, :action => :index %></li>
                      <li class="divider"></li>
                    <% end %>

                    <li class='dropdown-item'><%= link_to t("navbar.list_reports"), :controller => :jobs, :action => :new, :job_type => 'report_job' %></li>
                    <% if user_can?('manage_custom_report_templates') && AppConfig[:enable_custom_reports] %>
                      <li class='dropdown-item'><%= link_to t("custom_report_template._plural"), :controller => :custom_report_templates, :action => :index %></li>
                    <% end %>

                    <% if Plugins.repository_menu_items.any? {|plugin| has_permission_for_controller?(session, plugin)} %>
                      <li class="dropdown-submenu dropdown-item">
                        <a href="javascript:void(0);"><%= t("navbar.plugins") %></a>
                        <ul class="dropdown-menu">
                          <% Plugins.repository_menu_items.each do |plugin| %>
                            <% if has_permission_for_controller?(session, plugin) %>
                              <li class='dropdown-item'><%= link_to t("plugins.#{plugin}.label"), :controller => plugin.intern, :action => :index %></li>
                            <% end %>
                          <% end %>
                        </ul>
                      </li>
                    <% end %>
                  </ul>
                </div>
              </div>
            </li>
            <% if ArchivesSpaceHelp.enabled? %>
              <li><%= link_to_help :link_opts => {"data-placement" => (session[:user] ? "left" : "bottom")} %></li>
            <% end %>
          </ul>
      <% end %>
    </div>
  </nav>
</div>
