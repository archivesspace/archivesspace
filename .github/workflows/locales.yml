name: Validate and auto-correct locale files
permissions:
  contents: write
  pull-requests: write

on:
  workflow_dispatch:
    inputs:
      java-version:
        description: Java version to run on
        required: true
        type: choice
        options:
          - '11'
          - '17'
        default: '17'

  pull_request:
    branches:
      - '**'
    paths:
      - 'common/locales/**/*'
      - 'public/config/locales/**/*'
      - 'frontend/config/locales/**/*'
      - 'common/locale_utils/**/*'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  fix-locales:
    name: fix_locales
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}
          token: ${{ secrets.ASPACE_CI_BOT_TOKEN }}

      - name: Generate commit message for the auto-correction changes
        id: commit-message
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref || github.ref_name }}"
          if [[ $BRANCH_NAME =~ (ANW-[0-9]+) ]]; then
            COMMIT_MESSAGE="${BASH_REMATCH[1]} Auto-correct locale YAML variables"
          else
            COMMIT_MESSAGE="Auto-correct locale YAML variables"
          fi
          echo "message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "Commit message: $COMMIT_MESSAGE"

      - name: Do not proceed if latest commit was generated by this workflow already
        id: check-last-commit
        run: |
          LAST_COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
          EXPECTED_MESSAGE="${{ steps.commit-message.outputs.message }}"

          if [[ "$LAST_COMMIT_MESSAGE" == "$EXPECTED_MESSAGE" ]]; then
            echo "âœ“ Stopping workflow - last commit message matches auto-correct message. This prevents infinite loops."
            echo "Last commit: $LAST_COMMIT_MESSAGE"
            echo "should_proceed=false" >> $GITHUB_OUTPUT
          else
            echo "should_proceed=true" >> $GITHUB_OUTPUT
            echo "Will create commit with message: $EXPECTED_MESSAGE"
          fi
      - uses: actions/setup-java@v4
        if: steps.check-last-commit.outputs.should_proceed == 'true'
        with:
          java-version: ${{ inputs.java-version || 17  }} # https://github.com/actions/runner/issues/2372
          distribution: temurin
      - name: Download JRuby
        if: steps.check-last-commit.outputs.should_proceed == 'true'
        shell: bash
        run: |
          ./build/run bootstrap-jruby
      - name: Install root Gemfile gems
        if: steps.check-last-commit.outputs.should_proceed == 'true'
        shell: bash
        run: |
          ./build/run bundler -Dexcluded-gem-groups="development doc" -Dgemfile="../Gemfile"

      - name: Validate locale YAML files
        if: steps.check-last-commit.outputs.should_proceed == 'true'
        run: ./build/run rake -Dtask=locales:validate_yaml

      - name: Auto correct locale YAML files
        if: steps.check-last-commit.outputs.should_proceed == 'true'
        run: ./build/run rake -Dtask=locales:fix_variables

      - name: Check for changes
        if: steps.check-last-commit.outputs.should_proceed == 'true'
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No locale changes needed - files are already correct"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Locale changes detected - will commit fixes"
            git diff --stat
          fi

      - name: Commit and push fixes
        if: steps.check-changes.outputs.has_changes == 'true' && steps.check-last-commit.outputs.should_proceed == 'true'
        run: |
          git config user.name "aspace-ci-bot"
          git config user.email "ArchivesSpaceHome@lyrasis.org"
          git add -A
          git commit -m "${{ steps.commit-message.outputs.message }}"
          git push

