name: E2E Tests

permissions:
  contents: read
  pull-requests: write

on:
  workflow_call:
    inputs:
      image_tag:
        required: true
        type: string

  workflow_dispatch:
    inputs:
      image_tag:
        description: "Docker image tag for archivesspace and solr"
        required: true
        type: string

defaults:
  run:
    working-directory: ./e2e-tests

concurrency:
  group: e2e-tests-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  cucumber_a_g:
    name: Run Tests Group A - B
    uses: './.github/workflows/common-e2e-tests.yml'
    with:
      name: 'a-b'
      image_tag: ${{ inputs.image_tag }}
      run-cmd: |
        dirs=$(find ./staff_features -mindepth 1 -maxdepth 1 -type d -iname '[a-b]*' | tr '\n' ' ')
        if [ -n "$dirs" ]; then
          bundle exec cucumber --strict HEADLESS=true HOST=localhost $dirs
        fi
  cucumber_h_m:
    name: Run Tests Group C - M
    uses: './.github/workflows/common-e2e-tests.yml'
    with:
      name: 'c-m'
      image_tag: ${{ inputs.image_tag }}
      run-cmd: |
        dirs=$(find ./staff_features -mindepth 1 -maxdepth 1 -type d -iname '[c-m]*' | tr '\n' ' ')
        if [ -n "$dirs" ]; then
          bundle exec cucumber --strict HEADLESS=true HOST=localhost $dirs
        fi
  cucumber_n_s:
    name: Run Tests Group N - S
    uses: './.github/workflows/common-e2e-tests.yml'
    with:
      name: 'n-s'
      image_tag: ${{ inputs.image_tag }}
      run-cmd: |
        dirs=$(find ./staff_features -mindepth 1 -maxdepth 1 -type d -iname '[n-s]*' | tr '\n' ' ')
        if [ -n "$dirs" ]; then
          bundle exec cucumber --strict HEADLESS=true HOST=localhost $dirs
        fi
  cucumber_t_z:
    name: Run Tests Group T - Z
    uses: './.github/workflows/common-e2e-tests.yml'
    with:
      name: 't-z'
      image_tag: ${{ inputs.image_tag }}
      run-cmd: |
        dirs=$(find ./staff_features -mindepth 1 -maxdepth 1 -type d -iname '[t-z]*' | tr '\n' ' ')
        if [ -n "$dirs" ]; then
          bundle exec cucumber --strict HEADLESS=true HOST=localhost $dirs
        fi
