<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: TreeNodes
  
    &mdash; Documentation by YARD 0.9.12
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "TreeNodes";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index (T)</a> &raquo;
    
    
    <span class="title">TreeNodes</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: TreeNodes
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  
  <dl>
    <dt>Included in:</dt>
    <dd><span class='object_link'><a href="ArchivalObject.html" title="ArchivalObject (class)">ArchivalObject</a></span>, <span class='object_link'><a href="ClassificationTerm.html" title="ClassificationTerm (class)">ClassificationTerm</a></span>, <span class='object_link'><a href="DigitalObjectComponent.html" title="DigitalObjectComponent (class)">DigitalObjectComponent</a></span></dd>
  </dl>
  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>backend/app/model/mixins/tree_nodes.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>Mixin methods for objects that belong in an ordered hierarchy (archival
objects, digital object components)</p>


  </div>
</div>
<div class="tags">
  

</div><h2>Defined Under Namespace</h2>
<p class="children">
  
    
      <strong class="modules">Modules:</strong> <span class='object_link'><a href="TreeNodes/ClassMethods.html" title="TreeNodes::ClassMethods (module)">ClassMethods</a></span>
    
  
    
  
    
  
</p>

  <h2>Constant Summary</h2>
  <dl class="constants">
    
      <dt id="POSITION_STEP-constant" class="">POSITION_STEP =
        <div class="docstring">
  <div class="discussion">
    <p>We’ll space out our positions by this amount.  This means we can insert
log2(POSITION_STEP) nodes before any given node before needing to rebalance.</p>

<p>Sized according to the largest number of nodes we think we might see under a
single parent.  The size of the position column is 2^31, so position can be
anywhere up to about 2 billion.  For a step size of 1000, that means we can
support (/ (expt 2 31) 1000) positions (around 2 million) before running out
of numbers.</p>


  </div>
</div>
<div class="tags">
  

</div>
      </dt>
      <dd><pre class="code"><span class='integer val'>1000</span>
</pre></dd>
    
      <dt id="DB_RETRIES-constant" class="">DB_RETRIES =
        <div class="docstring">
  <div class="discussion">
    <p>The number of times we’ll retry an update that might transiently fail due to
concurrent updates.</p>


  </div>
</div>
<div class="tags">
  

</div>
      </dt>
      <dd><pre class="code"><span class='integer val'>100</span>
</pre></dd>
    
  </dl>







  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#included-class_method" title="included (class method)">.<strong>included</strong>(base)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#attempt_set_parent_and_position-instance_method" title="#attempt_set_parent_and_position (instance method)">#<strong>attempt_set_parent_and_position</strong>(parent_id, position)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#attempt_set_position_in_list-instance_method" title="#attempt_set_position_in_list (instance method)">#<strong>attempt_set_position_in_list</strong>(target_logical_position)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>A note on terminology: a logical position refers to the position of a node as observed by the user (0…RECORD_COUNT).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#children-instance_method" title="#children (instance method)">#<strong>children</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#ensure_gap-instance_method" title="#ensure_gap (instance method)">#<strong>ensure_gap</strong>(start_physical_position)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#has_children%3F-instance_method" title="#has_children? (instance method)">#<strong>has_children?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#logical_position-instance_method" title="#logical_position (instance method)">#<strong>logical_position</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#previous_node-instance_method" title="#previous_node (instance method)">#<strong>previous_node</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#set_parent_and_position-instance_method" title="#set_parent_and_position (instance method)">#<strong>set_parent_and_position</strong>(parent_id, position)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#set_position_in_list-instance_method" title="#set_position_in_list (instance method)">#<strong>set_position_in_list</strong>(target_logical_position)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#set_root-instance_method" title="#set_root (instance method)">#<strong>set_root</strong>(new_root)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Move this node (and all records under it) to a new tree.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#transfer_to_repository-instance_method" title="#transfer_to_repository (instance method)">#<strong>transfer_to_repository</strong>(repository, transfer_group = [])  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#trigger_index_of_child_nodes-instance_method" title="#trigger_index_of_child_nodes (instance method)">#<strong>trigger_index_of_child_nodes</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_from_json-instance_method" title="#update_from_json (instance method)">#<strong>update_from_json</strong>(json, extra_values = {}, apply_nested_records = true)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="included-class_method">
  
    .<strong>included</strong>(base)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


21
22
23</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/tree_nodes.rb', line 21</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_included identifier id'>included</span><span class='lparen token'>(</span><span class='rubyid_base identifier id'>base</span><span class='rparen token'>)</span>
  <span class='rubyid_base identifier id'>base</span><span class='dot token'>.</span><span class='rubyid_extend identifier id'>extend</span><span class='lparen token'>(</span><span class='rubyid_ClassMethods constant id'>ClassMethods</span><span class='rparen token'>)</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="attempt_set_parent_and_position-instance_method">
  
    #<strong>attempt_set_parent_and_position</strong>(parent_id, position)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/tree_nodes.rb', line 200</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_attempt_set_parent_and_position identifier id'>attempt_set_parent_and_position</span><span class='lparen token'>(</span><span class='rubyid_parent_id identifier id'>parent_id</span><span class='comma token'>,</span> <span class='rubyid_position identifier id'>position</span><span class='rparen token'>)</span>
  <span class='rubyid_root_uri identifier id'>root_uri</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_uri_for identifier id'>uri_for</span><span class='lparen token'>(</span><span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_root_record_type identifier id'>root_record_type</span><span class='dot token'>.</span><span class='rubyid_intern identifier id'>intern</span><span class='comma token'>,</span> <span class='rubyid_self self kw'>self</span><span class='lbrack token'>[</span><span class='symbol val'>:root_record_id</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>

  <span class='rubyid_if if kw'>if</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span> <span class='eq op'>==</span> <span class='rubyid_parent_id identifier id'>parent_id</span>
    <span class='rubyid_raise identifier id'>raise</span> <span class='string val'>&quot;Can&#39;t make a record into its own parent&quot;</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_parent_name identifier id'>parent_name</span> <span class='assign token'>=</span> <span class='rubyid_if if kw'>if</span> <span class='rubyid_parent_id identifier id'>parent_id</span>
                  <span class='dstring node'>&quot;#{parent_id}@#{self.class.node_record_type}&quot;</span>
                <span class='rubyid_else else kw'>else</span>
                  <span class='dstring node'>&quot;root@#{root_uri}&quot;</span>
                <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_new_values identifier id'>new_values</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span>
    <span class='symbol val'>:parent_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_parent_id identifier id'>parent_id</span><span class='comma token'>,</span>
    <span class='symbol val'>:parent_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_parent_name identifier id'>parent_name</span><span class='comma token'>,</span>
    <span class='symbol val'>:system_mtime</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_Time constant id'>Time</span><span class='dot token'>.</span><span class='rubyid_now identifier id'>now</span>
  <span class='rbrace token'>}</span>

  <span class='rubyid_if if kw'>if</span> <span class='rubyid_parent_name identifier id'>parent_name</span> <span class='eq op'>==</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_parent_name identifier id'>parent_name</span>
    <span class='comment val'># Position is unchanged initially</span>
    <span class='rubyid_new_values identifier id'>new_values</span><span class='lbrack token'>[</span><span class='symbol val'>:position</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_position identifier id'>position</span>
  <span class='rubyid_else else kw'>else</span>
    <span class='comment val'># Append this node to the new parent initially</span>
    <span class='rubyid_new_values identifier id'>new_values</span><span class='lbrack token'>[</span><span class='symbol val'>:position</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_next_position_for_parent identifier id'>next_position_for_parent</span><span class='lparen token'>(</span><span class='rubyid_parent_name identifier id'>parent_name</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='comment val'># Run through the standard validation without actually saving</span>
  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_set identifier id'>set</span><span class='lparen token'>(</span><span class='rubyid_new_values identifier id'>new_values</span><span class='rparen token'>)</span>
  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_validate identifier id'>validate</span>

  <span class='rubyid_if if kw'>if</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_errors identifier id'>errors</span> <span class='andop op'>&amp;&amp;</span> <span class='notop op'>!</span><span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_errors identifier id'>errors</span><span class='dot token'>.</span><span class='rubyid_empty? fid id'>empty?</span>
    <span class='rubyid_raise identifier id'>raise</span> <span class='rubyid_Sequel constant id'>Sequel</span><span class='colon2 op'>::</span><span class='rubyid_ValidationFailed constant id'>ValidationFailed</span><span class='dot token'>.</span><span class='rubyid_new identifier id'>new</span><span class='lparen token'>(</span><span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_errors identifier id'>errors</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_dataset identifier id'>dataset</span><span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_update identifier id'>update</span><span class='lparen token'>(</span><span class='rubyid_new_values identifier id'>new_values</span><span class='rparen token'>)</span>
  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_refresh identifier id'>refresh</span>

  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_set_position_in_list identifier id'>set_position_in_list</span><span class='lparen token'>(</span><span class='rubyid_position identifier id'>position</span><span class='rparen token'>)</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="attempt_set_position_in_list-instance_method">
  
    #<strong>attempt_set_position_in_list</strong>(target_logical_position)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>A note on terminology: a logical position refers to the position of a node
as observed by the user (0…RECORD_COUNT).  A physical position is the
position number stored in the database, which may have gaps.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/tree_nodes.rb', line 56</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_attempt_set_position_in_list identifier id'>attempt_set_position_in_list</span><span class='lparen token'>(</span><span class='rubyid_target_logical_position identifier id'>target_logical_position</span><span class='rparen token'>)</span>
  <span class='rubyid_DB constant id'>DB</span><span class='dot token'>.</span><span class='rubyid_open identifier id'>open</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_db identifier id'>db</span><span class='bitor op'>|</span>
    <span class='rubyid_ordered_siblings identifier id'>ordered_siblings</span> <span class='assign token'>=</span> <span class='rubyid_db identifier id'>db</span><span class='lbrack token'>[</span><span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_node_model identifier id'>node_model</span><span class='dot token'>.</span><span class='rubyid_table_name identifier id'>table_name</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:parent_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_parent_name identifier id'>parent_name</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_order identifier id'>order</span><span class='lparen token'>(</span><span class='symbol val'>:position</span><span class='rparen token'>)</span>
    <span class='rubyid_siblings_count identifier id'>siblings_count</span> <span class='assign token'>=</span> <span class='rubyid_ordered_siblings identifier id'>ordered_siblings</span><span class='dot token'>.</span><span class='rubyid_count identifier id'>count</span>

    <span class='rubyid_target_logical_position identifier id'>target_logical_position</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rubyid_target_logical_position identifier id'>target_logical_position</span><span class='comma token'>,</span> <span class='rubyid_siblings_count identifier id'>siblings_count</span> <span class='minus op'>-</span> <span class='integer val'>1</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_min identifier id'>min</span>

    <span class='rubyid_current_physical_position identifier id'>current_physical_position</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_position identifier id'>position</span>
    <span class='rubyid_current_logical_position identifier id'>current_logical_position</span> <span class='assign token'>=</span> <span class='rubyid_ordered_siblings identifier id'>ordered_siblings</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span> <span class='lbrace token'>{</span> <span class='rubyid_position identifier id'>position</span> <span class='lt op'>&lt;</span> <span class='rubyid_current_physical_position identifier id'>current_physical_position</span> <span class='rbrace token'>}</span><span class='dot token'>.</span><span class='rubyid_count identifier id'>count</span>

    <span class='comment val'># We&#39;ll determine which node will fall to the left of our moved node, and</span>
    <span class='comment val'># which will fall to the right.  We&#39;re going to set our physical position to</span>
    <span class='comment val'># the halfway point of those two nodes.  For example, if left node is</span>
    <span class='comment val'># position 1000 and right node is position 2000, we&#39;ll take position 1500.</span>
    <span class='comment val'># If there&#39;s no gap, we&#39;ll create one!</span>
    <span class='comment val'>#</span>
    <span class='rubyid_left_node_idx identifier id'>left_node_idx</span> <span class='assign token'>=</span> <span class='rubyid_target_logical_position identifier id'>target_logical_position</span> <span class='minus op'>-</span> <span class='integer val'>1</span>

    <span class='rubyid_if if kw'>if</span> <span class='rubyid_current_logical_position identifier id'>current_logical_position</span> <span class='lt op'>&lt;</span> <span class='rubyid_target_logical_position identifier id'>target_logical_position</span>
      <span class='comment val'># If the node is being moved to the right, we need to adjust our index to</span>
      <span class='comment val'># compensate for the fact that everything logically shifts to the left as we</span>
      <span class='comment val'># pop it out.</span>
      <span class='rubyid_left_node_idx identifier id'>left_node_idx</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
    <span class='rubyid_end end kw'>end</span>

    <span class='rubyid_left_node_physical_position identifier id'>left_node_physical_position</span> <span class='assign token'>=</span>
      <span class='rubyid_if if kw'>if</span> <span class='rubyid_left_node_idx identifier id'>left_node_idx</span> <span class='lt op'>&lt;</span> <span class='integer val'>0</span>
        <span class='comment val'># We&#39;ll be the first item in the list (nobody to the left of us)</span>
        <span class='rubyid_nil nil kw'>nil</span>
      <span class='rubyid_else else kw'>else</span>
        <span class='rubyid_ordered_siblings identifier id'>ordered_siblings</span><span class='dot token'>.</span><span class='rubyid_offset identifier id'>offset</span><span class='lparen token'>(</span><span class='rubyid_left_node_idx identifier id'>left_node_idx</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_get identifier id'>get</span><span class='lparen token'>(</span><span class='symbol val'>:position</span><span class='rparen token'>)</span>
      <span class='rubyid_end end kw'>end</span>

    <span class='rubyid_right_node_idx identifier id'>right_node_idx</span> <span class='assign token'>=</span> <span class='rubyid_left_node_idx identifier id'>left_node_idx</span> <span class='plus op'>+</span> <span class='integer val'>1</span>

    <span class='rubyid_right_node_physical_position identifier id'>right_node_physical_position</span> <span class='assign token'>=</span>
      <span class='rubyid_if if kw'>if</span> <span class='rubyid_right_node_idx identifier id'>right_node_idx</span> <span class='geq op'>&gt;=</span> <span class='rubyid_siblings_count identifier id'>siblings_count</span>
        <span class='comment val'># We&#39;ll be the last item in the list (nobody to the right of us)</span>
        <span class='rubyid_nil nil kw'>nil</span>
      <span class='rubyid_else else kw'>else</span>
        <span class='rubyid_ordered_siblings identifier id'>ordered_siblings</span><span class='dot token'>.</span><span class='rubyid_offset identifier id'>offset</span><span class='lparen token'>(</span><span class='rubyid_right_node_idx identifier id'>right_node_idx</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_get identifier id'>get</span><span class='lparen token'>(</span><span class='symbol val'>:position</span><span class='rparen token'>)</span>
      <span class='rubyid_end end kw'>end</span>

    <span class='rubyid_new_position identifier id'>new_position</span> <span class='assign token'>=</span>
      <span class='rubyid_if if kw'>if</span> <span class='rubyid_left_node_physical_position identifier id'>left_node_physical_position</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span> <span class='andop op'>&amp;&amp;</span> <span class='rubyid_right_node_physical_position identifier id'>right_node_physical_position</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span>
        <span class='comment val'># We&#39;re first in the list!</span>
        <span class='rubyid_new_position identifier id'>new_position</span> <span class='assign token'>=</span> <span class='rubyid_TreeNodes constant id'>TreeNodes</span><span class='colon2 op'>::</span><span class='rubyid_POSITION_STEP constant id'>POSITION_STEP</span>
      <span class='rubyid_else else kw'>else</span>
        <span class='rubyid_if if kw'>if</span> <span class='rubyid_right_node_physical_position identifier id'>right_node_physical_position</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span>
          <span class='comment val'># Add to the end</span>
          <span class='rubyid_left_node_physical_position identifier id'>left_node_physical_position</span> <span class='plus op'>+</span> <span class='rubyid_TreeNodes constant id'>TreeNodes</span><span class='colon2 op'>::</span><span class='rubyid_POSITION_STEP constant id'>POSITION_STEP</span>
        <span class='rubyid_else else kw'>else</span>
          <span class='rubyid_left_node_physical_position identifier id'>left_node_physical_position</span> <span class='opasgn op'>||=</span> <span class='integer val'>0</span>

          <span class='rubyid_if if kw'>if</span> <span class='lparen token'>(</span><span class='rubyid_right_node_physical_position identifier id'>right_node_physical_position</span> <span class='minus op'>-</span> <span class='rubyid_left_node_physical_position identifier id'>left_node_physical_position</span><span class='rparen token'>)</span> <span class='leq op'>&lt;=</span> <span class='integer val'>1</span>
            <span class='comment val'># We need to create a gap to fit our moved node</span>
            <span class='rubyid_right_node_physical_position identifier id'>right_node_physical_position</span> <span class='assign token'>=</span> <span class='rubyid_ensure_gap identifier id'>ensure_gap</span><span class='lparen token'>(</span><span class='rubyid_right_node_physical_position identifier id'>right_node_physical_position</span><span class='rparen token'>)</span>
          <span class='rubyid_end end kw'>end</span>

          <span class='comment val'># Put the node we&#39;re moving halfway between the left and right nodes</span>
          <span class='rubyid_left_node_physical_position identifier id'>left_node_physical_position</span> <span class='plus op'>+</span> <span class='lparen token'>(</span><span class='lparen token'>(</span><span class='rubyid_right_node_physical_position identifier id'>right_node_physical_position</span> <span class='minus op'>-</span> <span class='rubyid_left_node_physical_position identifier id'>left_node_physical_position</span><span class='rparen token'>)</span> <span class='div op'>/</span> <span class='integer val'>2</span><span class='rparen token'>)</span>
        <span class='rubyid_end end kw'>end</span>
      <span class='rubyid_end end kw'>end</span>

    <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_dataset identifier id'>dataset</span><span class='dot token'>.</span><span class='rubyid_db identifier id'>db</span><span class='lbrack token'>[</span><span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_table_name identifier id'>table_name</span><span class='rbrack token'>]</span>
      <span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span><span class='rparen token'>)</span>
      <span class='dot token'>.</span><span class='rubyid_update identifier id'>update</span><span class='lparen token'>(</span><span class='symbol val'>:position</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_new_position identifier id'>new_position</span><span class='comma token'>,</span>
              <span class='symbol val'>:system_mtime</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_Time constant id'>Time</span><span class='dot token'>.</span><span class='rubyid_now identifier id'>now</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="children-instance_method">
  
    #<strong>children</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


242
243
244</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/tree_nodes.rb', line 242</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_children identifier id'>children</span>
  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:parent_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_order identifier id'>order</span><span class='lparen token'>(</span><span class='symbol val'>:position</span><span class='rparen token'>)</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="ensure_gap-instance_method">
  
    #<strong>ensure_gap</strong>(start_physical_position)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/tree_nodes.rb', line 127</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_ensure_gap identifier id'>ensure_gap</span><span class='lparen token'>(</span><span class='rubyid_start_physical_position identifier id'>start_physical_position</span><span class='rparen token'>)</span>
  <span class='rubyid_siblings identifier id'>siblings</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_dataset identifier id'>dataset</span>
             <span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:root_record_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_root_record_id identifier id'>root_record_id</span><span class='rparen token'>)</span>
             <span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:parent_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_parent_id identifier id'>parent_id</span><span class='rparen token'>)</span>
             <span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span> <span class='lbrace token'>{</span> <span class='rubyid_position identifier id'>position</span> <span class='geq op'>&gt;=</span> <span class='rubyid_start_physical_position identifier id'>start_physical_position</span> <span class='rbrace token'>}</span>

  <span class='comment val'># Sigh.  Work around:</span>
  <span class='comment val'># http://stackoverflow.com/questions/5403437/atomic-multi-row-update-with-a-unique-constraint</span>
  <span class='rubyid_siblings identifier id'>siblings</span><span class='dot token'>.</span><span class='rubyid_update identifier id'>update</span><span class='lparen token'>(</span><span class='symbol val'>:parent_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_Sequel constant id'>Sequel</span><span class='dot token'>.</span><span class='rubyid_lit identifier id'>lit</span><span class='lparen token'>(</span><span class='rubyid_DB constant id'>DB</span><span class='dot token'>.</span><span class='rubyid_concat identifier id'>concat</span><span class='lparen token'>(</span><span class='string val'>&#39;CAST(id as CHAR(10))&#39;</span><span class='comma token'>,</span> <span class='string val'>&quot;&#39;_temp&#39;&quot;</span><span class='rparen token'>)</span><span class='rparen token'>)</span><span class='rparen token'>)</span>

  <span class='comment val'># Do the real update</span>
  <span class='rubyid_siblings identifier id'>siblings</span><span class='dot token'>.</span><span class='rubyid_update identifier id'>update</span><span class='lparen token'>(</span><span class='symbol val'>:position</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_Sequel constant id'>Sequel</span><span class='dot token'>.</span><span class='rubyid_lit identifier id'>lit</span><span class='lparen token'>(</span><span class='string val'>&#39;position + &#39;</span> <span class='plus op'>+</span> <span class='rubyid_TreeNodes constant id'>TreeNodes</span><span class='colon2 op'>::</span><span class='rubyid_POSITION_STEP constant id'>POSITION_STEP</span><span class='dot token'>.</span><span class='rubyid_to_s identifier id'>to_s</span><span class='rparen token'>)</span><span class='comma token'>,</span>
                  <span class='symbol val'>:system_mtime</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_Time constant id'>Time</span><span class='dot token'>.</span><span class='rubyid_now identifier id'>now</span><span class='rparen token'>)</span>

  <span class='comment val'># Puts it back again</span>
  <span class='rubyid_siblings identifier id'>siblings</span><span class='dot token'>.</span><span class='rubyid_update identifier id'>update</span><span class='lparen token'>(</span><span class='symbol val'>:parent_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_parent_name identifier id'>parent_name</span><span class='rparen token'>)</span>

  <span class='rubyid_start_physical_position identifier id'>start_physical_position</span> <span class='plus op'>+</span> <span class='rubyid_TreeNodes constant id'>TreeNodes</span><span class='colon2 op'>::</span><span class='rubyid_POSITION_STEP constant id'>POSITION_STEP</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="has_children?-instance_method">
  
    #<strong>has_children?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


247
248
249</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/tree_nodes.rb', line 247</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_has_children? fid id'>has_children?</span>
  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:parent_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_count identifier id'>count</span> <span class='gt op'>&gt;</span> <span class='integer val'>0</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="logical_position-instance_method">
  
    #<strong>logical_position</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


148
149
150
151</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/tree_nodes.rb', line 148</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_logical_position identifier id'>logical_position</span>
  <span class='rubyid_relative_position identifier id'>relative_position</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_position identifier id'>position</span>
  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_dataset identifier id'>dataset</span><span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:parent_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_parent_name identifier id'>parent_name</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span> <span class='lbrace token'>{</span> <span class='rubyid_position identifier id'>position</span> <span class='lt op'>&lt;</span> <span class='rubyid_relative_position identifier id'>relative_position</span> <span class='rbrace token'>}</span><span class='dot token'>.</span><span class='rubyid_count identifier id'>count</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="previous_node-instance_method">
  
    #<strong>previous_node</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


252
253
254
255
256
257
258
259
260
261
262
263
264</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/tree_nodes.rb', line 252</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_previous_node identifier id'>previous_node</span>
  <span class='rubyid_pos identifier id'>pos</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_position identifier id'>position</span>
  <span class='rubyid_node identifier id'>node</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:parent_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_parent_id identifier id'>parent_id</span><span class='rparen token'>)</span>
                   <span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:root_record_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_root_record_id identifier id'>root_record_id</span><span class='rparen token'>)</span>
                   <span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span> <span class='lbrace token'>{</span> <span class='rubyid_position identifier id'>position</span> <span class='lt op'>&lt;</span> <span class='rubyid_pos identifier id'>pos</span> <span class='rbrace token'>}</span>
                   <span class='dot token'>.</span><span class='rubyid_reverse identifier id'>reverse</span><span class='lparen token'>(</span><span class='symbol val'>:position</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_limit identifier id'>limit</span><span class='lparen token'>(</span><span class='integer val'>1</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_first identifier id'>first</span>

  <span class='rubyid_if if kw'>if</span> <span class='notop op'>!</span><span class='rubyid_node identifier id'>node</span> <span class='andop op'>&amp;&amp;</span> <span class='notop op'>!</span><span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_parent_id identifier id'>parent_id</span>
    <span class='rubyid_raise identifier id'>raise</span> <span class='rubyid_NotFoundException constant id'>NotFoundException</span><span class='dot token'>.</span><span class='rubyid_new identifier id'>new</span><span class='lparen token'>(</span><span class='string val'>&quot;No previous node&quot;</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_node identifier id'>node</span> <span class='orop op'>||</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='lbrack token'>[</span><span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_parent_id identifier id'>parent_id</span><span class='rbrack token'>]</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="set_parent_and_position-instance_method">
  
    #<strong>set_parent_and_position</strong>(parent_id, position)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


193
194
195
196
197</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/tree_nodes.rb', line 193</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_set_parent_and_position identifier id'>set_parent_and_position</span><span class='lparen token'>(</span><span class='rubyid_parent_id identifier id'>parent_id</span><span class='comma token'>,</span> <span class='rubyid_position identifier id'>position</span><span class='rparen token'>)</span>
  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_retry_db_update identifier id'>retry_db_update</span> <span class='rubyid_do do kw'>do</span>
    <span class='rubyid_attempt_set_parent_and_position identifier id'>attempt_set_parent_and_position</span><span class='lparen token'>(</span><span class='rubyid_parent_id identifier id'>parent_id</span><span class='comma token'>,</span> <span class='rubyid_position identifier id'>position</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="set_position_in_list-instance_method">
  
    #<strong>set_position_in_list</strong>(target_logical_position)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


46
47
48
49
50</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/tree_nodes.rb', line 46</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_set_position_in_list identifier id'>set_position_in_list</span><span class='lparen token'>(</span><span class='rubyid_target_logical_position identifier id'>target_logical_position</span><span class='rparen token'>)</span>
  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_retry_db_update identifier id'>retry_db_update</span> <span class='rubyid_do do kw'>do</span>
    <span class='rubyid_attempt_set_position_in_list identifier id'>attempt_set_position_in_list</span><span class='lparen token'>(</span><span class='rubyid_target_logical_position identifier id'>target_logical_position</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="set_root-instance_method">
  
    #<strong>set_root</strong>(new_root)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Move this node (and all records under it) to a new tree.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/tree_nodes.rb', line 26</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_set_root identifier id'>set_root</span><span class='lparen token'>(</span><span class='rubyid_new_root identifier id'>new_root</span><span class='rparen token'>)</span>
  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_root_record_id identifier id'>root_record_id</span> <span class='assign token'>=</span> <span class='rubyid_new_root identifier id'>new_root</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span>

  <span class='rubyid_if if kw'>if</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_parent_id identifier id'>parent_id</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span>
    <span class='comment val'># This top-level node has been moved to a new tree.  Append it to the end of the list.</span>
    <span class='rubyid_root_uri identifier id'>root_uri</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_uri_for identifier id'>uri_for</span><span class='lparen token'>(</span><span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_root_record_type identifier id'>root_record_type</span><span class='dot token'>.</span><span class='rubyid_intern identifier id'>intern</span><span class='comma token'>,</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_root_record_id identifier id'>root_record_id</span><span class='rparen token'>)</span>
    <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_parent_name identifier id'>parent_name</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;root@#{root_uri}&quot;</span>

    <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_position identifier id'>position</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_next_position_for_parent identifier id'>next_position_for_parent</span><span class='lparen token'>(</span><span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_parent_name identifier id'>parent_name</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_save identifier id'>save</span>
  <span class='rubyid_refresh identifier id'>refresh</span>

  <span class='rubyid_children identifier id'>children</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_child identifier id'>child</span><span class='bitor op'>|</span>
    <span class='rubyid_child identifier id'>child</span><span class='dot token'>.</span><span class='rubyid_set_root identifier id'>set_root</span><span class='lparen token'>(</span><span class='rubyid_new_root identifier id'>new_root</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="transfer_to_repository-instance_method">
  
    #<strong>transfer_to_repository</strong>(repository, transfer_group = [])  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


267
268
269
270
271
272
273
274
275</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/tree_nodes.rb', line 267</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_transfer_to_repository identifier id'>transfer_to_repository</span><span class='lparen token'>(</span><span class='rubyid_repository identifier id'>repository</span><span class='comma token'>,</span> <span class='rubyid_transfer_group identifier id'>transfer_group</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
  <span class='comment val'># All records under this one will be transferred too</span>
  <span class='rubyid_children identifier id'>children</span><span class='dot token'>.</span><span class='rubyid_each_with_index identifier id'>each_with_index</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_child identifier id'>child</span><span class='comma token'>,</span> <span class='rubyid_i identifier id'>i</span><span class='bitor op'>|</span>
    <span class='rubyid_child identifier id'>child</span><span class='dot token'>.</span><span class='rubyid_transfer_to_repository identifier id'>transfer_to_repository</span><span class='lparen token'>(</span><span class='rubyid_repository identifier id'>repository</span><span class='comma token'>,</span> <span class='rubyid_transfer_group identifier id'>transfer_group</span> <span class='plus op'>+</span> <span class='lbrack token'>[</span><span class='rubyid_self self kw'>self</span><span class='rbrack token'>]</span><span class='rparen token'>)</span> 
  <span class='rubyid_end end kw'>end</span>

  <span class='comment val'># ensure that the sequence if updated</span>
  <span class='rubyid_super super kw'>super</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="trigger_index_of_child_nodes-instance_method">
  
    #<strong>trigger_index_of_child_nodes</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


187
188
189
190</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/tree_nodes.rb', line 187</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_trigger_index_of_child_nodes identifier id'>trigger_index_of_child_nodes</span>
  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_children identifier id'>children</span><span class='dot token'>.</span><span class='rubyid_update identifier id'>update</span><span class='lparen token'>(</span><span class='symbol val'>:system_mtime</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_Time constant id'>Time</span><span class='dot token'>.</span><span class='rubyid_now identifier id'>now</span><span class='rparen token'>)</span>
  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_children identifier id'>children</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span><span class='lparen token'>(</span><span class='bitand op'>&amp;</span><span class='symbol val'>:trigger_index_of_child_nodes</span><span class='rparen token'>)</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_from_json-instance_method">
  
    #<strong>update_from_json</strong>(json, extra_values = {}, apply_nested_records = true)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/tree_nodes.rb', line 154</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_update_from_json identifier id'>update_from_json</span><span class='lparen token'>(</span><span class='rubyid_json identifier id'>json</span><span class='comma token'>,</span> <span class='rubyid_extra_values identifier id'>extra_values</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='rubyid_apply_nested_records identifier id'>apply_nested_records</span> <span class='assign token'>=</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
  <span class='rubyid_root_uri identifier id'>root_uri</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_uri_for identifier id'>uri_for</span><span class='lparen token'>(</span><span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_root_record_type identifier id'>root_record_type</span><span class='comma token'>,</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_root_record_id identifier id'>root_record_id</span><span class='rparen token'>)</span>

  <span class='rubyid_do_position_override identifier id'>do_position_override</span> <span class='assign token'>=</span> <span class='rubyid_json identifier id'>json</span><span class='lbrack token'>[</span><span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_root_record_type identifier id'>root_record_type</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='string val'>&#39;ref&#39;</span><span class='rbrack token'>]</span> <span class='neq op'>!=</span> <span class='rubyid_root_uri identifier id'>root_uri</span> <span class='orop op'>||</span> <span class='rubyid_extra_values identifier id'>extra_values</span><span class='lbrack token'>[</span><span class='symbol val'>:force_reposition</span><span class='rbrack token'>]</span>

  <span class='rubyid_if if kw'>if</span> <span class='rubyid_do_position_override identifier id'>do_position_override</span>
    <span class='rubyid_extra_values identifier id'>extra_values</span><span class='dot token'>.</span><span class='rubyid_delete identifier id'>delete</span><span class='lparen token'>(</span><span class='symbol val'>:force_reposition</span><span class='rparen token'>)</span>
    <span class='rubyid_json identifier id'>json</span><span class='dot token'>.</span><span class='rubyid_position identifier id'>position</span> <span class='assign token'>=</span> <span class='rubyid_nil nil kw'>nil</span>
    <span class='comment val'># Through some inexplicable sequence of events, the update is allowed to</span>
    <span class='comment val'># change the root record on the fly.  I guess we&#39;ll allow this...</span>
    <span class='rubyid_extra_values identifier id'>extra_values</span> <span class='assign token'>=</span> <span class='rubyid_extra_values identifier id'>extra_values</span><span class='dot token'>.</span><span class='rubyid_merge identifier id'>merge</span><span class='lparen token'>(</span><span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_determine_tree_position_for_new_node identifier id'>determine_tree_position_for_new_node</span><span class='lparen token'>(</span><span class='rubyid_json identifier id'>json</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
  <span class='rubyid_else else kw'>else</span>
    <span class='rubyid_if if kw'>if</span> <span class='notop op'>!</span><span class='rubyid_json identifier id'>json</span><span class='dot token'>.</span><span class='rubyid_position identifier id'>position</span>
      <span class='comment val'># The incoming JSON had no position set.  Just keep what we already had.</span>
      <span class='rubyid_extra_values identifier id'>extra_values</span><span class='lbrack token'>[</span><span class='string val'>&#39;position&#39;</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_position identifier id'>position</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_obj identifier id'>obj</span> <span class='assign token'>=</span> <span class='rubyid_super super kw'>super</span><span class='lparen token'>(</span><span class='rubyid_json identifier id'>json</span><span class='comma token'>,</span> <span class='rubyid_extra_values identifier id'>extra_values</span><span class='comma token'>,</span> <span class='rubyid_apply_nested_records identifier id'>apply_nested_records</span><span class='rparen token'>)</span>

  <span class='rubyid_if if kw'>if</span> <span class='rubyid_json identifier id'>json</span><span class='dot token'>.</span><span class='rubyid_position identifier id'>position</span>
    <span class='comment val'># Our incoming JSON wants to set the position.  That&#39;s fine</span>
    <span class='rubyid_set_position_in_list identifier id'>set_position_in_list</span><span class='lparen token'>(</span><span class='rubyid_json identifier id'>json</span><span class='dot token'>.</span><span class='rubyid_position identifier id'>position</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_ensure_consistent_tree identifier id'>ensure_consistent_tree</span><span class='lparen token'>(</span><span class='rubyid_obj identifier id'>obj</span><span class='rparen token'>)</span>

  <span class='rubyid_trigger_index_of_child_nodes identifier id'>trigger_index_of_child_nodes</span>

  <span class='rubyid_obj identifier id'>obj</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  ArchivesSpace Version fix-date-range-search Documentation Generated on Thu Jun 21 10:19:11 2018 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.12 (ruby-2.3.3).
</div>
    </div>
  </body>
</html>