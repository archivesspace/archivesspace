<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: SlugHelpers
  
    &mdash; Documentation by YARD 0.9.20
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "SlugHelpers";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="alpha_index.html">Index (S)</a> &raquo;
    
    
    <span class="title">SlugHelpers</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: SlugHelpers
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>backend/app/lib/slugs/slug_helpers.rb<span class="defines">,<br />
  backend/app/lib/slugs/slug_helpers_generate.rb,<br /> backend/app/lib/slugs/slug_helpers_eligibility.rb,<br /> backend/app/lib/slugs/slug_helpers_generate_by_id.rb,<br /> backend/app/lib/slugs/slug_helpers_generate_by_name.rb</span>
</dd>
  </dl>
  
</div>


  
    <h2>
      Constant Summary
      <small><a href="#" class="constants_summary_toggle">collapse</a></small>
    </h2>

    <dl class="constants">
      
        <dt id="AGENT_RECORD_TYPES-constant" class="">AGENT_RECORD_TYPES =
          <div class="docstring">
  <div class="discussion">
    <p>TODO: get lists dynamically</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='lbrack token'>[</span>
  <span class='string val'>&quot;AgentPerson&quot;</span><span class='comma token'>,</span>
  <span class='string val'>&quot;AgentFamily&quot;</span><span class='comma token'>,</span>
  <span class='string val'>&quot;AgentCorporateEntity&quot;</span><span class='comma token'>,</span>
  <span class='string val'>&quot;AgentSoftware&quot;</span><span class='comma token'>,</span>
<span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_freeze identifier id'>freeze</span>
</pre></dd>
      
        <dt id="BASE_RECORD_TYPES-constant" class="">BASE_RECORD_TYPES =
          
        </dt>
        <dd><pre class="code"><span class='lbrack token'>[</span>
  <span class='string val'>&quot;Resource&quot;</span><span class='comma token'>,</span>
  <span class='string val'>&quot;Subject&quot;</span><span class='comma token'>,</span>
  <span class='string val'>&quot;DigitalObject&quot;</span><span class='comma token'>,</span>
  <span class='string val'>&quot;Accession&quot;</span><span class='comma token'>,</span>
  <span class='string val'>&quot;Classification&quot;</span><span class='comma token'>,</span>
  <span class='string val'>&quot;ClassificationTerm&quot;</span><span class='comma token'>,</span>
  <span class='string val'>&quot;ArchivalObject&quot;</span><span class='comma token'>,</span>
  <span class='string val'>&quot;DigitalObjectComponent&quot;</span><span class='comma token'>,</span>
<span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_freeze identifier id'>freeze</span>
</pre></dd>
      
        <dt id="NAME_RECORD_TYPES-constant" class="">NAME_RECORD_TYPES =
          
        </dt>
        <dd><pre class="code"><span class='lbrack token'>[</span>
  <span class='string val'>&quot;NamePerson&quot;</span><span class='comma token'>,</span>
  <span class='string val'>&quot;NameCorporateEntity&quot;</span><span class='comma token'>,</span>
  <span class='string val'>&quot;NameFamily&quot;</span><span class='comma token'>,</span>
  <span class='string val'>&quot;NameSoftware&quot;</span><span class='comma token'>,</span>
<span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_freeze identifier id'>freeze</span>
</pre></dd>
      
    </dl>
  







  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#base_slug_changed%3F-class_method" title="base_slug_changed? (class method)">.<strong>base_slug_changed?</strong>(slug, previous_slug)  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>returns true if the base slug (non-deduped) is different between slug and previous_slug Examples: slug = “foo”, previous_slug = “foo_1” =&gt; false slug = “foo_123”, previous_slug = “foo_123_1” =&gt; false slug = “foo_123”, previous_slug = “foo_124” =&gt; true slug = “foo_123”, previous_slug = “foo_124_1” =&gt; true.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#base_sluggable_class%3F-class_method" title="base_sluggable_class? (class method)">.<strong>base_sluggable_class?</strong>(klass)  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#cache-class_method" title="cache (class method)">.<strong>cache</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#cache_reset-class_method" title="cache_reset (class method)">.<strong>cache_reset</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#cache_setup-class_method" title="cache_setup (class method)">.<strong>cache_setup</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>preload manually generated slugs into the cache.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#clean_slug-class_method" title="clean_slug (class method)">.<strong>clean_slug</strong>(slug)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>remove invalid chars and truncate slug NOTE: If changes are made here, then they should be also made in spec_slugs_helper.rb.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#dedupe_slug-class_method" title="dedupe_slug (class method)">.<strong>dedupe_slug</strong>(dupe_slug, count)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>dupe_slug is already in use.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#generate_slug_for_agent_name!-class_method" title="generate_slug_for_agent_name! (class method)">.<strong>generate_slug_for_agent_name!</strong>(entity)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>auto generate a slug for the Agent associated with this AgentName Then, find that associated Agent and update it’s slug.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_id_from_slug-class_method" title="get_id_from_slug (class method)">.<strong>get_id_from_slug</strong>(slug, controller, action)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Find the record given the slug, return id, repo_id, and table name.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_slugged_url_for_largetree-class_method" title="get_slugged_url_for_largetree (class method)">.<strong>get_slugged_url_for_largetree</strong>(jsonmodel_type, repo_id, slug)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Generates URLs for display in hirearchial tree links in public interface for Archival Objects and Digital object components.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#id_based_slug_for-class_method" title="id_based_slug_for (class method)">.<strong>id_based_slug_for</strong>(entity, klass)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>generate and return a string for a slug based on this thing’s ID.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#is_agent_name_type%3F-class_method" title="is_agent_name_type? (class method)">.<strong>is_agent_name_type?</strong>(klass)  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#is_agent_type%3F-class_method" title="is_agent_type? (class method)">.<strong>is_agent_type?</strong>(klass)  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#is_slug_auto_enabled%3F-class_method" title="is_slug_auto_enabled? (class method)">.<strong>is_slug_auto_enabled?</strong>(entity)  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>returns true if is_slug_auto is enabled for entity, or if we should treat it like it is.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#job_running-class_method" title="job_running (class method)">.<strong>job_running</strong>(status: false)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#job_running%3F-class_method" title="job_running? (class method)">.<strong>job_running?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#name_based_slug_for-class_method" title="name_based_slug_for (class method)">.<strong>name_based_slug_for</strong>(entity, klass)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Generate and return a string for a slug based on this thing’s title or name.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reset_autogenerated_slugs-class_method" title="reset_autogenerated_slugs (class method)">.<strong>reset_autogenerated_slugs</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>for the generate_slugs_runner job: clear out previously autogenerated slugs so we don’t have to lookup if generated slugs are in use from before this job was run (cache_setup preloads manually created slugs).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#run_dedupe_slug-class_method" title="run_dedupe_slug (class method)">.<strong>run_dedupe_slug</strong>(slug)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>runs dedupe if necessary.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#slug_data_updated%3F-class_method" title="slug_data_updated? (class method)">.<strong>slug_data_updated?</strong>(obj)  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Determine if our record has updated a data field that indicates an autogenerated slug should be updated.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#slug_in_use%3F-class_method" title="slug_in_use? (class method)">.<strong>slug_in_use?</strong>(slug)  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>given a slug, return true if slug is used by another entity.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#slug_record_types-class_method" title="slug_record_types (class method)">.<strong>slug_record_types</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="base_slug_changed?-class_method">
  
    .<strong>base_slug_changed?</strong>(slug, previous_slug)  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>returns true if the base slug (non-deduped) is different between slug and previous_slug
Examples:
slug = “foo”, previous_slug = “foo_1” =&gt; false
slug = “foo_123”, previous_slug = “foo_123_1” =&gt; false
slug = “foo_123”, previous_slug = “foo_124” =&gt; true
slug = “foo_123”, previous_slug = “foo_124_1” =&gt; true</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_generate.rb', line 114</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_base_slug_changed? fid id'>base_slug_changed?</span><span class='lparen token'>(</span><span class='rubyid_slug identifier id'>slug</span><span class='comma token'>,</span> <span class='rubyid_previous_slug identifier id'>previous_slug</span><span class='rparen token'>)</span>
  <span class='comment val'># first, compare the two slugs from left to right to see what they have in common. Remove anything in common.</span>
  <span class='comment val'># Then, remove anything that matches the pattern of underscore followed by digits, like _1, _2, or _314159, etc that would indicate a deduping suffix</span>
  <span class='comment val'># if there is nothing left, then the base slugs are the same.</span>

  <span class='comment val'># the base slug has changed if previous_slug is nil/empty but slug is not</span>
  <span class='rubyid_if if kw'>if</span> <span class='lparen token'>(</span><span class='rubyid_previous_slug identifier id'>previous_slug</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span> <span class='orop op'>||</span> <span class='rubyid_previous_slug identifier id'>previous_slug</span><span class='dot token'>.</span><span class='rubyid_empty? fid id'>empty?</span><span class='rparen token'>)</span> <span class='andop op'>&amp;&amp;</span>
     <span class='lparen token'>(</span><span class='notop op'>!</span><span class='rubyid_slug identifier id'>slug</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span> <span class='andop op'>&amp;&amp;</span> <span class='notop op'>!</span><span class='rubyid_slug identifier id'>slug</span><span class='dot token'>.</span><span class='rubyid_empty? fid id'>empty?</span><span class='rparen token'>)</span>
    <span class='rubyid_return return kw'>return</span> <span class='rubyid_true true kw'>true</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='comment val'># the base slug has changed if slug is nil/empty but previous_slug is not</span>
  <span class='rubyid_if if kw'>if</span> <span class='lparen token'>(</span><span class='rubyid_slug identifier id'>slug</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span> <span class='orop op'>||</span> <span class='rubyid_slug identifier id'>slug</span><span class='dot token'>.</span><span class='rubyid_empty? fid id'>empty?</span><span class='rparen token'>)</span> <span class='andop op'>&amp;&amp;</span>
     <span class='lparen token'>(</span><span class='notop op'>!</span><span class='rubyid_previous_slug identifier id'>previous_slug</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span> <span class='andop op'>&amp;&amp;</span> <span class='notop op'>!</span><span class='rubyid_previous_slug identifier id'>previous_slug</span><span class='dot token'>.</span><span class='rubyid_empty? fid id'>empty?</span><span class='rparen token'>)</span>
    <span class='rubyid_return return kw'>return</span> <span class='rubyid_true true kw'>true</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='comment val'># if we&#39;re at this point, then one of the two slugs is not nil or empty.</span>
  <span class='comment val'># We need to ensure we&#39;re calling the following gsubs on a non empty string.</span>
  <span class='rubyid_if if kw'>if</span> <span class='rubyid_previous_slug identifier id'>previous_slug</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span> <span class='orop op'>||</span> <span class='rubyid_previous_slug identifier id'>previous_slug</span><span class='dot token'>.</span><span class='rubyid_empty? fid id'>empty?</span>
    <span class='rubyid_check_on identifier id'>check_on</span> <span class='assign token'>=</span> <span class='rubyid_slug identifier id'>slug</span>
    <span class='rubyid_check_with identifier id'>check_with</span> <span class='assign token'>=</span> <span class='rubyid_previous_slug identifier id'>previous_slug</span>
  <span class='rubyid_else else kw'>else</span>
    <span class='rubyid_check_on identifier id'>check_on</span> <span class='assign token'>=</span> <span class='rubyid_previous_slug identifier id'>previous_slug</span>
    <span class='rubyid_check_with identifier id'>check_with</span> <span class='assign token'>=</span> <span class='rubyid_slug identifier id'>slug</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_slug_difference identifier id'>slug_difference</span> <span class='assign token'>=</span> <span class='rubyid_check_on identifier id'>check_on</span><span class='dot token'>.</span><span class='rubyid_gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='dregexp node'>/^#{check_with}/</span><span class='comma token'>,</span> <span class='string val'>&quot;&quot;</span><span class='rparen token'>)</span>
                            <span class='dot token'>.</span><span class='rubyid_gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='regexp val'>/_\d+$/</span><span class='comma token'>,</span> <span class='string val'>&quot;&quot;</span><span class='rparen token'>)</span>

  <span class='comment val'># the base slug has changed if there is something left over in slug_difference</span>
  <span class='rubyid_return return kw'>return</span> <span class='notop op'>!</span><span class='rubyid_slug_difference identifier id'>slug_difference</span><span class='dot token'>.</span><span class='rubyid_empty? fid id'>empty?</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="base_sluggable_class?-class_method">
  
    .<strong>base_sluggable_class?</strong>(klass)  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


158
159
160</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_eligibility.rb', line 158</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_base_sluggable_class? fid id'>base_sluggable_class?</span><span class='lparen token'>(</span><span class='rubyid_klass identifier id'>klass</span><span class='rparen token'>)</span>
  <span class='rubyid_BASE_RECORD_TYPES constant id'>BASE_RECORD_TYPES</span><span class='dot token'>.</span><span class='rubyid_include? fid id'>include?</span><span class='lparen token'>(</span><span class='rubyid_klass identifier id'>klass</span><span class='dot token'>.</span><span class='rubyid_to_s identifier id'>to_s</span><span class='rparen token'>)</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="cache-class_method">
  
    .<strong>cache</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


3
4
5</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_generate.rb', line 3</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_cache identifier id'>cache</span>
  <span class='rubyid_@@cache ivar id'>@@cache</span> <span class='opasgn op'>||=</span> <span class='rubyid_Set constant id'>Set</span><span class='dot token'>.</span><span class='rubyid_new identifier id'>new</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="cache_reset-class_method">
  
    .<strong>cache_reset</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


7
8
9</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_generate.rb', line 7</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_cache_reset identifier id'>cache_reset</span>
  <span class='rubyid_@@cache ivar id'>@@cache</span> <span class='assign token'>=</span> <span class='rubyid_Set constant id'>Set</span><span class='dot token'>.</span><span class='rubyid_new identifier id'>new</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="cache_setup-class_method">
  
    .<strong>cache_setup</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>preload manually generated slugs into the cache</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


12
13
14
15
16
17
18</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_generate.rb', line 12</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_cache_setup identifier id'>cache_setup</span>
  <span class='rubyid_slug_record_types identifier id'>slug_record_types</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_klass identifier id'>klass</span><span class='bitor op'>|</span>
    <span class='rubyid_cache identifier id'>cache</span><span class='dot token'>.</span><span class='rubyid_merge identifier id'>merge</span><span class='lparen token'>(</span>
      <span class='rubyid_klass identifier id'>klass</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='rubyid_Sequel constant id'>Sequel</span><span class='dot token'>.</span><span class='bitnot op'>~</span><span class='lparen token'>(</span><span class='label val'>slug:</span> <span class='rubyid_nil nil kw'>nil</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='label val'>is_slug_auto:</span> <span class='integer val'>0</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_select_map identifier id'>select_map</span><span class='lparen token'>(</span><span class='symbol val'>:slug</span><span class='rparen token'>)</span>
    <span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="clean_slug-class_method">
  
    .<strong>clean_slug</strong>(slug)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>remove invalid chars and truncate slug
NOTE: If changes are made here, then they should be also made in
spec_slugs_helper.rb. Also, there may need to be a new migration
if the cleaning changes need to be done on repository slugs,
eg. migration 129</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_generate.rb', line 44</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_clean_slug identifier id'>clean_slug</span><span class='lparen token'>(</span><span class='rubyid_slug identifier id'>slug</span><span class='rparen token'>)</span>

  <span class='rubyid_if if kw'>if</span> <span class='rubyid_slug identifier id'>slug</span>
    <span class='comment val'># if the slug contains two slashes (forward or backward) next to each other, completely zero it out.</span>
    <span class='comment val'># this is intended to revert an entity to use the URI if the ID or name the slug was generated from is a URI.</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='string val'>&quot;&quot;</span> <span class='rubyid_if if_mod kw'>if</span> <span class='rubyid_slug identifier id'>slug</span> <span class='match op'>=~</span> <span class='regexp val'>/\/\//</span> <span class='orop op'>||</span> <span class='rubyid_slug identifier id'>slug</span> <span class='match op'>=~</span> <span class='regexp val'>/\\/</span>

    <span class='comment val'># remove markup tags</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_slug identifier id'>slug</span><span class='dot token'>.</span><span class='rubyid_gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='regexp val'>/&lt;\/?[^&gt;]*&gt;/</span><span class='comma token'>,</span> <span class='string val'>&quot;&quot;</span><span class='rparen token'>)</span>

    <span class='comment val'># downcase everything to simplify case sensitivity issues</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_slug identifier id'>slug</span><span class='dot token'>.</span><span class='rubyid_downcase identifier id'>downcase</span>

    <span class='comment val'># replace spaces with underscores</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_slug identifier id'>slug</span><span class='dot token'>.</span><span class='rubyid_gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='string val'>&quot; &quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;_&quot;</span><span class='rparen token'>)</span>

    <span class='comment val'># remove double hypens</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_slug identifier id'>slug</span><span class='dot token'>.</span><span class='rubyid_gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='string val'>&quot;--&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;&quot;</span><span class='rparen token'>)</span>

    <span class='comment val'># remove en and em dashes</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_slug identifier id'>slug</span><span class='dot token'>.</span><span class='rubyid_gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='regexp val'>/[\u2013-\u2014]/</span><span class='comma token'>,</span> <span class='string val'>&quot;&quot;</span><span class='rparen token'>)</span>

    <span class='comment val'># remove single quotes</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_slug identifier id'>slug</span><span class='dot token'>.</span><span class='rubyid_gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='string val'>&quot;&#39;&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;&quot;</span><span class='rparen token'>)</span>

    <span class='comment val'># remove URL-reserved chars</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_slug identifier id'>slug</span><span class='dot token'>.</span><span class='rubyid_gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='regexp val'>/[&amp;;?$&lt;&gt;#%{}|\\^~\[\]`\/\*\(\)@=:+,!.]/</span><span class='comma token'>,</span> <span class='string val'>&quot;&quot;</span><span class='rparen token'>)</span>

    <span class='comment val'># enforce length limit of 50 chars</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_slug identifier id'>slug</span><span class='dot token'>.</span><span class='rubyid_slice identifier id'>slice</span><span class='lparen token'>(</span><span class='integer val'>0</span><span class='comma token'>,</span> <span class='integer val'>50</span><span class='rparen token'>)</span>

    <span class='comment val'># replace any multiple underscores with a single underscore</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_slug identifier id'>slug</span><span class='dot token'>.</span><span class='rubyid_gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='regexp val'>/_[_]+/</span><span class='comma token'>,</span> <span class='string val'>&quot;_&quot;</span><span class='rparen token'>)</span>

    <span class='comment val'># remove any leading or trailing underscores</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_slug identifier id'>slug</span><span class='dot token'>.</span><span class='rubyid_gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='regexp val'>/^_/</span><span class='comma token'>,</span> <span class='string val'>&quot;&quot;</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='regexp val'>/_$/</span><span class='comma token'>,</span> <span class='string val'>&quot;&quot;</span><span class='rparen token'>)</span>

    <span class='comment val'># if slug is numeric, add a leading &#39;__&#39;</span>
    <span class='comment val'># this is necessary, because numerical slugs will be interpreted as an id by the controller</span>
    <span class='rubyid_if if kw'>if</span> <span class='rubyid_slug identifier id'>slug</span><span class='dot token'>.</span><span class='rubyid_match identifier id'>match</span><span class='lparen token'>(</span><span class='regexp val'>/^(\d)+$/</span><span class='rparen token'>)</span>
      <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_slug identifier id'>slug</span><span class='dot token'>.</span><span class='rubyid_prepend identifier id'>prepend</span><span class='lparen token'>(</span><span class='string val'>&quot;__&quot;</span><span class='rparen token'>)</span>
    <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_else else kw'>else</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='string val'>&quot;&quot;</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_return return kw'>return</span> <span class='rubyid_slug identifier id'>slug</span><span class='dot token'>.</span><span class='rubyid_parameterize identifier id'>parameterize</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="dedupe_slug-class_method">
  
    .<strong>dedupe_slug</strong>(dupe_slug, count)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>dupe_slug is already in use.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


160
161
162
163
164
165
166
167
168
169</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_generate.rb', line 160</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_dedupe_slug identifier id'>dedupe_slug</span><span class='lparen token'>(</span><span class='rubyid_dupe_slug identifier id'>dupe_slug</span><span class='comma token'>,</span> <span class='rubyid_count identifier id'>count</span><span class='rparen token'>)</span>

  <span class='rubyid_new_slug identifier id'>new_slug</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;#{dupe_slug}_#{count}&quot;</span>
  <span class='rubyid_loop identifier id'>loop</span> <span class='rubyid_do do kw'>do</span>
    <span class='rubyid_break break kw'>break</span> <span class='rubyid_unless unless_mod kw'>unless</span> <span class='rubyid_slug_in_use? fid id'>slug_in_use?</span><span class='lparen token'>(</span><span class='rubyid_new_slug identifier id'>new_slug</span><span class='rparen token'>)</span>
    <span class='rubyid_new_slug identifier id'>new_slug</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;#{dupe_slug}_#{count += 1}&quot;</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_new_slug identifier id'>new_slug</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="generate_slug_for_agent_name!-class_method">
  
    .<strong>generate_slug_for_agent_name!</strong>(entity)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>auto generate a slug for the Agent associated with this AgentName
Then, find that associated Agent and update it’s slug.
if for any reason we generate an empty slug, then turn autogen off for the agent.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


6
7
8
9</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_generate_by_name.rb', line 6</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_generate_slug_for_agent_name! fid id'>generate_slug_for_agent_name!</span><span class='lparen token'>(</span><span class='rubyid_entity identifier id'>entity</span><span class='rparen token'>)</span>
  <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_name_based_slug_for identifier id'>name_based_slug_for</span><span class='lparen token'>(</span><span class='rubyid_entity identifier id'>entity</span><span class='comma token'>,</span> <span class='rubyid_entity identifier id'>entity</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='rparen token'>)</span>
  <span class='rubyid_update_agent_slug_from_name identifier id'>update_agent_slug_from_name</span><span class='lparen token'>(</span><span class='rubyid_entity identifier id'>entity</span><span class='comma token'>,</span> <span class='rubyid_slug identifier id'>slug</span><span class='rparen token'>)</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_id_from_slug-class_method">
  
    .<strong>get_id_from_slug</strong>(slug, controller, action)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Find the record given the slug, return id, repo_id, and table name.
This is a gnarly descision tree because the query we’ll run depends on which
controller is asking, and whether we’re scoping by repo slug or not.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers.rb', line 12</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_get_id_from_slug identifier id'>get_id_from_slug</span><span class='lparen token'>(</span><span class='rubyid_slug identifier id'>slug</span><span class='comma token'>,</span> <span class='rubyid_controller identifier id'>controller</span><span class='comma token'>,</span> <span class='rubyid_action identifier id'>action</span><span class='rparen token'>)</span>
  <span class='rubyid_if if kw'>if</span> <span class='rubyid_controller identifier id'>controller</span> <span class='eq op'>==</span> <span class='string val'>&quot;repositories&quot;</span>
    <span class='rubyid_rec identifier id'>rec</span> <span class='assign token'>=</span> <span class='rubyid_Repository constant id'>Repository</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='symbol val'>:slug</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_slug identifier id'>slug</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_first identifier id'>first</span>
    <span class='rubyid_table identifier id'>table</span> <span class='assign token'>=</span> <span class='string val'>&quot;repository&quot;</span>
  <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_controller identifier id'>controller</span> <span class='eq op'>==</span> <span class='string val'>&quot;agents&quot;</span>
    <span class='rubyid_rec identifier id'>rec</span><span class='comma token'>,</span> <span class='rubyid_table identifier id'>table</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_find_slug_in_agent_tables identifier id'>find_slug_in_agent_tables</span><span class='lparen token'>(</span><span class='rubyid_slug identifier id'>slug</span><span class='rparen token'>)</span>
  <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_controller identifier id'>controller</span> <span class='eq op'>==</span> <span class='string val'>&quot;subjects&quot;</span>
    <span class='rubyid_rec identifier id'>rec</span> <span class='assign token'>=</span> <span class='rubyid_Subject constant id'>Subject</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='symbol val'>:slug</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_slug identifier id'>slug</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_first identifier id'>first</span>
    <span class='rubyid_table identifier id'>table</span> <span class='assign token'>=</span> <span class='string val'>&quot;subject&quot;</span>
  <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_controller identifier id'>controller</span> <span class='eq op'>==</span> <span class='string val'>&quot;objects&quot;</span>
    <span class='rubyid_rec identifier id'>rec</span><span class='comma token'>,</span> <span class='rubyid_table identifier id'>table</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_find_slug_in_object_tables_any_repo identifier id'>find_slug_in_object_tables_any_repo</span><span class='lparen token'>(</span><span class='rubyid_slug identifier id'>slug</span><span class='rparen token'>)</span>
  <span class='rubyid_else else kw'>else</span>
    <span class='rubyid_rec identifier id'>rec</span><span class='comma token'>,</span> <span class='rubyid_table identifier id'>table</span> <span class='assign token'>=</span> <span class='rubyid_find_any_repo identifier id'>find_any_repo</span><span class='lparen token'>(</span><span class='rubyid_slug identifier id'>slug</span><span class='comma token'>,</span> <span class='rubyid_controller identifier id'>controller</span><span class='comma token'>,</span> <span class='rubyid_action identifier id'>action</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_if if kw'>if</span> <span class='rubyid_rec identifier id'>rec</span>
    <span class='rubyid_return return kw'>return</span> <span class='lbrack token'>[</span><span class='rubyid_rec identifier id'>rec</span><span class='lbrack token'>[</span><span class='symbol val'>:id</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='rubyid_table identifier id'>table</span><span class='comma token'>,</span> <span class='rubyid_rec identifier id'>rec</span><span class='lbrack token'>[</span><span class='symbol val'>:repo_id</span><span class='rbrack token'>]</span><span class='rbrack token'>]</span>
  <span class='comment val'># Always return -1 if we can&#39;t find that slug</span>
  <span class='rubyid_else else kw'>else</span>
    <span class='rubyid_return return kw'>return</span> <span class='lbrack token'>[</span><span class='integer val'>-1</span><span class='comma token'>,</span> <span class='rubyid_table identifier id'>table</span><span class='comma token'>,</span> <span class='integer val'>-1</span><span class='rbrack token'>]</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_slugged_url_for_largetree-class_method">
  
    .<strong>get_slugged_url_for_largetree</strong>(jsonmodel_type, repo_id, slug)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Generates URLs for display in hirearchial tree links in public interface for Archival Objects and Digital object components</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers.rb', line 37</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_get_slugged_url_for_largetree identifier id'>get_slugged_url_for_largetree</span><span class='lparen token'>(</span><span class='rubyid_jsonmodel_type identifier id'>jsonmodel_type</span><span class='comma token'>,</span> <span class='rubyid_repo_id identifier id'>repo_id</span><span class='comma token'>,</span> <span class='rubyid_slug identifier id'>slug</span><span class='rparen token'>)</span>
  <span class='rubyid_if if kw'>if</span> <span class='rubyid_slug identifier id'>slug</span> <span class='andop op'>&amp;&amp;</span> <span class='rubyid_AppConfig constant id'>AppConfig</span><span class='lbrack token'>[</span><span class='symbol val'>:use_human_readable_urls</span><span class='rbrack token'>]</span>
    <span class='rubyid_if if kw'>if</span> <span class='rubyid_AppConfig constant id'>AppConfig</span><span class='lbrack token'>[</span><span class='symbol val'>:repo_name_in_slugs</span><span class='rbrack token'>]</span>
      <span class='rubyid_repo identifier id'>repo</span> <span class='assign token'>=</span> <span class='rubyid_Repository constant id'>Repository</span><span class='dot token'>.</span><span class='rubyid_first identifier id'>first</span><span class='lparen token'>(</span><span class='symbol val'>:id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_repo_id identifier id'>repo_id</span><span class='rparen token'>)</span>
      <span class='rubyid_repo_slug identifier id'>repo_slug</span> <span class='assign token'>=</span> <span class='rubyid_repo identifier id'>repo</span> <span class='andop op'>&amp;&amp;</span> <span class='rubyid_repo identifier id'>repo</span><span class='dot token'>.</span><span class='rubyid_slug identifier id'>slug</span> <span class='integer val'>? </span><span class='rubyid_repo identifier id'>repo</span><span class='dot token'>.</span><span class='rubyid_slug identifier id'>slug</span> <span class='colon op'>:</span> <span class='string val'>&quot;&quot;</span>

      <span class='rubyid_if if kw'>if</span> <span class='rubyid_repo_slug identifier id'>repo_slug</span><span class='dot token'>.</span><span class='rubyid_empty? fid id'>empty?</span>
        <span class='rubyid_return return kw'>return</span> <span class='dstring node'>&quot;#{AppConfig[:public_proxy_url]}/#{jsonmodel_type.underscore}s/#{slug}&quot;</span>
      <span class='rubyid_else else kw'>else</span>
        <span class='rubyid_return return kw'>return</span> <span class='dstring node'>&quot;#{AppConfig[:public_proxy_url]}/repositories/#{repo_slug}/#{jsonmodel_type.underscore}s/#{slug}&quot;</span>
      <span class='rubyid_end end kw'>end</span>
    <span class='rubyid_else else kw'>else</span>
      <span class='rubyid_return return kw'>return</span> <span class='dstring node'>&quot;#{AppConfig[:public_proxy_url]}/#{jsonmodel_type.underscore}s/#{slug}&quot;</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_else else kw'>else</span>
    <span class='rubyid_return return kw'>return</span> <span class='string val'>&quot;&quot;</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="id_based_slug_for-class_method">
  
    .<strong>id_based_slug_for</strong>(entity, klass)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>generate and return a string for a slug based on this thing’s ID.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_generate_by_id.rb', line 3</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_id_based_slug_for identifier id'>id_based_slug_for</span><span class='lparen token'>(</span><span class='rubyid_entity identifier id'>entity</span><span class='comma token'>,</span> <span class='rubyid_klass identifier id'>klass</span><span class='rparen token'>)</span>

  <span class='rubyid_if if kw'>if</span> <span class='rubyid_klass identifier id'>klass</span> <span class='eq op'>==</span> <span class='rubyid_Resource constant id'>Resource</span> <span class='orop op'>||</span> <span class='rubyid_klass identifier id'>klass</span> <span class='eq op'>==</span> <span class='rubyid_Accession constant id'>Accession</span>
    <span class='rubyid_if if kw'>if</span> <span class='rubyid_AppConfig constant id'>AppConfig</span><span class='lbrack token'>[</span><span class='symbol val'>:generate_resource_slugs_with_eadid</span><span class='rbrack token'>]</span> <span class='andop op'>&amp;&amp;</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:ead_id</span><span class='rbrack token'>]</span> <span class='andop op'>&amp;&amp;</span> <span class='rubyid_klass identifier id'>klass</span> <span class='eq op'>==</span> <span class='rubyid_Resource constant id'>Resource</span>
      <span class='comment val'># use EADID if configured. Otherwise, use identifier.</span>
      <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:ead_id</span><span class='rbrack token'>]</span>
    <span class='rubyid_else else kw'>else</span>
      <span class='rubyid_if if kw'>if</span> <span class='rubyid_entity identifier id'>entity</span><span class='dot token'>.</span><span class='rubyid_respond_to? fid id'>respond_to?</span><span class='lparen token'>(</span><span class='symbol val'>:format_multipart_identifier</span><span class='rparen token'>)</span>
        <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_entity identifier id'>entity</span><span class='dot token'>.</span><span class='rubyid_format_multipart_identifier identifier id'>format_multipart_identifier</span>
      <span class='rubyid_else else kw'>else</span>
        <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;#{entity[:id_0]}&quot;</span>
        <span class='rubyid_slug identifier id'>slug</span> <span class='opasgn op'>+=</span> <span class='dstring node'>&quot;-#{entity[:id_1]}&quot;</span> <span class='rubyid_if if_mod kw'>if</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:id_1</span><span class='rbrack token'>]</span>
        <span class='rubyid_slug identifier id'>slug</span> <span class='opasgn op'>+=</span> <span class='dstring node'>&quot;-#{entity[:id_2]}&quot;</span> <span class='rubyid_if if_mod kw'>if</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:id_2</span><span class='rbrack token'>]</span>
        <span class='rubyid_slug identifier id'>slug</span> <span class='opasgn op'>+=</span> <span class='dstring node'>&quot;-#{entity[:id_3]}&quot;</span> <span class='rubyid_if if_mod kw'>if</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:id_3</span><span class='rbrack token'>]</span>
      <span class='rubyid_end end kw'>end</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_klass identifier id'>klass</span> <span class='eq op'>==</span> <span class='rubyid_Classification constant id'>Classification</span> <span class='orop op'>||</span> <span class='rubyid_klass identifier id'>klass</span> <span class='eq op'>==</span> <span class='rubyid_ClassificationTerm constant id'>ClassificationTerm</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:identifier</span><span class='rbrack token'>]</span>
  <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_klass identifier id'>klass</span> <span class='eq op'>==</span> <span class='rubyid_DigitalObject constant id'>DigitalObject</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:digital_object_id</span><span class='rbrack token'>]</span>
  <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_klass identifier id'>klass</span> <span class='eq op'>==</span> <span class='rubyid_Repository constant id'>Repository</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:repo_code</span><span class='rbrack token'>]</span>
  <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_klass identifier id'>klass</span> <span class='eq op'>==</span> <span class='rubyid_ArchivalObject constant id'>ArchivalObject</span>
    <span class='rubyid_if if kw'>if</span> <span class='rubyid_AppConfig constant id'>AppConfig</span><span class='lbrack token'>[</span><span class='symbol val'>:generate_archival_object_slugs_with_cuid</span><span class='rbrack token'>]</span>
      <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:component_id</span><span class='rbrack token'>]</span>
    <span class='rubyid_else else kw'>else</span>
      <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:ref_id</span><span class='rbrack token'>]</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_klass identifier id'>klass</span> <span class='eq op'>==</span> <span class='rubyid_DigitalObjectComponent constant id'>DigitalObjectComponent</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:component_id</span><span class='rbrack token'>]</span>
  <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_klass identifier id'>klass</span> <span class='eq op'>==</span> <span class='rubyid_Subject constant id'>Subject</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:authority_id</span><span class='rbrack token'>]</span>
  <span class='comment val'>#turned autogen on without updating any other data</span>
  <span class='comment val'>#should be JSON only</span>
  <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_is_agent_type? fid id'>is_agent_type?</span><span class='lparen token'>(</span><span class='rubyid_klass identifier id'>klass</span><span class='rparen token'>)</span>
    <span class='rubyid_if if kw'>if</span> <span class='rubyid_entity identifier id'>entity</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_to_s identifier id'>to_s</span> <span class='match op'>=~</span> <span class='regexp val'>/JSONModel/</span>
      <span class='rubyid_primary_name identifier id'>primary_name</span> <span class='assign token'>=</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='string val'>&quot;names&quot;</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_select identifier id'>select</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='rubyid_n identifier id'>n</span><span class='bitor op'>|</span> <span class='rubyid_n identifier id'>n</span><span class='lbrack token'>[</span><span class='string val'>&quot;is_display_name&quot;</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='rubyid_true true kw'>true</span> <span class='rbrace token'>}</span>
      <span class='comment val'># we should have a single primary name.</span>
      <span class='comment val'># if we don&#39;t, then someentity&#39;s wrong and use the first name as a fallback.</span>
      <span class='rubyid_if if kw'>if</span> <span class='rubyid_primary_name identifier id'>primary_name</span><span class='dot token'>.</span><span class='rubyid_length identifier id'>length</span> <span class='eq op'>==</span> <span class='integer val'>1</span>
        <span class='rubyid_primary_name identifier id'>primary_name</span> <span class='assign token'>=</span> <span class='rubyid_primary_name identifier id'>primary_name</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span>
      <span class='rubyid_else else kw'>else</span>
        <span class='rubyid_primary_name identifier id'>primary_name</span> <span class='assign token'>=</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='string val'>&quot;names&quot;</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span>
      <span class='rubyid_end end kw'>end</span>
      <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_primary_name identifier id'>primary_name</span><span class='lbrack token'>[</span><span class='string val'>&quot;authority_id&quot;</span><span class='rbrack token'>]</span>
    <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_is_agent_type? fid id'>is_agent_type?</span><span class='lparen token'>(</span><span class='rubyid_entity identifier id'>entity</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='rparen token'>)</span>
      <span class='rubyid_disp_name identifier id'>disp_name</span> <span class='assign token'>=</span> <span class='rubyid_get_json_for_agent identifier id'>get_json_for_agent</span><span class='lparen token'>(</span><span class='rubyid_entity identifier id'>entity</span><span class='comma token'>,</span> <span class='rubyid_klass identifier id'>klass</span><span class='rparen token'>)</span>
      <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_disp_name identifier id'>disp_name</span><span class='lbrack token'>[</span><span class='string val'>&quot;authority_id&quot;</span><span class='rbrack token'>]</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_else else kw'>else</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='string val'>&quot;&quot;</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_clean_slug identifier id'>clean_slug</span><span class='lparen token'>(</span><span class='rubyid_slug identifier id'>slug</span><span class='rparen token'>)</span>

  <span class='comment val'># only de-dupe and update if our base slug has changed from it&#39;s previous value</span>
  <span class='rubyid_previous_slug identifier id'>previous_slug</span> <span class='assign token'>=</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:slug</span><span class='rbrack token'>]</span>
  <span class='rubyid_if if kw'>if</span> <span class='rubyid_base_slug_changed? fid id'>base_slug_changed?</span><span class='lparen token'>(</span><span class='rubyid_slug identifier id'>slug</span><span class='comma token'>,</span> <span class='rubyid_previous_slug identifier id'>previous_slug</span><span class='rparen token'>)</span>
    <span class='rubyid_return return kw'>return</span> <span class='rubyid_run_dedupe_slug identifier id'>run_dedupe_slug</span><span class='lparen token'>(</span><span class='rubyid_slug identifier id'>slug</span><span class='rparen token'>)</span>
  <span class='rubyid_else else kw'>else</span>
    <span class='rubyid_return return kw'>return</span> <span class='rubyid_previous_slug identifier id'>previous_slug</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="is_agent_name_type?-class_method">
  
    .<strong>is_agent_name_type?</strong>(klass)  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


150
151
152</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_eligibility.rb', line 150</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_is_agent_name_type? fid id'>is_agent_name_type?</span><span class='lparen token'>(</span><span class='rubyid_klass identifier id'>klass</span><span class='rparen token'>)</span>
  <span class='rubyid_NAME_RECORD_TYPES constant id'>NAME_RECORD_TYPES</span><span class='dot token'>.</span><span class='rubyid_include? fid id'>include?</span><span class='lparen token'>(</span><span class='rubyid_klass identifier id'>klass</span><span class='dot token'>.</span><span class='rubyid_to_s identifier id'>to_s</span><span class='rparen token'>)</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="is_agent_type?-class_method">
  
    .<strong>is_agent_type?</strong>(klass)  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


154
155
156</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_eligibility.rb', line 154</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_is_agent_type? fid id'>is_agent_type?</span><span class='lparen token'>(</span><span class='rubyid_klass identifier id'>klass</span><span class='rparen token'>)</span>
  <span class='rubyid_AGENT_RECORD_TYPES constant id'>AGENT_RECORD_TYPES</span><span class='dot token'>.</span><span class='rubyid_include? fid id'>include?</span><span class='lparen token'>(</span><span class='rubyid_klass identifier id'>klass</span><span class='dot token'>.</span><span class='rubyid_to_s identifier id'>to_s</span><span class='rparen token'>)</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="is_slug_auto_enabled?-class_method">
  
    .<strong>is_slug_auto_enabled?</strong>(entity)  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>returns true if is_slug_auto is enabled for entity, or if we should treat it like it is</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


136
137
138
139
140
141
142
143
144
145
146
147
148</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_eligibility.rb', line 136</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_is_slug_auto_enabled? fid id'>is_slug_auto_enabled?</span><span class='lparen token'>(</span><span class='rubyid_entity identifier id'>entity</span><span class='rparen token'>)</span>
  <span class='rubyid_enabled identifier id'>enabled</span> <span class='assign token'>=</span> <span class='rubyid_false false kw'>false</span>

  <span class='rubyid_if if kw'>if</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:is_slug_auto</span><span class='rbrack token'>]</span> <span class='andop op'>&amp;&amp;</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:is_slug_auto</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='integer val'>1</span>
    <span class='rubyid_enabled identifier id'>enabled</span> <span class='assign token'>=</span> <span class='rubyid_true true kw'>true</span>

  <span class='comment val'># the agent Name classes don&#39;t have slug fields, but if they are being updated, we may need to update the associated agent.</span>
  <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_is_agent_name_type? fid id'>is_agent_name_type?</span><span class='lparen token'>(</span><span class='rubyid_entity identifier id'>entity</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='rparen token'>)</span>
    <span class='rubyid_enabled identifier id'>enabled</span> <span class='assign token'>=</span> <span class='rubyid_true true kw'>true</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_return return kw'>return</span> <span class='rubyid_enabled identifier id'>enabled</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="job_running-class_method">
  
    .<strong>job_running</strong>(status: false)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


20
21
22
23</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_generate.rb', line 20</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_job_running identifier id'>job_running</span><span class='lparen token'>(</span><span class='label val'>status:</span> <span class='rubyid_false false kw'>false</span><span class='rparen token'>)</span>
  <span class='rubyid_status identifier id'>status</span> <span class='eq op'>==</span> <span class='rubyid_true true kw'>true</span> <span class='question op'>?</span> <span class='rubyid_cache_setup identifier id'>cache_setup</span> <span class='colon op'>:</span> <span class='rubyid_cache_reset identifier id'>cache_reset</span>
  <span class='rubyid_@@running ivar id'>@@running</span> <span class='assign token'>=</span> <span class='rubyid_status identifier id'>status</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="job_running?-class_method">
  
    .<strong>job_running?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


25
26
27</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_generate.rb', line 25</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_job_running? fid id'>job_running?</span>
  <span class='rubyid_@@running ivar id'>@@running</span> <span class='opasgn op'>||=</span> <span class='rubyid_false false kw'>false</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="name_based_slug_for-class_method">
  
    .<strong>name_based_slug_for</strong>(entity, klass)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Generate and return a string for a slug based on this thing’s title or name.
unlike #generate_slug_by_name!, this method does not modify the passed in object.
NOTE: ‘klass’ is passed in by the caller to give us a clue as to what kind of entity we’re working with.
‘entity’ is a data structure that has what we need. It may be a JSONModel or a Sequel object.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_generate_by_name.rb', line 17</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_name_based_slug_for identifier id'>name_based_slug_for</span><span class='lparen token'>(</span><span class='rubyid_entity identifier id'>entity</span><span class='comma token'>,</span> <span class='rubyid_klass identifier id'>klass</span><span class='rparen token'>)</span>
  <span class='rubyid_if if kw'>if</span> <span class='rubyid_klass identifier id'>klass</span> <span class='eq op'>==</span> <span class='rubyid_Repository constant id'>Repository</span>
    <span class='comment val'># Always use repo_code for repository slug</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:repo_code</span><span class='rbrack token'>]</span>
  <span class='rubyid_elsif elsif kw'>elsif</span> <span class='notop op'>!</span><span class='rubyid_is_agent_name_type? fid id'>is_agent_name_type?</span><span class='lparen token'>(</span><span class='rubyid_klass identifier id'>klass</span><span class='rparen token'>)</span>
    <span class='rubyid_if if kw'>if</span> <span class='notop op'>!</span><span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:title</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span> <span class='andop op'>&amp;&amp;</span> <span class='notop op'>!</span><span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:title</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_empty? fid id'>empty?</span>
      <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:title</span><span class='rbrack token'>]</span>
    <span class='rubyid_elsif elsif kw'>elsif</span> <span class='notop op'>!</span><span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span> <span class='andop op'>&amp;&amp;</span> <span class='notop op'>!</span><span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_empty? fid id'>empty?</span>
      <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='comment val'># This codepath is run on updating slugs for agents, where we get either a Sequel Name object, or a Hash</span>
  <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_is_agent_name_type? fid id'>is_agent_name_type?</span><span class='lparen token'>(</span><span class='rubyid_klass identifier id'>klass</span><span class='rparen token'>)</span>
    <span class='rubyid_if if kw'>if</span> <span class='rubyid_entity identifier id'>entity</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span> <span class='eq op'>==</span> <span class='rubyid_Hash constant id'>Hash</span>
      <span class='comment val'># turn keys into symbols, that&#39;s what we expect down the line</span>
      <span class='rubyid_entity identifier id'>entity</span><span class='dot token'>.</span><span class='rubyid_keys identifier id'>keys</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_key identifier id'>key</span><span class='bitor op'>|</span>
        <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='lparen token'>(</span><span class='rubyid_key identifier id'>key</span><span class='dot token'>.</span><span class='rubyid_to_sym identifier id'>to_sym</span> <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_key identifier id'>key</span><span class='rparen token'>)</span> <span class='orop op'>||</span> <span class='rubyid_key identifier id'>key</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rubyid_entity identifier id'>entity</span><span class='dot token'>.</span><span class='rubyid_delete identifier id'>delete</span><span class='lparen token'>(</span><span class='rubyid_key identifier id'>key</span><span class='rparen token'>)</span>
      <span class='rubyid_end end kw'>end</span>
      <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_get_agent_name_string_from_hash identifier id'>get_agent_name_string_from_hash</span><span class='lparen token'>(</span><span class='rubyid_entity identifier id'>entity</span><span class='comma token'>,</span> <span class='rubyid_klass identifier id'>klass</span><span class='rparen token'>)</span>
    <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_is_agent_name_type? fid id'>is_agent_name_type?</span><span class='lparen token'>(</span><span class='rubyid_entity identifier id'>entity</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='rparen token'>)</span>
      <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_get_agent_name_string_from_sequel identifier id'>get_agent_name_string_from_sequel</span><span class='lparen token'>(</span><span class='rubyid_entity identifier id'>entity</span><span class='comma token'>,</span> <span class='rubyid_klass identifier id'>klass</span><span class='rparen token'>)</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_else else kw'>else</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='string val'>&quot;&quot;</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_clean_slug identifier id'>clean_slug</span><span class='lparen token'>(</span><span class='rubyid_slug identifier id'>slug</span><span class='rparen token'>)</span>

  <span class='comment val'># only de-dupe and update if our base slug has changed from it&#39;s previous value</span>
  <span class='rubyid_previous_slug identifier id'>previous_slug</span> <span class='assign token'>=</span> <span class='rubyid_entity identifier id'>entity</span><span class='lbrack token'>[</span><span class='symbol val'>:slug</span><span class='rbrack token'>]</span>
  <span class='rubyid_if if kw'>if</span> <span class='rubyid_base_slug_changed? fid id'>base_slug_changed?</span><span class='lparen token'>(</span><span class='rubyid_slug identifier id'>slug</span><span class='comma token'>,</span> <span class='rubyid_previous_slug identifier id'>previous_slug</span><span class='rparen token'>)</span>
    <span class='rubyid_return return kw'>return</span> <span class='rubyid_run_dedupe_slug identifier id'>run_dedupe_slug</span><span class='lparen token'>(</span><span class='rubyid_slug identifier id'>slug</span><span class='rparen token'>)</span>
  <span class='rubyid_else else kw'>else</span>
    <span class='rubyid_return return kw'>return</span> <span class='rubyid_previous_slug identifier id'>previous_slug</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="reset_autogenerated_slugs-class_method">
  
    .<strong>reset_autogenerated_slugs</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>for the generate_slugs_runner job:
clear out previously autogenerated slugs so we don’t have to lookup if
generated slugs are in use from before this job was run
(cache_setup preloads manually created slugs)</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


33
34
35
36
37</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_generate.rb', line 33</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_reset_autogenerated_slugs identifier id'>reset_autogenerated_slugs</span>
  <span class='rubyid_slug_record_types identifier id'>slug_record_types</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_klass identifier id'>klass</span><span class='bitor op'>|</span>
    <span class='rubyid_klass identifier id'>klass</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='rubyid_Sequel constant id'>Sequel</span><span class='dot token'>.</span><span class='bitnot op'>~</span><span class='lparen token'>(</span><span class='label val'>slug:</span> <span class='rubyid_nil nil kw'>nil</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='label val'>is_slug_auto:</span> <span class='integer val'>1</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_update identifier id'>update</span><span class='lparen token'>(</span><span class='label val'>slug:</span> <span class='rubyid_nil nil kw'>nil</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="run_dedupe_slug-class_method">
  
    .<strong>run_dedupe_slug</strong>(slug)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>runs dedupe if necessary</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


95
96
97
98
99
100
101
102
103
104
105
106</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_generate.rb', line 95</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_run_dedupe_slug identifier id'>run_dedupe_slug</span><span class='lparen token'>(</span><span class='rubyid_slug identifier id'>slug</span><span class='rparen token'>)</span>

  <span class='comment val'># search for dupes</span>
  <span class='rubyid_if if kw'>if</span> <span class='notop op'>!</span><span class='rubyid_slug identifier id'>slug</span><span class='dot token'>.</span><span class='rubyid_empty? fid id'>empty?</span> <span class='andop op'>&amp;&amp;</span> <span class='rubyid_slug_in_use? fid id'>slug_in_use?</span><span class='lparen token'>(</span><span class='rubyid_slug identifier id'>slug</span><span class='rparen token'>)</span>
    <span class='rubyid_slug identifier id'>slug</span> <span class='assign token'>=</span> <span class='rubyid_dedupe_slug identifier id'>dedupe_slug</span><span class='lparen token'>(</span><span class='rubyid_slug identifier id'>slug</span><span class='comma token'>,</span> <span class='integer val'>1</span><span class='rparen token'>)</span>
  <span class='rubyid_else else kw'>else</span>
    <span class='rubyid_slug identifier id'>slug</span>
  <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_cache identifier id'>cache</span> <span class='lshft op'>&lt;&lt;</span> <span class='rubyid_slug identifier id'>slug</span> <span class='rubyid_if if_mod kw'>if</span> <span class='rubyid_job_running? fid id'>job_running?</span>

  <span class='rubyid_slug identifier id'>slug</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="slug_data_updated?-class_method">
  
    .<strong>slug_data_updated?</strong>(obj)  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Determine if our record has updated a data field that indicates an autogenerated slug should be updated.
Generally, we’ll always want to return true here and run the slug code if the record is brand new (hasn’t been persisted)
slug will be updated iff this method returns true</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_eligibility.rb', line 35</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_slug_data_updated? fid id'>slug_data_updated?</span><span class='lparen token'>(</span><span class='rubyid_obj identifier id'>obj</span><span class='rparen token'>)</span>

  <span class='rubyid_id_field_changed identifier id'>id_field_changed</span>   <span class='assign token'>=</span> <span class='rubyid_false false kw'>false</span>
  <span class='rubyid_name_field_changed identifier id'>name_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_false false kw'>false</span>
  <span class='rubyid_persisted identifier id'>persisted</span>          <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_exists? fid id'>exists?</span>

  <span class='rubyid_slug_field_changed identifier id'>slug_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:slug</span><span class='rparen token'>)</span>
  <span class='rubyid_slug_auto_field_changed identifier id'>slug_auto_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:is_slug_auto</span><span class='rparen token'>)</span>

  <span class='rubyid_updated identifier id'>updated</span> <span class='assign token'>=</span> <span class='rubyid_false false kw'>false</span>

  <span class='rubyid_case case kw'>case</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_to_s identifier id'>to_s</span>
  <span class='rubyid_when when kw'>when</span> <span class='string val'>&quot;Resource&quot;</span>
    <span class='rubyid_if if kw'>if</span> <span class='rubyid_AppConfig constant id'>AppConfig</span><span class='lbrack token'>[</span><span class='symbol val'>:generate_resource_slugs_with_eadid</span><span class='rbrack token'>]</span>
      <span class='rubyid_id_field_changed identifier id'>id_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:ead_id</span><span class='rparen token'>)</span>     <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>
    <span class='rubyid_else else kw'>else</span>
      <span class='rubyid_id_field_changed identifier id'>id_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:identifier</span><span class='rparen token'>)</span> <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>
    <span class='rubyid_end end kw'>end</span>

    <span class='rubyid_name_field_changed identifier id'>name_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:title</span><span class='rparen token'>)</span> <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>

  <span class='rubyid_when when kw'>when</span> <span class='string val'>&quot;Accession&quot;</span>
    <span class='rubyid_id_field_changed identifier id'>id_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:identifier</span><span class='rparen token'>)</span> <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>
    <span class='rubyid_name_field_changed identifier id'>name_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:title</span><span class='rparen token'>)</span>    <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>

  <span class='rubyid_when when kw'>when</span> <span class='string val'>&quot;DigitalObject&quot;</span>
    <span class='rubyid_id_field_changed identifier id'>id_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:digital_object_id</span><span class='rparen token'>)</span> <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>
    <span class='rubyid_name_field_changed identifier id'>name_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:title</span><span class='rparen token'>)</span>           <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>

  <span class='rubyid_when when kw'>when</span> <span class='string val'>&quot;DigitalObjectComponent&quot;</span>
    <span class='rubyid_id_field_changed identifier id'>id_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:component_id</span><span class='rparen token'>)</span> <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>
    <span class='rubyid_name_field_changed identifier id'>name_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:title</span><span class='rparen token'>)</span>      <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>

  <span class='rubyid_when when kw'>when</span> <span class='string val'>&quot;Classification&quot;</span>
    <span class='rubyid_id_field_changed identifier id'>id_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:identifier</span><span class='rparen token'>)</span> <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>
    <span class='rubyid_name_field_changed identifier id'>name_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:title</span><span class='rparen token'>)</span>    <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>

  <span class='rubyid_when when kw'>when</span> <span class='string val'>&quot;ClassificationTerm&quot;</span>
    <span class='rubyid_id_field_changed identifier id'>id_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:identifier</span><span class='rparen token'>)</span> <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>
    <span class='rubyid_name_field_changed identifier id'>name_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:title</span><span class='rparen token'>)</span>    <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>

  <span class='rubyid_when when kw'>when</span> <span class='string val'>&quot;Repository&quot;</span>
    <span class='rubyid_id_field_changed identifier id'>id_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:repo_code</span><span class='rparen token'>)</span> <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>
    <span class='rubyid_name_field_changed identifier id'>name_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:name</span><span class='rparen token'>)</span>    <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>

  <span class='rubyid_when when kw'>when</span> <span class='string val'>&quot;ArchivalObject&quot;</span>
    <span class='rubyid_if if kw'>if</span> <span class='rubyid_AppConfig constant id'>AppConfig</span><span class='lbrack token'>[</span><span class='symbol val'>:generate_archival_object_slugs_with_cuid</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rubyid_true true kw'>true</span>
      <span class='rubyid_id_field_changed identifier id'>id_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:component_id</span><span class='rparen token'>)</span> <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>
    <span class='rubyid_else else kw'>else</span>
      <span class='rubyid_id_field_changed identifier id'>id_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:ref_id</span><span class='rparen token'>)</span> <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>
    <span class='rubyid_end end kw'>end</span>

    <span class='rubyid_name_field_changed identifier id'>name_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:title</span><span class='rparen token'>)</span> <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>

  <span class='rubyid_when when kw'>when</span> <span class='string val'>&quot;Subject&quot;</span>
    <span class='rubyid_id_field_changed identifier id'>id_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:authority_id</span><span class='rparen token'>)</span>   <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>
    <span class='rubyid_name_field_changed identifier id'>name_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_column_changed? fid id'>column_changed?</span><span class='lparen token'>(</span><span class='symbol val'>:title</span><span class='rparen token'>)</span> <span class='orop op'>||</span> <span class='notop op'>!</span><span class='rubyid_persisted identifier id'>persisted</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='comment val'># for agent objects, the fields we need for name slugs are in a different table.</span>
  <span class='comment val'># since we don&#39;t have access to that object here, we&#39;ll always process slugs for agents.</span>
  <span class='comment val'># We only want to update the name agent classes if they exist already and have an ID. (persisted) This is because on create, the auto_generate hook on the Agent model creates a slug and we don&#39;t want a duplicate.</span>

  <span class='comment val'># The only time we want to run slug code for agent classes is when the is_slug_auto flag is toggled</span>
  <span class='rubyid_if if kw'>if</span> <span class='rubyid_is_agent_type? fid id'>is_agent_type?</span><span class='lparen token'>(</span><span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='rparen token'>)</span>
    <span class='rubyid_id_field_changed identifier id'>id_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_false false kw'>false</span>
    <span class='rubyid_name_field_changed identifier id'>name_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_false false kw'>false</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='comment val'># only run slug code for this AgentName if it&#39;s a display name</span>
  <span class='rubyid_if if kw'>if</span> <span class='rubyid_is_agent_name_type? fid id'>is_agent_name_type?</span><span class='lparen token'>(</span><span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='rparen token'>)</span>
    <span class='rubyid_id_field_changed identifier id'>id_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_false false kw'>false</span>
    <span class='rubyid_name_field_changed identifier id'>name_field_changed</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='lbrack token'>[</span><span class='symbol val'>:is_display_name</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='integer val'>1</span>
  <span class='rubyid_end end kw'>end</span>


  <span class='comment val'># auto-gen slugs has been switched from OFF to ON</span>
  <span class='rubyid_if if kw'>if</span> <span class='rubyid_slug_auto_field_changed identifier id'>slug_auto_field_changed</span> <span class='andop op'>&amp;&amp;</span> <span class='rubyid_obj identifier id'>obj</span><span class='lbrack token'>[</span><span class='symbol val'>:is_slug_auto</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='integer val'>1</span>
    <span class='rubyid_updated identifier id'>updated</span> <span class='assign token'>=</span> <span class='rubyid_true true kw'>true</span>

  <span class='comment val'># auto-gen slugs is OFF, and slug field updated</span>
  <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_obj identifier id'>obj</span><span class='lbrack token'>[</span><span class='symbol val'>:is_slug_auto</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='integer val'>0</span> <span class='andop op'>&amp;&amp;</span> <span class='rubyid_slug_field_changed identifier id'>slug_field_changed</span>
    <span class='rubyid_updated identifier id'>updated</span> <span class='assign token'>=</span> <span class='rubyid_true true kw'>true</span>

  <span class='comment val'># auto-gen slugs is ON based on name, and name has changed</span>
  <span class='rubyid_elsif elsif kw'>elsif</span> <span class='notop op'>!</span><span class='rubyid_AppConfig constant id'>AppConfig</span><span class='lbrack token'>[</span><span class='symbol val'>:auto_generate_slugs_with_id</span><span class='rbrack token'>]</span> <span class='andop op'>&amp;&amp;</span> <span class='rubyid_name_field_changed identifier id'>name_field_changed</span>
    <span class='rubyid_updated identifier id'>updated</span> <span class='assign token'>=</span> <span class='rubyid_true true kw'>true</span>

  <span class='comment val'># auto-gen slugs is ON based on id, and id has changed</span>
  <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_AppConfig constant id'>AppConfig</span><span class='lbrack token'>[</span><span class='symbol val'>:auto_generate_slugs_with_id</span><span class='rbrack token'>]</span> <span class='andop op'>&amp;&amp;</span> <span class='rubyid_id_field_changed identifier id'>id_field_changed</span>
    <span class='rubyid_updated identifier id'>updated</span> <span class='assign token'>=</span> <span class='rubyid_true true kw'>true</span>

  <span class='comment val'># any other case, we can skip slug processing</span>
  <span class='rubyid_else else kw'>else</span>
    <span class='rubyid_updated identifier id'>updated</span> <span class='assign token'>=</span> <span class='rubyid_false false kw'>false</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_return return kw'>return</span> <span class='rubyid_updated identifier id'>updated</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="slug_in_use?-class_method">
  
    .<strong>slug_in_use?</strong>(slug)  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>given a slug, return true if slug is used by another entity.
return false otherwise.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


150
151
152
153
154
155
156
157</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_generate.rb', line 150</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_slug_in_use? fid id'>slug_in_use?</span><span class='lparen token'>(</span><span class='rubyid_slug identifier id'>slug</span><span class='rparen token'>)</span>

  <span class='rubyid_if if kw'>if</span> <span class='rubyid_job_running? fid id'>job_running?</span>
    <span class='rubyid_cache identifier id'>cache</span><span class='dot token'>.</span><span class='rubyid_include? fid id'>include?</span> <span class='rubyid_slug identifier id'>slug</span>
  <span class='rubyid_else else kw'>else</span>
    <span class='lparen token'>(</span><span class='rubyid_slug_record_types identifier id'>slug_record_types</span> <span class='plus op'>+</span> <span class='lbrack token'>[</span><span class='rubyid_Repository constant id'>Repository</span><span class='rbrack token'>]</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_inject identifier id'>inject</span><span class='lparen token'>(</span><span class='integer val'>0</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='rubyid_count identifier id'>count</span><span class='comma token'>,</span> <span class='rubyid_klass identifier id'>klass</span><span class='bitor op'>|</span> <span class='rubyid_count identifier id'>count</span> <span class='plus op'>+</span> <span class='rubyid_klass identifier id'>klass</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='symbol val'>:slug</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_slug identifier id'>slug</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_count identifier id'>count</span> <span class='rbrace token'>}</span> <span class='gt op'>&gt;</span> <span class='integer val'>0</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="slug_record_types-class_method">
  
    .<strong>slug_record_types</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


28
29
30</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/lib/slugs/slug_helpers_eligibility.rb', line 28</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_slug_record_types identifier id'>slug_record_types</span>
  <span class='rubyid_@@slug_record_types ivar id'>@@slug_record_types</span> <span class='opasgn op'>||=</span> <span class='lparen token'>(</span><span class='rubyid_AGENT_RECORD_TYPES constant id'>AGENT_RECORD_TYPES</span> <span class='plus op'>+</span> <span class='rubyid_BASE_RECORD_TYPES constant id'>BASE_RECORD_TYPES</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='rubyid_string identifier id'>string</span><span class='bitor op'>|</span> <span class='rubyid_Kernel constant id'>Kernel</span><span class='dot token'>.</span><span class='rubyid_const_get identifier id'>const_get</span><span class='lparen token'>(</span><span class='rubyid_string identifier id'>string</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  ArchivesSpace Version v2.8.0.a Documentation Generated on Thu Jul 16 10:06:52 2020 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.20.
</div>

    </div>
  </body>
</html>