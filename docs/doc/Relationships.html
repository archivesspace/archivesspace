<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: Relationships
  
    &mdash; Documentation by YARD 0.9.20
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "Relationships";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="alpha_index.html">Index (R)</a> &raquo;
    
    
    <span class="title">Relationships</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: Relationships
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>backend/app/model/mixins/relationships.rb</dd>
  </dl>
  
</div>

<h2>Defined Under Namespace</h2>
<p class="children">
  
    
      <strong class="modules">Modules:</strong> <span class='object_link'><a href="Relationships/ClassMethods.html" title="Relationships::ClassMethods (module)">ClassMethods</a></span>
    
  
    
  
    
  
</p>




  <h2>Instance Attribute Summary <small><a href="#" class="summary_toggle">collapse</a></small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#cached_relationships-instance_method" title="#cached_relationships (instance method)">#<strong>cached_relationships</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Store a list of the relationships that this object participates in.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#included-class_method" title="included (class method)">.<strong>included</strong>(base)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#assimilate-instance_method" title="#assimilate (instance method)">#<strong>assimilate</strong>(victims)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Find all relationships involving the records in ‘victims’ and rewrite them to refer to us instead.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#cache_relationships-instance_method" title="#cache_relationships (instance method)">#<strong>cache_relationships</strong>(relationship_defn, relationship_objects)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#do_has_link_error-instance_method" title="#do_has_link_error (instance method)">#<strong>do_has_link_error</strong>(instances)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#do_transferable%3F-instance_method" title="#do_transferable? (instance method)">#<strong>do_transferable?</strong>(do_id)  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#my_relationships-instance_method" title="#my_relationships (instance method)">#<strong>my_relationships</strong>(name)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Added to the mixed in class itself: return a list of the relationship instances involving this object.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#related_records-instance_method" title="#related_records (instance method)">#<strong>related_records</strong>(name)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Return all object instances that are related to the current record by the relationship named by ‘name’.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#transfer_to_repository-instance_method" title="#transfer_to_repository (instance method)">#<strong>transfer_to_repository</strong>(repository, transfer_group = [])  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#trigger_reindex_of_dependants-instance_method" title="#trigger_reindex_of_dependants (instance method)">#<strong>trigger_reindex_of_dependants</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_from_json-instance_method" title="#update_from_json (instance method)">#<strong>update_from_json</strong>(json, opts = {}, apply_nested_records = true)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
    </ul>
  


  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="cached_relationships-instance_method">
  
    #<strong>cached_relationships</strong>  &#x21d2; <tt>Object</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Store a list of the relationships that this object participates in.  Saves
looking up the DB for each one.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


504
505
506</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/relationships.rb', line 504</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_cached_relationships identifier id'>cached_relationships</span>
  <span class='rubyid_@cached_relationships ivar id'>@cached_relationships</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="included-class_method">
  
    .<strong>included</strong>(base)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


479
480
481
482
483
484
485
486</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/relationships.rb', line 479</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_included identifier id'>included</span><span class='lparen token'>(</span><span class='rubyid_base identifier id'>base</span><span class='rparen token'>)</span>
  <span class='rubyid_base identifier id'>base</span><span class='dot token'>.</span><span class='rubyid_instance_eval identifier id'>instance_eval</span> <span class='rubyid_do do kw'>do</span>
    <span class='rubyid_@relationships ivar id'>@relationships</span> <span class='opasgn op'>||=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
    <span class='rubyid_@relationship_dependencies ivar id'>@relationship_dependencies</span> <span class='opasgn op'>||=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_base identifier id'>base</span><span class='dot token'>.</span><span class='rubyid_extend identifier id'>extend</span><span class='lparen token'>(</span><span class='rubyid_ClassMethods constant id'>ClassMethods</span><span class='rparen token'>)</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="assimilate-instance_method">
  
    #<strong>assimilate</strong>(victims)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Find all relationships involving the records in ‘victims’ and rewrite them
to refer to us instead.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/relationships.rb', line 542</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_assimilate identifier id'>assimilate</span><span class='lparen token'>(</span><span class='rubyid_victims identifier id'>victims</span><span class='rparen token'>)</span>
  <span class='rubyid_victims identifier id'>victims</span> <span class='assign token'>=</span> <span class='rubyid_victims identifier id'>victims</span><span class='dot token'>.</span><span class='rubyid_reject identifier id'>reject</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='rubyid_v identifier id'>v</span><span class='bitor op'>|</span> <span class='lparen token'>(</span><span class='rubyid_v identifier id'>v</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span> <span class='eq op'>==</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='rparen token'>)</span> <span class='andop op'>&amp;&amp;</span> <span class='lparen token'>(</span><span class='rubyid_v identifier id'>v</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span> <span class='eq op'>==</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span><span class='rparen token'>)</span><span class='rbrace token'>}</span>

  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_relationship_dependencies identifier id'>relationship_dependencies</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_relationship identifier id'>relationship</span><span class='comma token'>,</span> <span class='rubyid_models identifier id'>models</span><span class='bitor op'>|</span>
    <span class='rubyid_models identifier id'>models</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_model identifier id'>model</span><span class='bitor op'>|</span>
      <span class='rubyid_model identifier id'>model</span><span class='dot token'>.</span><span class='rubyid_transfer identifier id'>transfer</span><span class='lparen token'>(</span><span class='rubyid_relationship identifier id'>relationship</span><span class='comma token'>,</span> <span class='rubyid_self self kw'>self</span><span class='comma token'>,</span> <span class='rubyid_victims identifier id'>victims</span><span class='rparen token'>)</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_DB constant id'>DB</span><span class='dot token'>.</span><span class='rubyid_attempt identifier id'>attempt</span> <span class='lbrace token'>{</span>
    <span class='rubyid_victims identifier id'>victims</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span><span class='lparen token'>(</span><span class='bitand op'>&amp;</span><span class='symbol val'>:delete</span><span class='rparen token'>)</span>
  <span class='rbrace token'>}</span><span class='dot token'>.</span><span class='rubyid_and_if_constraint_fails identifier id'>and_if_constraint_fails</span> <span class='lbrace token'>{</span>
    <span class='rubyid_raise identifier id'>raise</span> <span class='rubyid_MergeRequestFailed constant id'>MergeRequestFailed</span><span class='dot token'>.</span><span class='rubyid_new identifier id'>new</span><span class='lparen token'>(</span><span class='string val'>&quot;Can&#39;t complete merge: record still in use&quot;</span><span class='rparen token'>)</span>
  <span class='rbrace token'>}</span>

  <span class='rubyid_trigger_reindex_of_dependants identifier id'>trigger_reindex_of_dependants</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="cache_relationships-instance_method">
  
    #<strong>cache_relationships</strong>(relationship_defn, relationship_objects)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


505
506
507
508</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/relationships.rb', line 505</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_cache_relationships identifier id'>cache_relationships</span><span class='lparen token'>(</span><span class='rubyid_relationship_defn identifier id'>relationship_defn</span><span class='comma token'>,</span> <span class='rubyid_relationship_objects identifier id'>relationship_objects</span><span class='rparen token'>)</span>
  <span class='rubyid_@cached_relationships ivar id'>@cached_relationships</span> <span class='opasgn op'>||=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
  <span class='rubyid_@cached_relationships ivar id'>@cached_relationships</span><span class='lbrack token'>[</span><span class='rubyid_relationship_defn identifier id'>relationship_defn</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rubyid_relationship_objects identifier id'>relationship_objects</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="do_has_link_error-instance_method">
  
    #<strong>do_has_link_error</strong>(instances)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/relationships.rb', line 614</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_do_has_link_error identifier id'>do_has_link_error</span><span class='lparen token'>(</span><span class='rubyid_instances identifier id'>instances</span><span class='rparen token'>)</span>
  <span class='comment val'># Abort the transfer and provide the list of top-level records that are preventing it from completing.</span>
  <span class='rubyid_exception identifier id'>exception</span> <span class='assign token'>=</span> <span class='rubyid_TransferConstraintError constant id'>TransferConstraintError</span><span class='dot token'>.</span><span class='rubyid_new identifier id'>new</span>

  <span class='rubyid_ASModel constant id'>ASModel</span><span class='dot token'>.</span><span class='rubyid_all_models identifier id'>all_models</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_model identifier id'>model</span><span class='bitor op'>|</span>
    <span class='rubyid_next next kw'>next</span> <span class='rubyid_unless unless_mod kw'>unless</span> <span class='rubyid_model identifier id'>model</span><span class='dot token'>.</span><span class='rubyid_associations identifier id'>associations</span><span class='dot token'>.</span><span class='rubyid_include? fid id'>include?</span><span class='lparen token'>(</span><span class='symbol val'>:instance</span><span class='rparen token'>)</span>

    <span class='rubyid_model identifier id'>model</span>
      <span class='dot token'>.</span><span class='rubyid_eager_graph identifier id'>eager_graph</span><span class='lparen token'>(</span><span class='symbol val'>:instance</span><span class='rparen token'>)</span>
      <span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:instance__id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_instances identifier id'>instances</span><span class='rparen token'>)</span>
      <span class='dot token'>.</span><span class='rubyid_select identifier id'>select</span><span class='lparen token'>(</span><span class='rubyid_Sequel constant id'>Sequel</span><span class='dot token'>.</span><span class='rubyid_qualify identifier id'>qualify</span><span class='lparen token'>(</span><span class='rubyid_model identifier id'>model</span><span class='dot token'>.</span><span class='rubyid_table_name identifier id'>table_name</span><span class='comma token'>,</span> <span class='symbol val'>:id</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
      <span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_row identifier id'>row</span><span class='bitor op'>|</span>
      <span class='rubyid_exception identifier id'>exception</span><span class='dot token'>.</span><span class='rubyid_add_conflict identifier id'>add_conflict</span><span class='lparen token'>(</span><span class='rubyid_model identifier id'>model</span><span class='dot token'>.</span><span class='rubyid_my_jsonmodel identifier id'>my_jsonmodel</span><span class='dot token'>.</span><span class='rubyid_uri_for identifier id'>uri_for</span><span class='lparen token'>(</span><span class='rubyid_row identifier id'>row</span><span class='lbrack token'>[</span><span class='symbol val'>:id</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='symbol val'>:repo_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_active_repository identifier id'>active_repository</span><span class='rparen token'>)</span><span class='comma token'>,</span>
                      <span class='lbrace token'>{</span><span class='symbol val'>:json_property</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&#39;instances&#39;</span><span class='comma token'>,</span>
                       <span class='symbol val'>:message</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;DIGITAL_OBJECT_HAS_LINK&quot;</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
      <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_raise identifier id'>raise</span> <span class='rubyid_exception identifier id'>exception</span>
  <span class='rubyid_return return kw'>return</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="do_transferable?-instance_method">
  
    #<strong>do_transferable?</strong>(do_id)  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


597
598
599
600
601
602
603
604
605
606
607
608
609
610
611</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/relationships.rb', line 597</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_do_transferable? fid id'>do_transferable?</span><span class='lparen token'>(</span><span class='rubyid_do_id identifier id'>do_id</span><span class='rparen token'>)</span>
  <span class='comment val'># ANW-151: Digital objects should not be transferable if they have instance links to other repository-scoped record types. If not transferrable, we throw an error and abort the transfer.</span>
  <span class='rubyid_do_relationship identifier id'>do_relationship</span> <span class='assign token'>=</span> <span class='rubyid_DigitalObject constant id'>DigitalObject</span><span class='dot token'>.</span><span class='rubyid_find_relationship identifier id'>find_relationship</span><span class='lparen token'>(</span><span class='symbol val'>:instance_do_link</span><span class='rparen token'>)</span>

  <span class='rubyid_instances identifier id'>instances</span> <span class='assign token'>=</span> <span class='rubyid_do_relationship identifier id'>do_relationship</span>
  <span class='dot token'>.</span><span class='rubyid_select identifier id'>select</span><span class='lparen token'>(</span><span class='symbol val'>:instance_id</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:digital_object_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_do_id identifier id'>do_id</span><span class='rparen token'>)</span>
  <span class='dot token'>.</span><span class='rubyid_map identifier id'>map</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='rubyid_row identifier id'>row</span><span class='bitor op'>|</span> <span class='rubyid_row identifier id'>row</span><span class='lbrack token'>[</span><span class='symbol val'>:instance_id</span><span class='rbrack token'>]</span><span class='rbrace token'>}</span>

  <span class='rubyid_if if kw'>if</span> <span class='rubyid_instances identifier id'>instances</span><span class='dot token'>.</span><span class='rubyid_empty? fid id'>empty?</span>
    <span class='rubyid_true true kw'>true</span>
  <span class='rubyid_else else kw'>else</span>
    <span class='rubyid_do_has_link_error identifier id'>do_has_link_error</span><span class='lparen token'>(</span><span class='rubyid_instances identifier id'>instances</span><span class='rparen token'>)</span>
    <span class='rubyid_false false kw'>false</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="my_relationships-instance_method">
  
    #<strong>my_relationships</strong>(name)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Added to the mixed in class itself: return a list of the relationship
instances involving this object</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


525
526
527</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/relationships.rb', line 525</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_my_relationships identifier id'>my_relationships</span><span class='lparen token'>(</span><span class='rubyid_name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_find_relationship identifier id'>find_relationship</span><span class='lparen token'>(</span><span class='rubyid_name identifier id'>name</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_by_participant identifier id'>find_by_participant</span><span class='lparen token'>(</span><span class='rubyid_self self kw'>self</span><span class='rparen token'>)</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="related_records-instance_method">
  
    #<strong>related_records</strong>(name)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Return all object instances that are related to the current record by the
relationship named by ‘name’.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


532
533
534
535
536
537</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/relationships.rb', line 532</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_related_records identifier id'>related_records</span><span class='lparen token'>(</span><span class='rubyid_name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='rubyid_relationship identifier id'>relationship</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_find_relationship identifier id'>find_relationship</span><span class='lparen token'>(</span><span class='rubyid_name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='rubyid_records identifier id'>records</span> <span class='assign token'>=</span> <span class='rubyid_relationship identifier id'>relationship</span><span class='dot token'>.</span><span class='rubyid_who_participates_with identifier id'>who_participates_with</span><span class='lparen token'>(</span><span class='rubyid_self self kw'>self</span><span class='rparen token'>)</span>

  <span class='rubyid_relationship identifier id'>relationship</span><span class='dot token'>.</span><span class='rubyid_wants_array? fid id'>wants_array?</span> <span class='integer val'>? </span><span class='rubyid_records identifier id'>records</span> <span class='colon op'>:</span> <span class='rubyid_records identifier id'>records</span><span class='dot token'>.</span><span class='rubyid_first identifier id'>first</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="transfer_to_repository-instance_method">
  
    #<strong>transfer_to_repository</strong>(repository, transfer_group = [])  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/relationships.rb', line 561</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_transfer_to_repository identifier id'>transfer_to_repository</span><span class='lparen token'>(</span><span class='rubyid_repository identifier id'>repository</span><span class='comma token'>,</span> <span class='rubyid_transfer_group identifier id'>transfer_group</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
  <span class='rubyid_if if kw'>if</span> <span class='rubyid_transfer_group identifier id'>transfer_group</span><span class='dot token'>.</span><span class='rubyid_empty? fid id'>empty?</span>
    <span class='rubyid_do_id identifier id'>do_id</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span> <span class='eq op'>==</span> <span class='rubyid_DigitalObject constant id'>DigitalObject</span> <span class='integer val'>? </span><span class='rubyid_self self kw'>self</span><span class='lbrack token'>[</span><span class='symbol val'>:id</span><span class='rbrack token'>]</span> <span class='colon op'>:</span> <span class='integer val'>0</span>
  <span class='rubyid_else else kw'>else</span>
    <span class='rubyid_do_id identifier id'>do_id</span> <span class='assign token'>=</span> <span class='rubyid_transfer_group identifier id'>transfer_group</span><span class='dot token'>.</span><span class='rubyid_first identifier id'>first</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span> <span class='eq op'>==</span> <span class='rubyid_DigitalObject constant id'>DigitalObject</span> <span class='integer val'>? </span><span class='rubyid_transfer_group identifier id'>transfer_group</span><span class='dot token'>.</span><span class='rubyid_first identifier id'>first</span><span class='lbrack token'>[</span><span class='symbol val'>:id</span><span class='rbrack token'>]</span> <span class='colon op'>:</span> <span class='integer val'>0</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_unless unless kw'>unless</span> <span class='rubyid_do_id identifier id'>do_id</span> <span class='eq op'>==</span> <span class='integer val'>0</span>
    <span class='rubyid_return return kw'>return</span> <span class='rubyid_unless unless_mod kw'>unless</span> <span class='rubyid_do_transferable? fid id'>do_transferable?</span><span class='lparen token'>(</span><span class='rubyid_do_id identifier id'>do_id</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='comment val'># When a record is being transferred to another repository, any</span>
  <span class='comment val'># relationships it has to records within the current repository must be</span>
  <span class='comment val'># cleared.</span>

  <span class='rubyid_predicate identifier id'>predicate</span> <span class='assign token'>=</span> <span class='rubyid_proc identifier id'>proc</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='rubyid_relationship identifier id'>relationship</span><span class='bitor op'>|</span>
    <span class='rubyid_referent identifier id'>referent</span> <span class='assign token'>=</span> <span class='rubyid_relationship identifier id'>relationship</span><span class='dot token'>.</span><span class='rubyid_other_referent_than identifier id'>other_referent_than</span><span class='lparen token'>(</span><span class='rubyid_self self kw'>self</span><span class='rparen token'>)</span>

    <span class='comment val'># Delete the relationship if we&#39;re repository-scoped and the referent is</span>
    <span class='comment val'># in the old repository.  Don&#39;t worry about relationships to any of the</span>
    <span class='comment val'># records that are going to be transferred along with us (listed in</span>
    <span class='comment val'># transfer_group)</span>
    <span class='lparen token'>(</span><span class='rubyid_referent identifier id'>referent</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_model_scope identifier id'>model_scope</span> <span class='eq op'>==</span> <span class='symbol val'>:repository</span> <span class='andop op'>&amp;&amp;</span>
     <span class='rubyid_referent identifier id'>referent</span><span class='dot token'>.</span><span class='rubyid_repo_id identifier id'>repo_id</span> <span class='neq op'>!=</span> <span class='rubyid_repository identifier id'>repository</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span> <span class='andop op'>&amp;&amp;</span>
     <span class='notop op'>!</span><span class='rubyid_transfer_group identifier id'>transfer_group</span><span class='dot token'>.</span><span class='rubyid_any? fid id'>any?</span><span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='rubyid_obj identifier id'>obj</span><span class='bitor op'>|</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span> <span class='eq op'>==</span> <span class='rubyid_referent identifier id'>referent</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span> <span class='andop op'>&amp;&amp;</span> <span class='rubyid_obj identifier id'>obj</span><span class='dot token'>.</span><span class='rubyid_model identifier id'>model</span> <span class='eq op'>==</span> <span class='rubyid_referent identifier id'>referent</span><span class='dot token'>.</span><span class='rubyid_model identifier id'>model</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
  <span class='rbrace token'>}</span>


  <span class='lparen token'>(</span><span class='lbrack token'>[</span><span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='rbrack token'>]</span> <span class='plus op'>+</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_dependent_models identifier id'>dependent_models</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_model identifier id'>model</span><span class='bitor op'>|</span>
    <span class='rubyid_model identifier id'>model</span><span class='dot token'>.</span><span class='rubyid_delete_existing_relationships identifier id'>delete_existing_relationships</span><span class='lparen token'>(</span><span class='rubyid_self self kw'>self</span><span class='comma token'>,</span> <span class='rubyid_false false kw'>false</span><span class='comma token'>,</span> <span class='rubyid_false false kw'>false</span><span class='comma token'>,</span> <span class='rubyid_predicate identifier id'>predicate</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_super super kw'>super</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="trigger_reindex_of_dependants-instance_method">
  
    #<strong>trigger_reindex_of_dependants</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


511
512
513
514
515
516
517
518
519
520</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/relationships.rb', line 511</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_trigger_reindex_of_dependants identifier id'>trigger_reindex_of_dependants</span>
  <span class='comment val'># Update the mtime of any record with a relationship to this one.  This</span>
  <span class='comment val'># encourages the indexer to reindex records when, say, a subject is renamed.</span>
  <span class='comment val'>#</span>
  <span class='comment val'># Once we have our list of unique models, inform each of them that our</span>
  <span class='comment val'># instance has been updated (using a class method defined below).</span>
  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_dependent_models identifier id'>dependent_models</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_model identifier id'>model</span><span class='bitor op'>|</span>
    <span class='rubyid_model identifier id'>model</span><span class='dot token'>.</span><span class='rubyid_touch_mtime_of_anyone_related_to identifier id'>touch_mtime_of_anyone_related_to</span><span class='lparen token'>(</span><span class='rubyid_self self kw'>self</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_from_json-instance_method">
  
    #<strong>update_from_json</strong>(json, opts = {}, apply_nested_records = true)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


489
490
491
492
493
494
495
496
497
498
499</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/relationships.rb', line 489</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_update_from_json identifier id'>update_from_json</span><span class='lparen token'>(</span><span class='rubyid_json identifier id'>json</span><span class='comma token'>,</span> <span class='rubyid_opts identifier id'>opts</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='rubyid_apply_nested_records identifier id'>apply_nested_records</span> <span class='assign token'>=</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
  <span class='rubyid_obj identifier id'>obj</span> <span class='assign token'>=</span> <span class='rubyid_super super kw'>super</span>

  <span class='comment val'># Call this before and after the change since relationships might have been</span>
  <span class='comment val'># removed and the previously linked objects might need reindexing.</span>
  <span class='rubyid_trigger_reindex_of_dependants identifier id'>trigger_reindex_of_dependants</span>
  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_apply_relationships identifier id'>apply_relationships</span><span class='lparen token'>(</span><span class='rubyid_obj identifier id'>obj</span><span class='comma token'>,</span> <span class='rubyid_json identifier id'>json</span><span class='comma token'>,</span> <span class='rubyid_opts identifier id'>opts</span><span class='rparen token'>)</span>
  <span class='rubyid_trigger_reindex_of_dependants identifier id'>trigger_reindex_of_dependants</span>

  <span class='rubyid_obj identifier id'>obj</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  ArchivesSpace Version v2.8.0.a Documentation Generated on Thu Jul 16 10:06:54 2020 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.20.
</div>

    </div>
  </body>
</html>