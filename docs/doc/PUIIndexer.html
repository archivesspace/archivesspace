<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: PUIIndexer
  
    &mdash; Documentation by YARD 0.9.20
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "PUIIndexer";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="alpha_index.html">Index (P)</a> &raquo;
    
    
    <span class="title">PUIIndexer</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: PUIIndexer
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName"><span class='object_link'><a href="PeriodicIndexer.html" title="PeriodicIndexer (class)">PeriodicIndexer</a></span></span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next"><span class='object_link'><a href="IndexerCommon.html" title="IndexerCommon (class)">IndexerCommon</a></span></li>
          
            <li class="next"><span class='object_link'><a href="PeriodicIndexer.html" title="PeriodicIndexer (class)">PeriodicIndexer</a></span></li>
          
            <li class="next">PUIIndexer</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>indexer/app/lib/pui_indexer.rb</dd>
  </dl>
  
</div>



  
    <h2>
      Constant Summary
      <small><a href="#" class="constants_summary_toggle">collapse</a></small>
    </h2>

    <dl class="constants">
      
        <dt id="PUI_RESOLVES-constant" class="">PUI_RESOLVES =
          
        </dt>
        <dd><pre class="code"><span class='lbrack token'>[</span>
  <span class='string val'>&#39;ancestors&#39;</span><span class='comma token'>,</span>
  <span class='string val'>&#39;ancestors::linked_agents&#39;</span><span class='comma token'>,</span>
  <span class='string val'>&#39;ancestors::subjects&#39;</span><span class='comma token'>,</span>
  <span class='string val'>&#39;ancestors::instances::sub_container::top_container&#39;</span>
<span class='rbrack token'>]</span>
</pre></dd>
      
    </dl>
  



  
  
  <h3 class="inherited">Constants inherited
     from <span class='object_link'><a href="IndexerCommon.html" title="IndexerCommon (class)">IndexerCommon</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="IndexerCommon.html#HARDCODED_ENUM_FIELDS-constant" title="IndexerCommon::HARDCODED_ENUM_FIELDS (constant)">IndexerCommon::HARDCODED_ENUM_FIELDS</a></span></p>

  
  
  <h3 class="inherited">Constants included
     from <span class='object_link'><a href="JSONModel.html" title="JSONModel (module)">JSONModel</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="JSONModel.html#REFERENCE_KEY_REGEX-constant" title="JSONModel::REFERENCE_KEY_REGEX (constant)">JSONModel::REFERENCE_KEY_REGEX</a></span></p>






  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_indexer-class_method" title="get_indexer (class method)">.<strong>get_indexer</strong>(state = nil, name = &quot;PUI Indexer&quot;)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_infscroll_docs-instance_method" title="#add_infscroll_docs (instance method)">#<strong>add_infscroll_docs</strong>(resource_uris, batch)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#configure_doc_rules-instance_method" title="#configure_doc_rules (instance method)">#<strong>configure_doc_rules</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#fetch_records-instance_method" title="#fetch_records (instance method)">#<strong>fetch_records</strong>(type, ids, resolve)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#index_round_complete-instance_method" title="#index_round_complete (instance method)">#<strong>index_round_complete</strong>(repository)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(backend = nil, state = nil, name)  &#x21d2; PUIIndexer </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>A new instance of PUIIndexer.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#record_types-instance_method" title="#record_types (instance method)">#<strong>record_types</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#resolved_attributes-instance_method" title="#resolved_attributes (instance method)">#<strong>resolved_attributes</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#skip_index_doc%3F-instance_method" title="#skip_index_doc? (instance method)">#<strong>skip_index_doc?</strong>(doc)  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#skip_index_record%3F-instance_method" title="#skip_index_record? (instance method)">#<strong>skip_index_record?</strong>(record)  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#stage_unpublished_for_deletion-instance_method" title="#stage_unpublished_for_deletion (instance method)">#<strong>stage_unpublished_for_deletion</strong>(doc_id)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="PeriodicIndexer.html" title="PeriodicIndexer (class)">PeriodicIndexer</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="PeriodicIndexer.html#handle_deletes-instance_method" title="PeriodicIndexer#handle_deletes (method)">#handle_deletes</a></span>, <span class='object_link'><a href="PeriodicIndexer.html#log-instance_method" title="PeriodicIndexer#log (method)">#log</a></span>, <span class='object_link'><a href="PeriodicIndexer.html#run-instance_method" title="PeriodicIndexer#run (method)">#run</a></span>, <span class='object_link'><a href="PeriodicIndexer.html#run_index_round-instance_method" title="PeriodicIndexer#run_index_round (method)">#run_index_round</a></span>, <span class='object_link'><a href="PeriodicIndexer.html#start_worker_thread-instance_method" title="PeriodicIndexer#start_worker_thread (method)">#start_worker_thread</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="IndexerCommon.html" title="IndexerCommon (class)">IndexerCommon</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="IndexerCommon.html#add_agents-instance_method" title="IndexerCommon#add_agents (method)">#add_agents</a></span>, <span class='object_link'><a href="IndexerCommon.html#add_attribute_to_resolve-class_method" title="IndexerCommon.add_attribute_to_resolve (method)">add_attribute_to_resolve</a></span>, <span class='object_link'><a href="IndexerCommon.html#add_audit_info-instance_method" title="IndexerCommon#add_audit_info (method)">#add_audit_info</a></span>, <span class='object_link'><a href="IndexerCommon.html#add_batch_hook-instance_method" title="IndexerCommon#add_batch_hook (method)">#add_batch_hook</a></span>, <span class='object_link'><a href="IndexerCommon.html#add_delete_hook-instance_method" title="IndexerCommon#add_delete_hook (method)">#add_delete_hook</a></span>, <span class='object_link'><a href="IndexerCommon.html#add_document_prepare_hook-instance_method" title="IndexerCommon#add_document_prepare_hook (method)">#add_document_prepare_hook</a></span>, <span class='object_link'><a href="IndexerCommon.html#add_extra_documents_hook-instance_method" title="IndexerCommon#add_extra_documents_hook (method)">#add_extra_documents_hook</a></span>, <span class='object_link'><a href="IndexerCommon.html#add_indexer_initialize_hook-class_method" title="IndexerCommon.add_indexer_initialize_hook (method)">add_indexer_initialize_hook</a></span>, <span class='object_link'><a href="IndexerCommon.html#add_level-instance_method" title="IndexerCommon#add_level (method)">#add_level</a></span>, <span class='object_link'><a href="IndexerCommon.html#add_notes-instance_method" title="IndexerCommon#add_notes (method)">#add_notes</a></span>, <span class='object_link'><a href="IndexerCommon.html#add_subjects-instance_method" title="IndexerCommon#add_subjects (method)">#add_subjects</a></span>, <span class='object_link'><a href="IndexerCommon.html#add_summary-instance_method" title="IndexerCommon#add_summary (method)">#add_summary</a></span>, <span class='object_link'><a href="IndexerCommon.html#add_years-instance_method" title="IndexerCommon#add_years (method)">#add_years</a></span>, <span class='object_link'><a href="IndexerCommon.html#apply_pui_fields-instance_method" title="IndexerCommon#apply_pui_fields (method)">#apply_pui_fields</a></span>, <span class='object_link'><a href="IndexerCommon.html#build_fullrecord-class_method" title="IndexerCommon.build_fullrecord (method)">build_fullrecord</a></span>, <span class='object_link'><a href="IndexerCommon.html#clean_for_sort-instance_method" title="IndexerCommon#clean_for_sort (method)">#clean_for_sort</a></span>, <span class='object_link'><a href="IndexerCommon.html#clean_whitespace-instance_method" title="IndexerCommon#clean_whitespace (method)">#clean_whitespace</a></span>, <span class='object_link'><a href="IndexerCommon.html#dedupe_by_uri-instance_method" title="IndexerCommon#dedupe_by_uri (method)">#dedupe_by_uri</a></span>, <span class='object_link'><a href="IndexerCommon.html#delete_records-instance_method" title="IndexerCommon#delete_records (method)">#delete_records</a></span>, <span class='object_link'><a href="IndexerCommon.html#do_http_request-instance_method" title="IndexerCommon#do_http_request (method)">#do_http_request</a></span>, <span class='object_link'><a href="IndexerCommon.html#extract_string_values-class_method" title="IndexerCommon.extract_string_values (method)">extract_string_values</a></span>, <span class='object_link'><a href="IndexerCommon.html#generate_permutations_for_identifier-class_method" title="IndexerCommon.generate_permutations_for_identifier (method)">generate_permutations_for_identifier</a></span>, <span class='object_link'><a href="IndexerCommon.html#generate_sort_string_for_identifier-class_method" title="IndexerCommon.generate_sort_string_for_identifier (method)">generate_sort_string_for_identifier</a></span>, <span class='object_link'><a href="IndexerCommon.html#generate_years_for_date_range-class_method" title="IndexerCommon.generate_years_for_date_range (method)">generate_years_for_date_range</a></span>, <span class='object_link'><a href="IndexerCommon.html#get_record_scope-instance_method" title="IndexerCommon#get_record_scope (method)">#get_record_scope</a></span>, <span class='object_link'><a href="IndexerCommon.html#index_batch-instance_method" title="IndexerCommon#index_batch (method)">#index_batch</a></span>, <span class='object_link'><a href="IndexerCommon.html#index_records-instance_method" title="IndexerCommon#index_records (method)">#index_records</a></span>, <span class='object_link'><a href="IndexerCommon.html#is_repository_unpublished%3F-instance_method" title="IndexerCommon#is_repository_unpublished? (method)">#is_repository_unpublished?</a></span>, <span class='object_link'><a href="IndexerCommon.html#login-instance_method" title="IndexerCommon#login (method)">#login</a></span>, <span class='object_link'><a href="IndexerCommon.html#pause-class_method" title="IndexerCommon.pause (method)">pause</a></span>, <span class='object_link'><a href="IndexerCommon.html#paused%3F-class_method" title="IndexerCommon.paused? (method)">paused?</a></span>, <span class='object_link'><a href="IndexerCommon.html#paused%3F-instance_method" title="IndexerCommon#paused? (method)">#paused?</a></span>, <span class='object_link'><a href="IndexerCommon.html#record_has_children-instance_method" title="IndexerCommon#record_has_children (method)">#record_has_children</a></span>, <span class='object_link'><a href="IndexerCommon.html#records_with_children-instance_method" title="IndexerCommon#records_with_children (method)">#records_with_children</a></span>, <span class='object_link'><a href="IndexerCommon.html#reset_session-instance_method" title="IndexerCommon#reset_session (method)">#reset_session</a></span>, <span class='object_link'><a href="IndexerCommon.html#send_commit-instance_method" title="IndexerCommon#send_commit (method)">#send_commit</a></span>, <span class='object_link'><a href="IndexerCommon.html#solr_url-instance_method" title="IndexerCommon#solr_url (method)">#solr_url</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="JSONModel.html" title="JSONModel (module)">JSONModel</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="JSONModel.html#JSONModel-class_method" title="JSONModel.JSONModel (method)">JSONModel</a></span>, <span class='object_link'><a href="JSONModel.html#JSONModel-instance_method" title="JSONModel#JSONModel (method)">#JSONModel</a></span>, <span class='object_link'><a href="JSONModel.html#add_error_handler-class_method" title="JSONModel.add_error_handler (method)">add_error_handler</a></span>, <span class='object_link'><a href="JSONModel.html#all-class_method" title="JSONModel.all (method)">all</a></span>, <span class='object_link'><a href="JSONModel.html#allow_unmapped_enum_value-class_method" title="JSONModel.allow_unmapped_enum_value (method)">allow_unmapped_enum_value</a></span>, <span class='object_link'><a href="JSONModel.html#backend_url-class_method" title="JSONModel.backend_url (method)">backend_url</a></span>, <span class='object_link'><a href="JSONModel.html#check_valid_refs-class_method" title="JSONModel.check_valid_refs (method)">check_valid_refs</a></span>, <span class='object_link'><a href="JSONModel.html#client_mode%3F-class_method" title="JSONModel.client_mode? (method)">client_mode?</a></span>, <span class='object_link'><a href="JSONModel.html#custom_validations-class_method" title="JSONModel.custom_validations (method)">custom_validations</a></span>, <span class='object_link'><a href="JSONModel.html#destroy_model-class_method" title="JSONModel.destroy_model (method)">destroy_model</a></span>, <span class='object_link'><a href="JSONModel.html#enum_default_value-class_method" title="JSONModel.enum_default_value (method)">enum_default_value</a></span>, <span class='object_link'><a href="JSONModel.html#enum_values-class_method" title="JSONModel.enum_values (method)">enum_values</a></span>, <span class='object_link'><a href="JSONModel.html#handle_error-class_method" title="JSONModel.handle_error (method)">handle_error</a></span>, <span class='object_link'><a href="JSONModel.html#init-class_method" title="JSONModel.init (method)">init</a></span>, <span class='object_link'><a href="JSONModel.html#load_schema-class_method" title="JSONModel.load_schema (method)">load_schema</a></span>, <span class='object_link'><a href="JSONModel.html#models-instance_method" title="JSONModel#models (method)">#models</a></span>, <span class='object_link'><a href="JSONModel.html#models-class_method" title="JSONModel.models (method)">models</a></span>, <span class='object_link'><a href="JSONModel.html#parse_jsonmodel_ref-class_method" title="JSONModel.parse_jsonmodel_ref (method)">parse_jsonmodel_ref</a></span>, <span class='object_link'><a href="JSONModel.html#parse_reference-class_method" title="JSONModel.parse_reference (method)">parse_reference</a></span>, <span class='object_link'><a href="JSONModel.html#repository-class_method" title="JSONModel.repository (method)">repository</a></span>, <span class='object_link'><a href="JSONModel.html#repository_for-class_method" title="JSONModel.repository_for (method)">repository_for</a></span>, <span class='object_link'><a href="JSONModel.html#schema_src-class_method" title="JSONModel.schema_src (method)">schema_src</a></span>, <span class='object_link'><a href="JSONModel.html#set_publish_flags!-class_method" title="JSONModel.set_publish_flags! (method)">set_publish_flags!</a></span>, <span class='object_link'><a href="JSONModel.html#set_repository-class_method" title="JSONModel.set_repository (method)">set_repository</a></span>, <span class='object_link'><a href="JSONModel.html#strict_mode-class_method" title="JSONModel.strict_mode (method)">strict_mode</a></span>, <span class='object_link'><a href="JSONModel.html#strict_mode%3F-class_method" title="JSONModel.strict_mode? (method)">strict_mode?</a></span>, <span class='object_link'><a href="JSONModel.html#validate_schema-class_method" title="JSONModel.validate_schema (method)">validate_schema</a></span>, <span class='object_link'><a href="JSONModel.html#with_repository-class_method" title="JSONModel.with_repository (method)">with_repository</a></span></p>
<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(backend = nil, state = nil, name)  &#x21d2; <tt><span class='object_link'><a href="" title="PUIIndexer (class)">PUIIndexer</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns a new instance of PUIIndexer</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'indexer/app/lib/pui_indexer.rb', line 17</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_initialize identifier id'>initialize</span><span class='lparen token'>(</span><span class='rubyid_backend identifier id'>backend</span> <span class='assign token'>=</span> <span class='rubyid_nil nil kw'>nil</span><span class='comma token'>,</span> <span class='rubyid_state identifier id'>state</span> <span class='assign token'>=</span> <span class='rubyid_nil nil kw'>nil</span><span class='comma token'>,</span> <span class='rubyid_name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='rubyid_state_class identifier id'>state_class</span> <span class='assign token'>=</span> <span class='rubyid_AppConfig constant id'>AppConfig</span><span class='lbrack token'>[</span><span class='symbol val'>:index_state_class</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_constantize identifier id'>constantize</span>
  <span class='rubyid_index_state identifier id'>index_state</span> <span class='assign token'>=</span> <span class='rubyid_state identifier id'>state</span> <span class='orop op'>||</span> <span class='rubyid_state_class identifier id'>state_class</span><span class='dot token'>.</span><span class='rubyid_new identifier id'>new</span><span class='lparen token'>(</span><span class='string val'>&quot;indexer_pui_state&quot;</span><span class='rparen token'>)</span>

  <span class='rubyid_super super kw'>super</span><span class='lparen token'>(</span><span class='rubyid_backend identifier id'>backend</span><span class='comma token'>,</span> <span class='rubyid_index_state identifier id'>index_state</span><span class='comma token'>,</span> <span class='rubyid_name identifier id'>name</span><span class='rparen token'>)</span>

  <span class='comment val'># Set up our JSON schemas now that we know the JSONModels have been loaded</span>
  <span class='rubyid_RecordInheritance constant id'>RecordInheritance</span><span class='dot token'>.</span><span class='rubyid_prepare_schemas identifier id'>prepare_schemas</span>

  <span class='rubyid_@time_to_sleep ivar id'>@time_to_sleep</span> <span class='assign token'>=</span> <span class='rubyid_AppConfig constant id'>AppConfig</span><span class='lbrack token'>[</span><span class='symbol val'>:pui_indexing_frequency_seconds</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_to_i identifier id'>to_i</span>
  <span class='rubyid_@thread_count ivar id'>@thread_count</span> <span class='assign token'>=</span> <span class='rubyid_AppConfig constant id'>AppConfig</span><span class='lbrack token'>[</span><span class='symbol val'>:pui_indexer_thread_count</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_to_i identifier id'>to_i</span>
  <span class='rubyid_@records_per_thread ivar id'>@records_per_thread</span> <span class='assign token'>=</span> <span class='rubyid_AppConfig constant id'>AppConfig</span><span class='lbrack token'>[</span><span class='symbol val'>:pui_indexer_records_per_thread</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_to_i identifier id'>to_i</span>

  <span class='rubyid_@unpublished_records ivar id'>@unpublished_records</span> <span class='assign token'>=</span> <span class='rubyid_java identifier id'>java</span><span class='dot token'>.</span><span class='rubyid_util identifier id'>util</span><span class='dot token'>.</span><span class='rubyid_Collections constant id'>Collections</span><span class='dot token'>.</span><span class='rubyid_synchronizedList identifier id'>synchronizedList</span><span class='lparen token'>(</span><span class='rubyid_java identifier id'>java</span><span class='dot token'>.</span><span class='rubyid_util identifier id'>util</span><span class='dot token'>.</span><span class='rubyid_ArrayList constant id'>ArrayList</span><span class='dot token'>.</span><span class='rubyid_new identifier id'>new</span><span class='rparen token'>)</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="get_indexer-class_method">
  
    .<strong>get_indexer</strong>(state = nil, name = &quot;PUI Indexer&quot;)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


42
43
44</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'indexer/app/lib/pui_indexer.rb', line 42</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_get_indexer identifier id'>get_indexer</span><span class='lparen token'>(</span><span class='rubyid_state identifier id'>state</span> <span class='assign token'>=</span> <span class='rubyid_nil nil kw'>nil</span><span class='comma token'>,</span> <span class='rubyid_name identifier id'>name</span> <span class='assign token'>=</span> <span class='string val'>&quot;PUI Indexer&quot;</span><span class='rparen token'>)</span>
  <span class='rubyid_indexer identifier id'>indexer</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_new identifier id'>new</span><span class='lparen token'>(</span><span class='rubyid_state identifier id'>state</span><span class='comma token'>,</span> <span class='rubyid_name identifier id'>name</span><span class='rparen token'>)</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="add_infscroll_docs-instance_method">
  
    #<strong>add_infscroll_docs</strong>(resource_uris, batch)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


103
104
105
106
107
108
109
110
111
112
113
114
115</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'indexer/app/lib/pui_indexer.rb', line 103</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_add_infscroll_docs identifier id'>add_infscroll_docs</span><span class='lparen token'>(</span><span class='rubyid_resource_uris identifier id'>resource_uris</span><span class='comma token'>,</span> <span class='rubyid_batch identifier id'>batch</span><span class='rparen token'>)</span>
  <span class='rubyid_resource_uris identifier id'>resource_uris</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_resource_uri identifier id'>resource_uri</span><span class='bitor op'>|</span>
    <span class='rubyid_json identifier id'>json</span> <span class='assign token'>=</span> <span class='rubyid_JSONModel constant id'>JSONModel</span><span class='colon2 op'>::</span><span class='rubyid_HTTP constant id'>HTTP</span><span class='dot token'>.</span><span class='rubyid_get_json identifier id'>get_json</span><span class='lparen token'>(</span><span class='rubyid_resource_uri identifier id'>resource_uri</span> <span class='plus op'>+</span> <span class='string val'>&#39;/ordered_records&#39;</span><span class='rparen token'>)</span>

    <span class='rubyid_batch identifier id'>batch</span> <span class='lshft op'>&lt;&lt;</span> <span class='lbrace token'>{</span>
      <span class='string val'>&#39;id&#39;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dstring node'>&quot;#{resource_uri}/ordered_records&quot;</span><span class='comma token'>,</span>
      <span class='string val'>&#39;pui_parent_id&#39;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_resource_uri identifier id'>resource_uri</span><span class='comma token'>,</span>
      <span class='string val'>&#39;publish&#39;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;true&quot;</span><span class='comma token'>,</span>
      <span class='string val'>&#39;primary_type&#39;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;resource_ordered_records&quot;</span><span class='comma token'>,</span>
      <span class='string val'>&#39;json&#39;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_ASUtils constant id'>ASUtils</span><span class='dot token'>.</span><span class='rubyid_to_json identifier id'>to_json</span><span class='lparen token'>(</span><span class='rubyid_json identifier id'>json</span><span class='rparen token'>)</span>
    <span class='rbrace token'>}</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="configure_doc_rules-instance_method">
  
    #<strong>configure_doc_rules</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'indexer/app/lib/pui_indexer.rb', line 56</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_configure_doc_rules identifier id'>configure_doc_rules</span>
  <span class='rubyid_super super kw'>super</span>

  <span class='rubyid_record_has_children identifier id'>record_has_children</span><span class='lparen token'>(</span><span class='string val'>&#39;resource&#39;</span><span class='rparen token'>)</span>
  <span class='rubyid_record_has_children identifier id'>record_has_children</span><span class='lparen token'>(</span><span class='string val'>&#39;archival_object&#39;</span><span class='rparen token'>)</span>
  <span class='rubyid_record_has_children identifier id'>record_has_children</span><span class='lparen token'>(</span><span class='string val'>&#39;digital_object&#39;</span><span class='rparen token'>)</span>
  <span class='rubyid_record_has_children identifier id'>record_has_children</span><span class='lparen token'>(</span><span class='string val'>&#39;digital_object_component&#39;</span><span class='rparen token'>)</span>
  <span class='rubyid_record_has_children identifier id'>record_has_children</span><span class='lparen token'>(</span><span class='string val'>&#39;classification&#39;</span><span class='rparen token'>)</span>
  <span class='rubyid_record_has_children identifier id'>record_has_children</span><span class='lparen token'>(</span><span class='string val'>&#39;classification_term&#39;</span><span class='rparen token'>)</span>


  <span class='rubyid_add_document_prepare_hook identifier id'>add_document_prepare_hook</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='rubyid_doc identifier id'>doc</span><span class='comma token'>,</span> <span class='rubyid_record identifier id'>record</span><span class='bitor op'>|</span>

    <span class='rubyid_if if kw'>if</span> <span class='rubyid_RecordInheritance constant id'>RecordInheritance</span><span class='dot token'>.</span><span class='rubyid_has_type? fid id'>has_type?</span><span class='lparen token'>(</span><span class='rubyid_doc identifier id'>doc</span><span class='lbrack token'>[</span><span class='string val'>&#39;primary_type&#39;</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
      <span class='rubyid_parent_id identifier id'>parent_id</span> <span class='assign token'>=</span> <span class='rubyid_doc identifier id'>doc</span><span class='lbrack token'>[</span><span class='string val'>&#39;id&#39;</span><span class='rbrack token'>]</span>
      <span class='rubyid_doc identifier id'>doc</span><span class='lbrack token'>[</span><span class='string val'>&#39;id&#39;</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;#{parent_id}#pui&quot;</span>
      <span class='rubyid_doc identifier id'>doc</span><span class='lbrack token'>[</span><span class='string val'>&#39;pui_parent_id&#39;</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rubyid_parent_id identifier id'>parent_id</span>
      <span class='rubyid_doc identifier id'>doc</span><span class='lbrack token'>[</span><span class='string val'>&#39;types&#39;</span><span class='rbrack token'>]</span> <span class='opasgn op'>||=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
      <span class='rubyid_doc identifier id'>doc</span><span class='lbrack token'>[</span><span class='string val'>&#39;types&#39;</span><span class='rbrack token'>]</span> <span class='lshft op'>&lt;&lt;</span> <span class='string val'>&#39;pui&#39;</span>
      <span class='rubyid_doc identifier id'>doc</span><span class='lbrack token'>[</span><span class='string val'>&#39;types&#39;</span><span class='rbrack token'>]</span> <span class='lshft op'>&lt;&lt;</span> <span class='dstring node'>&quot;pui_#{doc[&#39;primary_type&#39;]}&quot;</span>
      <span class='rubyid_doc identifier id'>doc</span><span class='lbrack token'>[</span><span class='string val'>&#39;types&#39;</span><span class='rbrack token'>]</span> <span class='lshft op'>&lt;&lt;</span> <span class='string val'>&#39;pui_record&#39;</span>
      <span class='rubyid_doc identifier id'>doc</span><span class='lbrack token'>[</span><span class='string val'>&#39;types&#39;</span><span class='rbrack token'>]</span> <span class='lshft op'>&lt;&lt;</span> <span class='string val'>&#39;pui_only&#39;</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rbrace token'>}</span>

  <span class='comment val'># this runs after the hooks in indexer_common, so we can overwrite with confidence</span>
  <span class='rubyid_add_document_prepare_hook identifier id'>add_document_prepare_hook</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='rubyid_doc identifier id'>doc</span><span class='comma token'>,</span> <span class='rubyid_record identifier id'>record</span><span class='bitor op'>|</span>
    <span class='rubyid_if if kw'>if</span> <span class='rubyid_RecordInheritance constant id'>RecordInheritance</span><span class='dot token'>.</span><span class='rubyid_has_type? fid id'>has_type?</span><span class='lparen token'>(</span><span class='rubyid_doc identifier id'>doc</span><span class='lbrack token'>[</span><span class='string val'>&#39;primary_type&#39;</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
      <span class='comment val'># special handling for json because we need to include indirectly inherited</span>
      <span class='comment val'># fields too - the json sent to indexer_common only has directly inherited</span>
      <span class='comment val'># fields because only they should be indexed.</span>
      <span class='comment val'># so we remerge without the :direct_only flag, and we remove the ancestors</span>
      <span class='rubyid_doc identifier id'>doc</span><span class='lbrack token'>[</span><span class='string val'>&#39;json&#39;</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rubyid_ASUtils constant id'>ASUtils</span><span class='dot token'>.</span><span class='rubyid_to_json identifier id'>to_json</span><span class='lparen token'>(</span><span class='rubyid_RecordInheritance constant id'>RecordInheritance</span><span class='dot token'>.</span><span class='rubyid_merge identifier id'>merge</span><span class='lparen token'>(</span><span class='rubyid_record identifier id'>record</span><span class='lbrack token'>[</span><span class='string val'>&#39;record&#39;</span><span class='rbrack token'>]</span><span class='comma token'>,</span>
                                                            <span class='symbol val'>:remove_ancestors</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span><span class='rparen token'>)</span>

      <span class='comment val'># special handling for title because it is populated from display_string</span>
      <span class='comment val'># in indexer_common and display_string is not changed in the merge process</span>
      <span class='rubyid_doc identifier id'>doc</span><span class='lbrack token'>[</span><span class='string val'>&#39;title&#39;</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rubyid_record identifier id'>record</span><span class='lbrack token'>[</span><span class='string val'>&#39;record&#39;</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='string val'>&#39;title&#39;</span><span class='rbrack token'>]</span> <span class='rubyid_if if_mod kw'>if</span> <span class='rubyid_record identifier id'>record</span><span class='lbrack token'>[</span><span class='string val'>&#39;record&#39;</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='string val'>&#39;title&#39;</span><span class='rbrack token'>]</span>

      <span class='comment val'># special handling for fullrecord because we don&#39;t want the ancestors indexed.</span>
      <span class='comment val'># we&#39;re now done with the ancestors, so we can just delete them from the record</span>
      <span class='rubyid_record identifier id'>record</span><span class='lbrack token'>[</span><span class='string val'>&#39;record&#39;</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_delete identifier id'>delete</span><span class='lparen token'>(</span><span class='string val'>&#39;ancestors&#39;</span><span class='rparen token'>)</span>
      <span class='rubyid_doc identifier id'>doc</span><span class='lbrack token'>[</span><span class='string val'>&#39;fullrecord&#39;</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rubyid_IndexerCommon constant id'>IndexerCommon</span><span class='dot token'>.</span><span class='rubyid_build_fullrecord identifier id'>build_fullrecord</span><span class='lparen token'>(</span><span class='rubyid_record identifier id'>record</span><span class='rparen token'>)</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rbrace token'>}</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="fetch_records-instance_method">
  
    #<strong>fetch_records</strong>(type, ids, resolve)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


33
34
35
36
37
38
39
40</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'indexer/app/lib/pui_indexer.rb', line 33</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_fetch_records identifier id'>fetch_records</span><span class='lparen token'>(</span><span class='rubyid_type identifier id'>type</span><span class='comma token'>,</span> <span class='rubyid_ids identifier id'>ids</span><span class='comma token'>,</span> <span class='rubyid_resolve identifier id'>resolve</span><span class='rparen token'>)</span>
  <span class='rubyid_records identifier id'>records</span> <span class='assign token'>=</span> <span class='rubyid_JSONModel constant id'>JSONModel</span><span class='lparen token'>(</span><span class='rubyid_type identifier id'>type</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_all identifier id'>all</span><span class='lparen token'>(</span><span class='symbol val'>:id_set</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_ids identifier id'>ids</span><span class='dot token'>.</span><span class='rubyid_join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>&quot;,&quot;</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='string val'>&#39;resolve[]&#39;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_resolve identifier id'>resolve</span><span class='rparen token'>)</span>
  <span class='rubyid_if if kw'>if</span> <span class='rubyid_RecordInheritance constant id'>RecordInheritance</span><span class='dot token'>.</span><span class='rubyid_has_type? fid id'>has_type?</span><span class='lparen token'>(</span><span class='rubyid_type identifier id'>type</span><span class='rparen token'>)</span>
    <span class='rubyid_RecordInheritance constant id'>RecordInheritance</span><span class='dot token'>.</span><span class='rubyid_merge identifier id'>merge</span><span class='lparen token'>(</span><span class='rubyid_records identifier id'>records</span><span class='comma token'>,</span> <span class='symbol val'>:direct_only</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
  <span class='rubyid_else else kw'>else</span>
    <span class='rubyid_records identifier id'>records</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="index_round_complete-instance_method">
  
    #<strong>index_round_complete</strong>(repository)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'indexer/app/lib/pui_indexer.rb', line 134</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_index_round_complete identifier id'>index_round_complete</span><span class='lparen token'>(</span><span class='rubyid_repository identifier id'>repository</span><span class='rparen token'>)</span>
  <span class='comment val'># Index any trees in `repository`</span>
  <span class='rubyid_tree_types identifier id'>tree_types</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='lbrack token'>[</span><span class='symbol val'>:resource</span><span class='comma token'>,</span> <span class='symbol val'>:archival_object</span><span class='rbrack token'>]</span><span class='comma token'>,</span>
                <span class='lbrack token'>[</span><span class='symbol val'>:digital_object</span><span class='comma token'>,</span> <span class='symbol val'>:digital_object_component</span><span class='rbrack token'>]</span><span class='comma token'>,</span>
                <span class='lbrack token'>[</span><span class='symbol val'>:classification</span><span class='comma token'>,</span> <span class='symbol val'>:classification_term</span><span class='rbrack token'>]</span><span class='rbrack token'>]</span>

  <span class='rubyid_start identifier id'>start</span> <span class='assign token'>=</span> <span class='rubyid_Time constant id'>Time</span><span class='dot token'>.</span><span class='rubyid_now identifier id'>now</span>
  <span class='rubyid_checkpoints identifier id'>checkpoints</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>

  <span class='rubyid_tree_uris identifier id'>tree_uris</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>

  <span class='rubyid_tree_types identifier id'>tree_types</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_pair identifier id'>pair</span><span class='bitor op'>|</span>
    <span class='rubyid_root_type identifier id'>root_type</span> <span class='assign token'>=</span> <span class='rubyid_pair identifier id'>pair</span><span class='dot token'>.</span><span class='rubyid_first identifier id'>first</span>
    <span class='rubyid_node_type identifier id'>node_type</span> <span class='assign token'>=</span> <span class='rubyid_pair identifier id'>pair</span><span class='dot token'>.</span><span class='rubyid_last identifier id'>last</span>

    <span class='rubyid_checkpoints identifier id'>checkpoints</span> <span class='lshft op'>&lt;&lt;</span> <span class='lbrack token'>[</span><span class='rubyid_repository identifier id'>repository</span><span class='comma token'>,</span> <span class='rubyid_root_type identifier id'>root_type</span><span class='comma token'>,</span> <span class='rubyid_start identifier id'>start</span><span class='rbrack token'>]</span>
    <span class='rubyid_checkpoints identifier id'>checkpoints</span> <span class='lshft op'>&lt;&lt;</span> <span class='lbrack token'>[</span><span class='rubyid_repository identifier id'>repository</span><span class='comma token'>,</span> <span class='rubyid_node_type identifier id'>node_type</span><span class='comma token'>,</span> <span class='rubyid_start identifier id'>start</span><span class='rbrack token'>]</span>

    <span class='rubyid_last_root_node_mtime identifier id'>last_root_node_mtime</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rubyid_@state ivar id'>@state</span><span class='dot token'>.</span><span class='rubyid_get_last_mtime identifier id'>get_last_mtime</span><span class='lparen token'>(</span><span class='rubyid_repository identifier id'>repository</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span><span class='comma token'>,</span> <span class='rubyid_root_type identifier id'>root_type</span><span class='rparen token'>)</span> <span class='minus op'>-</span> <span class='rubyid_@window_seconds ivar id'>@window_seconds</span><span class='comma token'>,</span> <span class='integer val'>0</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_max identifier id'>max</span>
    <span class='rubyid_last_node_mtime identifier id'>last_node_mtime</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rubyid_@state ivar id'>@state</span><span class='dot token'>.</span><span class='rubyid_get_last_mtime identifier id'>get_last_mtime</span><span class='lparen token'>(</span><span class='rubyid_repository identifier id'>repository</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span><span class='comma token'>,</span> <span class='rubyid_node_type identifier id'>node_type</span><span class='rparen token'>)</span> <span class='minus op'>-</span> <span class='rubyid_@window_seconds ivar id'>@window_seconds</span><span class='comma token'>,</span> <span class='integer val'>0</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_max identifier id'>max</span>

    <span class='rubyid_root_node_ids identifier id'>root_node_ids</span> <span class='assign token'>=</span> <span class='rubyid_Set constant id'>Set</span><span class='dot token'>.</span><span class='rubyid_new identifier id'>new</span><span class='lparen token'>(</span><span class='rubyid_JSONModel constant id'>JSONModel</span><span class='colon2 op'>::</span><span class='rubyid_HTTP constant id'>HTTP</span><span class='dot token'>.</span><span class='rubyid_get_json identifier id'>get_json</span><span class='lparen token'>(</span><span class='rubyid_JSONModel constant id'>JSONModel</span><span class='lparen token'>(</span><span class='rubyid_root_type identifier id'>root_type</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_uri_for identifier id'>uri_for</span><span class='comma token'>,</span> <span class='symbol val'>:all_ids</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span><span class='comma token'>,</span> <span class='symbol val'>:modified_since</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_last_root_node_mtime identifier id'>last_root_node_mtime</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
    <span class='rubyid_node_ids identifier id'>node_ids</span> <span class='assign token'>=</span> <span class='rubyid_JSONModel constant id'>JSONModel</span><span class='colon2 op'>::</span><span class='rubyid_HTTP constant id'>HTTP</span><span class='dot token'>.</span><span class='rubyid_get_json identifier id'>get_json</span><span class='lparen token'>(</span><span class='rubyid_JSONModel constant id'>JSONModel</span><span class='lparen token'>(</span><span class='rubyid_node_type identifier id'>node_type</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_uri_for identifier id'>uri_for</span><span class='comma token'>,</span> <span class='symbol val'>:all_ids</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span><span class='comma token'>,</span> <span class='symbol val'>:modified_since</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_last_node_mtime identifier id'>last_node_mtime</span><span class='rparen token'>)</span>

    <span class='rubyid_node_ids identifier id'>node_ids</span><span class='dot token'>.</span><span class='rubyid_each_slice identifier id'>each_slice</span><span class='lparen token'>(</span><span class='rubyid_@records_per_thread ivar id'>@records_per_thread</span><span class='rparen token'>)</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_ids identifier id'>ids</span><span class='bitor op'>|</span>
      <span class='rubyid_node_records identifier id'>node_records</span> <span class='assign token'>=</span> <span class='rubyid_JSONModel constant id'>JSONModel</span><span class='lparen token'>(</span><span class='rubyid_node_type identifier id'>node_type</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_all identifier id'>all</span><span class='lparen token'>(</span><span class='symbol val'>:id_set</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_ids identifier id'>ids</span><span class='dot token'>.</span><span class='rubyid_join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>&quot;,&quot;</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='string val'>&#39;resolve[]&#39;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>

      <span class='rubyid_node_records identifier id'>node_records</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_record identifier id'>record</span><span class='bitor op'>|</span>
        <span class='rubyid_root_node_ids identifier id'>root_node_ids</span> <span class='lshft op'>&lt;&lt;</span> <span class='rubyid_JSONModel constant id'>JSONModel</span><span class='dot token'>.</span><span class='rubyid_parse_reference identifier id'>parse_reference</span><span class='lparen token'>(</span><span class='rubyid_record identifier id'>record</span><span class='lbrack token'>[</span><span class='rubyid_root_type identifier id'>root_type</span><span class='dot token'>.</span><span class='rubyid_to_s identifier id'>to_s</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='string val'>&#39;ref&#39;</span><span class='rbrack token'>]</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_fetch identifier id'>fetch</span><span class='lparen token'>(</span><span class='symbol val'>:id</span><span class='rparen token'>)</span>
      <span class='rubyid_end end kw'>end</span>
    <span class='rubyid_end end kw'>end</span>

    <span class='rubyid_tree_uris identifier id'>tree_uris</span><span class='dot token'>.</span><span class='rubyid_concat identifier id'>concat</span><span class='lparen token'>(</span><span class='rubyid_root_node_ids identifier id'>root_node_ids</span><span class='dot token'>.</span><span class='rubyid_map identifier id'>map</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='rubyid_id identifier id'>id</span><span class='bitor op'>|</span> <span class='rubyid_JSONModel constant id'>JSONModel</span><span class='lparen token'>(</span><span class='rubyid_root_type identifier id'>root_type</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_uri_for identifier id'>uri_for</span><span class='lparen token'>(</span><span class='rubyid_id identifier id'>id</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_batch identifier id'>batch</span> <span class='assign token'>=</span> <span class='rubyid_IndexBatch constant id'>IndexBatch</span><span class='dot token'>.</span><span class='rubyid_new identifier id'>new</span>

  <span class='rubyid_add_infscroll_docs identifier id'>add_infscroll_docs</span><span class='lparen token'>(</span><span class='rubyid_tree_uris identifier id'>tree_uris</span><span class='dot token'>.</span><span class='rubyid_select identifier id'>select</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='rubyid_uri identifier id'>uri</span><span class='bitor op'>|</span> <span class='rubyid_JSONModel constant id'>JSONModel</span><span class='dot token'>.</span><span class='rubyid_parse_reference identifier id'>parse_reference</span><span class='lparen token'>(</span><span class='rubyid_uri identifier id'>uri</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_fetch identifier id'>fetch</span><span class='lparen token'>(</span><span class='symbol val'>:type</span><span class='rparen token'>)</span> <span class='eq op'>==</span> <span class='string val'>&#39;resource&#39;</span><span class='rbrace token'>}</span><span class='comma token'>,</span>
                     <span class='rubyid_batch identifier id'>batch</span><span class='rparen token'>)</span>

  <span class='rubyid_tree_indexer identifier id'>tree_indexer</span> <span class='assign token'>=</span> <span class='rubyid_LargeTreeDocIndexer constant id'>LargeTreeDocIndexer</span><span class='dot token'>.</span><span class='rubyid_new identifier id'>new</span><span class='lparen token'>(</span><span class='rubyid_batch identifier id'>batch</span><span class='rparen token'>)</span>
  <span class='rubyid_tree_indexer identifier id'>tree_indexer</span><span class='dot token'>.</span><span class='rubyid_add_largetree_docs identifier id'>add_largetree_docs</span><span class='lparen token'>(</span><span class='rubyid_tree_uris identifier id'>tree_uris</span><span class='rparen token'>)</span>

  <span class='rubyid_if if kw'>if</span> <span class='rubyid_batch identifier id'>batch</span><span class='dot token'>.</span><span class='rubyid_length identifier id'>length</span> <span class='gt op'>&gt;</span> <span class='integer val'>0</span>
    <span class='rubyid_log identifier id'>log</span> <span class='dstring node'>&quot;Indexed #{batch.length} additional PUI records in repository #{repository.repo_code}&quot;</span>

    <span class='rubyid_index_batch identifier id'>index_batch</span><span class='lparen token'>(</span><span class='rubyid_batch identifier id'>batch</span><span class='comma token'>,</span> <span class='rubyid_nil nil kw'>nil</span><span class='comma token'>,</span> <span class='symbol val'>:parent_id_field</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&#39;pui_parent_id&#39;</span><span class='rparen token'>)</span>
    <span class='rubyid_send_commit identifier id'>send_commit</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_if if kw'>if</span> <span class='rubyid_tree_indexer identifier id'>tree_indexer</span><span class='dot token'>.</span><span class='rubyid_deletes identifier id'>deletes</span><span class='dot token'>.</span><span class='rubyid_length identifier id'>length</span> <span class='gt op'>&gt;</span> <span class='integer val'>0</span>
    <span class='rubyid_tree_indexer identifier id'>tree_indexer</span><span class='dot token'>.</span><span class='rubyid_deletes identifier id'>deletes</span><span class='dot token'>.</span><span class='rubyid_each_slice identifier id'>each_slice</span><span class='lparen token'>(</span><span class='integer val'>100</span><span class='rparen token'>)</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_deletes identifier id'>deletes</span><span class='bitor op'>|</span>
      <span class='rubyid_delete_records identifier id'>delete_records</span><span class='lparen token'>(</span><span class='rubyid_deletes identifier id'>deletes</span><span class='comma token'>,</span> <span class='symbol val'>:parent_id_field</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&#39;pui_parent_id&#39;</span><span class='rparen token'>)</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_handle_deletes identifier id'>handle_deletes</span><span class='lparen token'>(</span><span class='symbol val'>:parent_id_field</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&#39;pui_parent_id&#39;</span><span class='rparen token'>)</span>

  <span class='comment val'># Delete any unpublished records and decendents</span>
  <span class='rubyid_delete_records identifier id'>delete_records</span><span class='lparen token'>(</span><span class='rubyid_@unpublished_records ivar id'>@unpublished_records</span><span class='comma token'>,</span> <span class='symbol val'>:parent_id_field</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&#39;pui_parent_id&#39;</span><span class='rparen token'>)</span>
  <span class='rubyid_@unpublished_records ivar id'>@unpublished_records</span><span class='dot token'>.</span><span class='rubyid_clear identifier id'>clear</span><span class='lparen token'>(</span><span class='rparen token'>)</span>

  <span class='rubyid_checkpoints identifier id'>checkpoints</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_repository identifier id'>repository</span><span class='comma token'>,</span> <span class='rubyid_type identifier id'>type</span><span class='comma token'>,</span> <span class='rubyid_start identifier id'>start</span><span class='bitor op'>|</span>
    <span class='rubyid_@state ivar id'>@state</span><span class='dot token'>.</span><span class='rubyid_set_last_mtime identifier id'>set_last_mtime</span><span class='lparen token'>(</span><span class='rubyid_repository identifier id'>repository</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span><span class='comma token'>,</span> <span class='rubyid_type identifier id'>type</span><span class='comma token'>,</span> <span class='rubyid_start identifier id'>start</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>

<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="record_types-instance_method">
  
    #<strong>record_types</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


50
51
52
53
54</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'indexer/app/lib/pui_indexer.rb', line 50</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_record_types identifier id'>record_types</span>
  <span class='comment val'># We only want to index the record types we&#39;re going to make separate</span>
  <span class='comment val'># PUI-specific versions of...</span>
  <span class='lparen token'>(</span><span class='rubyid_super super kw'>super</span><span class='dot token'>.</span><span class='rubyid_select identifier id'>select</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='rubyid_type identifier id'>type</span><span class='bitor op'>|</span> <span class='rubyid_RecordInheritance constant id'>RecordInheritance</span><span class='dot token'>.</span><span class='rubyid_has_type? fid id'>has_type?</span><span class='lparen token'>(</span><span class='rubyid_type identifier id'>type</span><span class='rparen token'>)</span><span class='rbrace token'>}</span> <span class='plus op'>+</span> <span class='lbrack token'>[</span><span class='symbol val'>:archival_object</span><span class='rbrack token'>]</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_uniq identifier id'>uniq</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="resolved_attributes-instance_method">
  
    #<strong>resolved_attributes</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


46
47
48</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'indexer/app/lib/pui_indexer.rb', line 46</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_resolved_attributes identifier id'>resolved_attributes</span>
  <span class='rubyid_super super kw'>super</span> <span class='plus op'>+</span> <span class='rubyid_PUI_RESOLVES constant id'>PUI_RESOLVES</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="skip_index_doc?-instance_method">
  
    #<strong>skip_index_doc?</strong>(doc)  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


126
127
128
129
130
131
132</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'indexer/app/lib/pui_indexer.rb', line 126</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_skip_index_doc? fid id'>skip_index_doc?</span><span class='lparen token'>(</span><span class='rubyid_doc identifier id'>doc</span><span class='rparen token'>)</span>
  <span class='rubyid_published identifier id'>published</span> <span class='assign token'>=</span> <span class='rubyid_doc identifier id'>doc</span><span class='lbrack token'>[</span><span class='string val'>&#39;publish&#39;</span><span class='rbrack token'>]</span>

  <span class='rubyid_stage_unpublished_for_deletion identifier id'>stage_unpublished_for_deletion</span><span class='lparen token'>(</span><span class='rubyid_doc identifier id'>doc</span><span class='lbrack token'>[</span><span class='string val'>&#39;id&#39;</span><span class='rbrack token'>]</span><span class='rparen token'>)</span> <span class='rubyid_unless unless_mod kw'>unless</span> <span class='rubyid_published identifier id'>published</span>

  <span class='notop op'>!</span><span class='rubyid_published identifier id'>published</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="skip_index_record?-instance_method">
  
    #<strong>skip_index_record?</strong>(record)  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


117
118
119
120
121
122
123</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'indexer/app/lib/pui_indexer.rb', line 117</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_skip_index_record? fid id'>skip_index_record?</span><span class='lparen token'>(</span><span class='rubyid_record identifier id'>record</span><span class='rparen token'>)</span>
  <span class='rubyid_published identifier id'>published</span> <span class='assign token'>=</span> <span class='rubyid_record identifier id'>record</span><span class='lbrack token'>[</span><span class='string val'>&#39;record&#39;</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='string val'>&#39;publish&#39;</span><span class='rbrack token'>]</span>

  <span class='rubyid_stage_unpublished_for_deletion identifier id'>stage_unpublished_for_deletion</span><span class='lparen token'>(</span><span class='dstring node'>&quot;#{record[&#39;record&#39;][&#39;uri&#39;]}#pui&quot;</span><span class='rparen token'>)</span> <span class='rubyid_unless unless_mod kw'>unless</span> <span class='rubyid_published identifier id'>published</span>

  <span class='notop op'>!</span><span class='rubyid_published identifier id'>published</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="stage_unpublished_for_deletion-instance_method">
  
    #<strong>stage_unpublished_for_deletion</strong>(doc_id)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


202
203
204</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'indexer/app/lib/pui_indexer.rb', line 202</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_stage_unpublished_for_deletion identifier id'>stage_unpublished_for_deletion</span><span class='lparen token'>(</span><span class='rubyid_doc_id identifier id'>doc_id</span><span class='rparen token'>)</span>
  <span class='rubyid_@unpublished_records ivar id'>@unpublished_records</span><span class='dot token'>.</span><span class='rubyid_add identifier id'>add</span><span class='lparen token'>(</span><span class='rubyid_doc_id identifier id'>doc_id</span><span class='rparen token'>)</span> <span class='rubyid_if if_mod kw'>if</span> <span class='rubyid_doc_id identifier id'>doc_id</span> <span class='match op'>=~</span> <span class='regexp val'>/#pui$/</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  ArchivesSpace Version v2.7.1.a Documentation Generated on Fri Feb 14 11:31:51 2020 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.20.
</div>

    </div>
  </body>
</html>