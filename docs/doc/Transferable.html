<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: Transferable
  
    &mdash; Documentation by YARD 0.9.0
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "Transferable";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="class_list.html"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index (T)</a> &raquo;
    
    
    <span class="title">Transferable</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <iframe id="search_frame" src="class_list.html"></iframe>

      <div id="content"><h1>Module: Transferable
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  
  <dl>
    <dt>Included in:</dt>
    <dd><span class='object_link'><a href="Accession.html" title="Accession (class)">Accession</a></span>, <span class='object_link'><a href="ArchivalObject.html" title="ArchivalObject (class)">ArchivalObject</a></span>, <span class='object_link'><a href="Resource.html" title="Resource (class)">Resource</a></span></dd>
  </dl>
  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>backend/app/model/mixins/transferable.rb</dd>
  </dl>
  
</div>








  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#transfer_to_repository-instance_method" title="#transfer_to_repository (instance method)">#<strong>transfer_to_repository</strong>(repository, transfer_group = [])  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
    </ul>
  



  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="transfer_to_repository-instance_method">
  
    #<strong>transfer_to_repository</strong>(repository, transfer_group = [])  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/mixins/transferable.rb', line 3</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_transfer_to_repository identifier id'>transfer_to_repository</span><span class='lparen token'>(</span><span class='rubyid_repository identifier id'>repository</span><span class='comma token'>,</span> <span class='rubyid_transfer_group identifier id'>transfer_group</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
  <span class='rubyid_events_to_clone identifier id'>events_to_clone</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
  <span class='rubyid_containers_to_clone identifier id'>containers_to_clone</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>

  <span class='rubyid_graph identifier id'>graph</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_object_graph identifier id'>object_graph</span>

  <span class='comment val'>## Digital object instances will trigger their linked digital objects to</span>
  <span class='comment val'>## transfer too, as long as those digital objects aren't linked to by other</span>
  <span class='comment val'>## records.</span>

  <span class='comment val'># We skip over tree nodes because the root record will take care of</span>
  <span class='comment val'># transferring their linked digital objects.</span>
  <span class='rubyid_unless unless kw'>unless</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_included_modules identifier id'>included_modules</span><span class='dot token'>.</span><span class='rubyid_include? fid id'>include?</span><span class='lparen token'>(</span><span class='rubyid_TreeNodes constant id'>TreeNodes</span><span class='rparen token'>)</span>
    <span class='rubyid_do_instance_relationship identifier id'>do_instance_relationship</span> <span class='assign token'>=</span> <span class='rubyid_Instance constant id'>Instance</span><span class='dot token'>.</span><span class='rubyid_find_relationship identifier id'>find_relationship</span><span class='lparen token'>(</span><span class='symbol val'>:instance_do_link</span><span class='rparen token'>)</span>

    <span class='comment val'># The list of instance record IDs connected to our transferee</span>
    <span class='rubyid_instance_ids identifier id'>instance_ids</span> <span class='assign token'>=</span> <span class='rubyid_graph identifier id'>graph</span><span class='dot token'>.</span><span class='rubyid_ids_for identifier id'>ids_for</span><span class='lparen token'>(</span><span class='rubyid_Instance constant id'>Instance</span><span class='rparen token'>)</span>

    <span class='comment val'># The list of digital objects our transferee links to</span>
    <span class='rubyid_linked_digital_objects identifier id'>linked_digital_objects</span> <span class='assign token'>=</span> <span class='rubyid_do_instance_relationship identifier id'>do_instance_relationship</span>
                             <span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_graph identifier id'>graph</span><span class='dot token'>.</span><span class='rubyid_ids_for identifier id'>ids_for</span><span class='lparen token'>(</span><span class='rubyid_do_instance_relationship identifier id'>do_instance_relationship</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
                             <span class='dot token'>.</span><span class='rubyid_select identifier id'>select</span><span class='lparen token'>(</span><span class='symbol val'>:digital_object_id</span><span class='rparen token'>)</span>
                             <span class='dot token'>.</span><span class='rubyid_map identifier id'>map</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='rubyid_row identifier id'>row</span><span class='bitor op'>|</span> <span class='rubyid_row identifier id'>row</span><span class='lbrack token'>[</span><span class='symbol val'>:digital_object_id</span><span class='rbrack token'>]</span><span class='rbrace token'>}</span>

    <span class='comment val'># The list of instance IDs that link to those digital objects (which may or</span>
    <span class='comment val'># may not be connected to our transferee)</span>
    <span class='rubyid_instances_referencing_digital_objects identifier id'>instances_referencing_digital_objects</span> <span class='assign token'>=</span> <span class='rubyid_do_instance_relationship identifier id'>do_instance_relationship</span>
                                            <span class='dot token'>.</span><span class='rubyid_find_by_participant_ids identifier id'>find_by_participant_ids</span><span class='lparen token'>(</span><span class='rubyid_DigitalObject constant id'>DigitalObject</span><span class='comma token'>,</span> <span class='rubyid_linked_digital_objects identifier id'>linked_digital_objects</span><span class='rparen token'>)</span>
                                            <span class='dot token'>.</span><span class='rubyid_map identifier id'>map</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='rubyid_r identifier id'>r</span><span class='bitor op'>|</span> <span class='rubyid_r identifier id'>r</span><span class='dot token'>.</span><span class='rubyid_instance_id identifier id'>instance_id</span><span class='rbrace token'>}</span>


    <span class='rubyid_linked_instances_outside_transfer_set identifier id'>linked_instances_outside_transfer_set</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='rubyid_instances_referencing_digital_objects identifier id'>instances_referencing_digital_objects</span> <span class='minus op'>-</span> <span class='rubyid_instance_ids identifier id'>instance_ids</span><span class='rparen token'>)</span>

    <span class='rubyid_if if kw'>if</span> <span class='rubyid_linked_instances_outside_transfer_set identifier id'>linked_instances_outside_transfer_set</span><span class='dot token'>.</span><span class='rubyid_empty? fid id'>empty?</span>
      <span class='comment val'># Our record to be transferred is the only thing referencing the digital</span>
      <span class='comment val'># objects it links to.  We can safely migrate them as well.</span>

      <span class='rubyid_DigitalObject constant id'>DigitalObject</span><span class='dot token'>.</span><span class='rubyid_any_repo identifier id'>any_repo</span><span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_linked_digital_objects identifier id'>linked_digital_objects</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_digital_object identifier id'>digital_object</span><span class='bitor op'>|</span>
        <span class='rubyid_digital_object identifier id'>digital_object</span><span class='dot token'>.</span><span class='rubyid_transfer_to_repository identifier id'>transfer_to_repository</span><span class='lparen token'>(</span><span class='rubyid_repository identifier id'>repository</span><span class='comma token'>,</span> <span class='rubyid_transfer_group identifier id'>transfer_group</span> <span class='plus op'>+</span> <span class='lbrack token'>[</span><span class='rubyid_self self kw'>self</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
      <span class='rubyid_end end kw'>end</span>
    <span class='rubyid_else else kw'>else</span>
      <span class='comment val'># Abort the transfer and provide the list of top-level records that are</span>
      <span class='comment val'># preventing it from completing.</span>
      <span class='rubyid_exception identifier id'>exception</span> <span class='assign token'>=</span> <span class='rubyid_TransferConstraintError constant id'>TransferConstraintError</span><span class='dot token'>.</span><span class='rubyid_new identifier id'>new</span>

      <span class='rubyid_ASModel constant id'>ASModel</span><span class='dot token'>.</span><span class='rubyid_all_models identifier id'>all_models</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_model identifier id'>model</span><span class='bitor op'>|</span>
        <span class='rubyid_next next kw'>next</span> <span class='rubyid_unless unless_mod kw'>unless</span> <span class='rubyid_model identifier id'>model</span><span class='dot token'>.</span><span class='rubyid_associations identifier id'>associations</span><span class='dot token'>.</span><span class='rubyid_include? fid id'>include?</span><span class='lparen token'>(</span><span class='symbol val'>:instance</span><span class='rparen token'>)</span>

        <span class='rubyid_model identifier id'>model</span>
          <span class='dot token'>.</span><span class='rubyid_eager_graph identifier id'>eager_graph</span><span class='lparen token'>(</span><span class='symbol val'>:instance</span><span class='rparen token'>)</span>
          <span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:instance__id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_linked_instances_outside_transfer_set identifier id'>linked_instances_outside_transfer_set</span><span class='rparen token'>)</span>
          <span class='dot token'>.</span><span class='rubyid_select identifier id'>select</span><span class='lparen token'>(</span><span class='rubyid_Sequel constant id'>Sequel</span><span class='dot token'>.</span><span class='rubyid_qualify identifier id'>qualify</span><span class='lparen token'>(</span><span class='rubyid_model identifier id'>model</span><span class='dot token'>.</span><span class='rubyid_table_name identifier id'>table_name</span><span class='comma token'>,</span> <span class='symbol val'>:id</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
          <span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_row identifier id'>row</span><span class='bitor op'>|</span>
          <span class='rubyid_exception identifier id'>exception</span><span class='dot token'>.</span><span class='rubyid_add_conflict identifier id'>add_conflict</span><span class='lparen token'>(</span><span class='rubyid_model identifier id'>model</span><span class='dot token'>.</span><span class='rubyid_my_jsonmodel identifier id'>my_jsonmodel</span><span class='dot token'>.</span><span class='rubyid_uri_for identifier id'>uri_for</span><span class='lparen token'>(</span><span class='rubyid_row identifier id'>row</span><span class='lbrack token'>[</span><span class='symbol val'>:id</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='symbol val'>:repo_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_active_repository identifier id'>active_repository</span><span class='rparen token'>)</span><span class='comma token'>,</span>
                                 <span class='lbrace token'>{</span><span class='symbol val'>:json_property</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'instances'</span><span class='comma token'>,</span>
                                  <span class='symbol val'>:message</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;DIGITAL_OBJECT_IN_USE&quot;</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
        <span class='rubyid_end end kw'>end</span>
      <span class='rubyid_end end kw'>end</span>

      <span class='rubyid_raise identifier id'>raise</span> <span class='rubyid_exception identifier id'>exception</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='comment val'>## Event records will be transferred if they only link to records that are</span>
  <span class='comment val'>## being transferred too.  Otherwise, we clone the event.</span>
  <span class='rubyid_Event constant id'>Event</span><span class='dot token'>.</span><span class='rubyid_find_relationship identifier id'>find_relationship</span><span class='lparen token'>(</span><span class='symbol val'>:event_link</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_who_participates_with identifier id'>who_participates_with</span><span class='lparen token'>(</span><span class='rubyid_self self kw'>self</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_event identifier id'>event</span><span class='bitor op'>|</span>
    <span class='rubyid_linked_records identifier id'>linked_records</span> <span class='assign token'>=</span> <span class='rubyid_event identifier id'>event</span><span class='dot token'>.</span><span class='rubyid_related_records identifier id'>related_records</span><span class='lparen token'>(</span><span class='symbol val'>:event_link</span><span class='rparen token'>)</span>

    <span class='rubyid_if if kw'>if</span> <span class='rubyid_linked_records identifier id'>linked_records</span><span class='dot token'>.</span><span class='rubyid_length identifier id'>length</span> <span class='eq op'>==</span> <span class='integer val'>1</span>
      <span class='comment val'># Events whose linked_records list contains only the record being</span>
      <span class='comment val'># transferred should themselves be transferred.</span>
      <span class='rubyid_event identifier id'>event</span><span class='dot token'>.</span><span class='rubyid_transfer_to_repository identifier id'>transfer_to_repository</span><span class='lparen token'>(</span><span class='rubyid_repository identifier id'>repository</span><span class='comma token'>,</span> <span class='rubyid_transfer_group identifier id'>transfer_group</span> <span class='plus op'>+</span> <span class='lbrack token'>[</span><span class='rubyid_self self kw'>self</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
    <span class='rubyid_else else kw'>else</span>
      <span class='rubyid_event_json identifier id'>event_json</span> <span class='assign token'>=</span> <span class='rubyid_Event constant id'>Event</span><span class='dot token'>.</span><span class='rubyid_to_jsonmodel identifier id'>to_jsonmodel</span><span class='lparen token'>(</span><span class='rubyid_event identifier id'>event</span><span class='rparen token'>)</span>
      <span class='rubyid_event_role identifier id'>event_role</span> <span class='assign token'>=</span> <span class='rubyid_event_json identifier id'>event_json</span><span class='dot token'>.</span><span class='rubyid_linked_records identifier id'>linked_records</span><span class='dot token'>.</span><span class='rubyid_find identifier id'>find</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='rubyid_link identifier id'>link</span><span class='bitor op'>|</span> <span class='rubyid_link identifier id'>link</span><span class='lbrack token'>[</span><span class='string val'>'ref'</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_uri identifier id'>uri</span><span class='rbrace token'>}</span><span class='lbrack token'>[</span><span class='string val'>'role'</span><span class='rbrack token'>]</span>

      <span class='rubyid_events_to_clone identifier id'>events_to_clone</span> <span class='lshft op'>&lt;&lt;</span> <span class='lbrace token'>{</span><span class='symbol val'>:event</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_event_json identifier id'>event_json</span><span class='comma token'>,</span> <span class='symbol val'>:role</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_event_role identifier id'>event_role</span><span class='rbrace token'>}</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='comment val'>## Transfer any top containers that aren't linked outside of the record set</span>
  <span class='comment val'>## being cloned.  For any other linked top containers, we'll clone them in</span>
  <span class='comment val'>## the target repository (much like events).</span>

  <span class='comment val'># the relationship between SC and TCs</span>
  <span class='rubyid_topcon_rlshp identifier id'>topcon_rlshp</span> <span class='assign token'>=</span> <span class='rubyid_SubContainer constant id'>SubContainer</span><span class='dot token'>.</span><span class='rubyid_find_relationship identifier id'>find_relationship</span><span class='lparen token'>(</span><span class='symbol val'>:top_container_link</span><span class='rparen token'>)</span>
  <span class='comment val'># now we get  all the relationships in this graph</span>
  <span class='rubyid_all_ids identifier id'>all_ids</span> <span class='assign token'>=</span> <span class='rubyid_graph identifier id'>graph</span><span class='dot token'>.</span><span class='rubyid_ids_for identifier id'>ids_for</span><span class='lparen token'>(</span><span class='rubyid_topcon_rlshp identifier id'>topcon_rlshp</span><span class='rparen token'>)</span>

  <span class='rubyid_DB constant id'>DB</span><span class='dot token'>.</span><span class='rubyid_open identifier id'>open</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_db identifier id'>db</span><span class='bitor op'>|</span>
    <span class='comment val'># Find relationships that are in our set of IDs that haven't been</span>
    <span class='comment val'># transferred yet</span>
    <span class='rubyid_db identifier id'>db</span><span class='lbrack token'>[</span><span class='symbol val'>:top_container_link_rlshp</span><span class='rbrack token'>]</span>
      <span class='dot token'>.</span><span class='rubyid_join identifier id'>join</span><span class='lparen token'>(</span><span class='symbol val'>:top_container</span><span class='comma token'>,</span> <span class='symbol val'>:id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:top_container_id</span><span class='rparen token'>)</span>
      <span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:top_container_link_rlshp__id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_all_ids identifier id'>all_ids</span><span class='rparen token'>)</span>
      <span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:top_container__repo_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_active_repository identifier id'>active_repository</span><span class='rparen token'>)</span>
      <span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_tc_rel identifier id'>tc_rel</span><span class='bitor op'>|</span>
      <span class='comment val'># lets get all the top_containers outside this graph</span>
      <span class='rubyid_number_of_tc_links identifier id'>number_of_tc_links</span> <span class='assign token'>=</span> <span class='rubyid_db identifier id'>db</span><span class='lbrack token'>[</span><span class='symbol val'>:top_container_link_rlshp</span><span class='rbrack token'>]</span>
                           <span class='dot token'>.</span><span class='rubyid_join identifier id'>join</span><span class='lparen token'>(</span><span class='symbol val'>:top_container</span><span class='comma token'>,</span> <span class='symbol val'>:id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:top_container_id</span><span class='rparen token'>)</span>
                           <span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:top_container__repo_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_active_repository identifier id'>active_repository</span><span class='rparen token'>)</span>
                           <span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lparen token'>(</span><span class='symbol val'>:top_container_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_tc_rel identifier id'>tc_rel</span><span class='lbrack token'>[</span><span class='symbol val'>:top_container_id</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
                           <span class='dot token'>.</span><span class='rubyid_exclude identifier id'>exclude</span><span class='lparen token'>(</span><span class='symbol val'>:top_container_link_rlshp__id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_all_ids identifier id'>all_ids</span><span class='rparen token'>)</span>
                           <span class='dot token'>.</span><span class='rubyid_count identifier id'>count</span>

      <span class='rubyid_if if kw'>if</span> <span class='rubyid_number_of_tc_links identifier id'>number_of_tc_links</span> <span class='lt op'>&lt;</span> <span class='integer val'>1</span>
        <span class='comment val'># this tc is only linked in this graph..so we transfer</span>
        <span class='rubyid_top_container identifier id'>top_container</span> <span class='assign token'>=</span> <span class='rubyid_TopContainer constant id'>TopContainer</span><span class='dot token'>.</span><span class='rubyid_this_repo identifier id'>this_repo</span><span class='dot token'>.</span><span class='rubyid_filter identifier id'>filter</span><span class='lbrack token'>[</span><span class='rubyid_tc_rel identifier id'>tc_rel</span><span class='lbrack token'>[</span><span class='symbol val'>:top_container_id</span><span class='rbrack token'>]</span><span class='rbrack token'>]</span>

        <span class='rubyid_if if kw'>if</span> <span class='rubyid_top_container identifier id'>top_container</span>
          <span class='rubyid_if if kw'>if</span> <span class='rubyid_top_container identifier id'>top_container</span><span class='dot token'>.</span><span class='rubyid_barcode identifier id'>barcode</span> <span class='andop op'>&amp;&amp;</span> <span class='rubyid_TopContainer constant id'>TopContainer</span><span class='dot token'>.</span><span class='rubyid_any_repo identifier id'>any_repo</span><span class='lbrack token'>[</span><span class='symbol val'>:barcode</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_top_container identifier id'>top_container</span><span class='dot token'>.</span><span class='rubyid_barcode identifier id'>barcode</span><span class='comma token'>,</span> <span class='symbol val'>:repo_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_repository identifier id'>repository</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span><span class='rbrack token'>]</span>
            <span class='comment val'># There's already a top container with our barcode in the target</span>
            <span class='comment val'># repository.  Not sure if merging them is the right strategy or</span>
            <span class='comment val'># not, so throwing an error for now</span>
            <span class='rubyid_raise identifier id'>raise</span> <span class='rubyid_TransferConstraintError constant id'>TransferConstraintError</span><span class='dot token'>.</span><span class='rubyid_new identifier id'>new</span><span class='lparen token'>(</span><span class='rubyid_top_container identifier id'>top_container</span><span class='dot token'>.</span><span class='rubyid_uri identifier id'>uri</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dstring node'>&quot;Top Container barcode '#{top_container.barcode}' already in use in target repository&quot;</span><span class='rparen token'>)</span>
          <span class='rubyid_end end kw'>end</span>

          <span class='rubyid_top_container identifier id'>top_container</span><span class='dot token'>.</span><span class='rubyid_transfer_to_repository identifier id'>transfer_to_repository</span><span class='lparen token'>(</span><span class='rubyid_repository identifier id'>repository</span><span class='comma token'>,</span> <span class='rubyid_transfer_group identifier id'>transfer_group</span> <span class='plus op'>+</span> <span class='lbrack token'>[</span><span class='rubyid_self self kw'>self</span><span class='rbrack token'>]</span><span class='rparen token'>)</span> <span class='comment val'># i guess we always add self just in case. dups are uniqed out.</span>
        <span class='rubyid_else else kw'>else</span>
          <span class='comment val'># Already transferred</span>
        <span class='rubyid_end end kw'>end</span>
      <span class='rubyid_else else kw'>else</span>
        <span class='comment val'># something outside the graph is linked to it, add it to the list and we'll clone after transfer</span>
        <span class='rubyid_tc_id identifier id'>tc_id</span> <span class='assign token'>=</span> <span class='rubyid_tc_rel identifier id'>tc_rel</span><span class='lbrack token'>[</span><span class='symbol val'>:top_container_id</span><span class='rbrack token'>]</span>
        <span class='rubyid_containers_to_clone identifier id'>containers_to_clone</span><span class='lbrack token'>[</span><span class='rubyid_tc_id identifier id'>tc_id</span><span class='rbrack token'>]</span> <span class='opasgn op'>||=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
        <span class='rubyid_containers_to_clone identifier id'>containers_to_clone</span><span class='lbrack token'>[</span><span class='rubyid_tc_id identifier id'>tc_id</span><span class='rbrack token'>]</span> <span class='lshft op'>&lt;&lt;</span>  <span class='rubyid_tc_rel identifier id'>tc_rel</span><span class='lbrack token'>[</span><span class='symbol val'>:sub_container_id</span><span class='rbrack token'>]</span>
      <span class='rubyid_end end kw'>end</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='comment val'>## Transfer the current record</span>
  <span class='rubyid_super super kw'>super</span>

  <span class='comment val'>## Clone the top containers that we marked for cloning</span>
  <span class='rubyid_containers_to_clone identifier id'>containers_to_clone</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_tc_to_clone identifier id'>tc_to_clone</span><span class='comma token'>,</span> <span class='rubyid_sces identifier id'>sces</span><span class='bitor op'>|</span>
    <span class='comment val'># we copy the TC to be cloned</span>
    <span class='rubyid_hash identifier id'>hash</span> <span class='assign token'>=</span> <span class='rubyid_TopContainer constant id'>TopContainer</span><span class='dot token'>.</span><span class='rubyid_to_jsonmodel identifier id'>to_jsonmodel</span><span class='lparen token'>(</span><span class='rubyid_tc_to_clone identifier id'>tc_to_clone</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_to_hash identifier id'>to_hash</span><span class='lparen token'>(</span><span class='symbol val'>:trusted</span><span class='rparen token'>)</span>

    <span class='comment val'># we make the TC in the new repo context</span>
    <span class='rubyid_RequestContext constant id'>RequestContext</span><span class='dot token'>.</span><span class='rubyid_open identifier id'>open</span><span class='lparen token'>(</span><span class='symbol val'>:repo_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_repository identifier id'>repository</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span><span class='rparen token'>)</span> <span class='rubyid_do do kw'>do</span>
      <span class='rubyid_tc identifier id'>tc</span> <span class='assign token'>=</span> <span class='rubyid_nil nil kw'>nil</span>

      <span class='comment val'># but first lets check if this exists already by barcode</span>
      <span class='rubyid_if if kw'>if</span> <span class='rubyid_hash identifier id'>hash</span><span class='lbrack token'>[</span><span class='string val'>&quot;barcode&quot;</span><span class='rbrack token'>]</span>
        <span class='rubyid_tc identifier id'>tc</span> <span class='assign token'>=</span> <span class='rubyid_TopContainer constant id'>TopContainer</span><span class='dot token'>.</span><span class='rubyid_for_barcode identifier id'>for_barcode</span><span class='lparen token'>(</span><span class='rubyid_hash identifier id'>hash</span><span class='lbrack token'>[</span><span class='string val'>&quot;barcode&quot;</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
      <span class='rubyid_end end kw'>end</span>

      <span class='comment val'># not found, we make the clone</span>
      <span class='rubyid_unless unless kw'>unless</span> <span class='rubyid_tc identifier id'>tc</span>
        <span class='rubyid_tc identifier id'>tc</span> <span class='assign token'>=</span> <span class='rubyid_TopContainer constant id'>TopContainer</span><span class='dot token'>.</span><span class='rubyid_create_from_json identifier id'>create_from_json</span><span class='lparen token'>(</span><span class='rubyid_JSONModel constant id'>JSONModel</span><span class='lparen token'>(</span><span class='symbol val'>:top_container</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_from_hash identifier id'>from_hash</span><span class='lparen token'>(</span><span class='rubyid_hash identifier id'>hash</span><span class='rparen token'>)</span><span class='comma token'>,</span>
                                           <span class='symbol val'>:repo_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_repository identifier id'>repository</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span><span class='rparen token'>)</span>
      <span class='rubyid_end end kw'>end</span>

      <span class='comment val'># now we linke the clone to all the sub_containers</span>
      <span class='rubyid_sces identifier id'>sces</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_sc identifier id'>sc</span><span class='bitor op'>|</span>
        <span class='comment val'># the record is broken now, so we have to shuck it in the backdoor</span>
        <span class='rubyid_DB constant id'>DB</span><span class='dot token'>.</span><span class='rubyid_open identifier id'>open</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_db identifier id'>db</span><span class='bitor op'>|</span>
          <span class='rubyid_db identifier id'>db</span><span class='lbrack token'>[</span><span class='symbol val'>:top_container_link_rlshp</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_insert identifier id'>insert</span><span class='lparen token'>(</span><span class='symbol val'>:top_container_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_tc identifier id'>tc</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span><span class='comma token'>,</span>
                                               <span class='symbol val'>:system_mtime</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_Time constant id'>Time</span><span class='dot token'>.</span><span class='rubyid_now identifier id'>now</span><span class='comma token'>,</span>
                                               <span class='symbol val'>:user_mtime</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_Time constant id'>Time</span><span class='dot token'>.</span><span class='rubyid_now identifier id'>now</span><span class='comma token'>,</span>
                                               <span class='symbol val'>:sub_container_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_sc identifier id'>sc</span><span class='rparen token'>)</span>
        <span class='rubyid_end end kw'>end</span>
      <span class='rubyid_end end kw'>end</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='comment val'>## Clone any required events in the new repository</span>
  <span class='rubyid_RequestContext constant id'>RequestContext</span><span class='dot token'>.</span><span class='rubyid_open identifier id'>open</span><span class='lparen token'>(</span><span class='symbol val'>:repo_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_repository identifier id'>repository</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span><span class='rparen token'>)</span> <span class='rubyid_do do kw'>do</span>
    <span class='rubyid_events_to_clone identifier id'>events_to_clone</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_to_clone identifier id'>to_clone</span><span class='bitor op'>|</span>
      <span class='rubyid_event identifier id'>event</span> <span class='assign token'>=</span> <span class='rubyid_to_clone identifier id'>to_clone</span><span class='lbrack token'>[</span><span class='symbol val'>:event</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_to_hash identifier id'>to_hash</span><span class='lparen token'>(</span><span class='symbol val'>:trusted</span><span class='rparen token'>)</span><span class='dot token'>.</span>
              <span class='rubyid_merge identifier id'>merge</span><span class='lparen token'>(</span><span class='string val'>'linked_records'</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='lbrace token'>{</span>
                                           <span class='string val'>'ref'</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_uri identifier id'>uri</span><span class='comma token'>,</span>
                                           <span class='string val'>'role'</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_to_clone identifier id'>to_clone</span><span class='lbrack token'>[</span><span class='symbol val'>:role</span><span class='rbrack token'>]</span>
                                         <span class='rbrace token'>}</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>

      <span class='rubyid_Event constant id'>Event</span><span class='dot token'>.</span><span class='rubyid_create_from_json identifier id'>create_from_json</span><span class='lparen token'>(</span><span class='rubyid_JSONModel constant id'>JSONModel</span><span class='lparen token'>(</span><span class='symbol val'>:event</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_from_hash identifier id'>from_hash</span><span class='lparen token'>(</span><span class='rubyid_event identifier id'>event</span><span class='rparen token'>)</span><span class='comma token'>,</span>
                             <span class='symbol val'>:repo_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_repository identifier id'>repository</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span><span class='rparen token'>)</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  ArchivesSpace Version v1.5.3 Documentation Generated on Wed Feb 15 10:10:00 2017 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.0 (ruby-1.9.3).
</div>
    </div>
  </body>
</html>