<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: ASModel::CRUD
  
    &mdash; Documentation by YARD 0.9.0
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "ASModel::CRUD";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../class_list.html"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (C)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../ASModel.html" title="ASModel (module)">ASModel</a></span></span>
     &raquo; 
    <span class="title">CRUD</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <iframe id="search_frame" src="../class_list.html"></iframe>

      <div id="content"><h1>Module: ASModel::CRUD
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  
  <dl>
    <dt>Included in:</dt>
    <dd><span class='object_link'><a href="../RightsRestriction.html" title="RightsRestriction (class)">RightsRestriction</a></span></dd>
  </dl>
  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>backend/app/model/ASModel_crud.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>Code for converting JSONModels into DB records and back again.</p>


  </div>
</div>
<div class="tags">
  

</div><h2>Defined Under Namespace</h2>
<p class="children">
  
    
      <strong class="modules">Modules:</strong> <span class='object_link'><a href="CRUD/ClassMethods.html" title="ASModel::CRUD::ClassMethods (module)">ClassMethods</a></span>
    
  
    
  
    
  
</p>







  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#included-class_method" title="included (class method)">.<strong>included</strong>(base)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#set_audit_fields-class_method" title="set_audit_fields (class method)">.<strong>set_audit_fields</strong>(json, obj)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#apply_nested_records-instance_method" title="#apply_nested_records (instance method)">#<strong>apply_nested_records</strong>(json, new_record = false)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Several JSONModels consist of logical subrecords that are stored as separate models in the database (in separate tables).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#delete-instance_method" title="#delete (instance method)">#<strong>delete</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Delete the current record using Sequel&#8217;s delete method, but clean up dependencies first.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#eagerly_load%21-instance_method" title="#eagerly_load! (instance method)">#<strong>eagerly_load!</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Do whatever is necessary to eaglerly load this object from the database.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#map_validation_to_json_property-instance_method" title="#map_validation_to_json_property (instance method)">#<strong>map_validation_to_json_property</strong>(columns, property)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>When reporting a Sequel validation error against the set of &#8216;columns&#8217;, report it against the JSONModel &#8216;property&#8217; instead.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#mark_as_system_modified-instance_method" title="#mark_as_system_modified (instance method)">#<strong>mark_as_system_modified</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#remove_nested_records-instance_method" title="#remove_nested_records (instance method)">#<strong>remove_nested_records</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#system_modified%3F-instance_method" title="#system_modified? (instance method)">#<strong>system_modified?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>that their local copy of the record includes the system-generated data too.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_from_json-instance_method" title="#update_from_json (instance method)">#<strong>update_from_json</strong>(json, extra_values = {}, apply_nested_records = true)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#validate-instance_method" title="#validate (instance method)">#<strong>validate</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="included-class_method">
  
    .<strong>included</strong>(base)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


8
9
10
11
12</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/ASModel_crud.rb', line 8</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_included identifier id'>included</span><span class='lparen token'>(</span><span class='rubyid_base identifier id'>base</span><span class='rparen token'>)</span>
  <span class='rubyid_base identifier id'>base</span><span class='dot token'>.</span><span class='rubyid_extend identifier id'>extend</span><span class='lparen token'>(</span><span class='rubyid_ClassMethods constant id'>ClassMethods</span><span class='rparen token'>)</span>
  <span class='rubyid_base identifier id'>base</span><span class='dot token'>.</span><span class='rubyid_include identifier id'>include</span><span class='lparen token'>(</span><span class='rubyid_JSONModel constant id'>JSONModel</span><span class='rparen token'>)</span>
  <span class='rubyid_base identifier id'>base</span><span class='dot token'>.</span><span class='rubyid_extend identifier id'>extend</span><span class='lparen token'>(</span><span class='rubyid_JSONModel constant id'>JSONModel</span><span class='rparen token'>)</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="set_audit_fields-class_method">
  
    .<strong>set_audit_fields</strong>(json, obj)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


17
18
19
20
21
22
23
24
25
26
27
28</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/ASModel_crud.rb', line 17</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_set_audit_fields identifier id'>set_audit_fields</span><span class='lparen token'>(</span><span class='rubyid_json identifier id'>json</span><span class='comma token'>,</span> <span class='rubyid_obj identifier id'>obj</span><span class='rparen token'>)</span>
  <span class='lbrack token'>[</span><span class='string val'>'created_by'</span><span class='comma token'>,</span> <span class='string val'>'last_modified_by'</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_field identifier id'>field</span><span class='bitor op'>|</span>
    <span class='rubyid_json identifier id'>json</span><span class='lbrack token'>[</span><span class='rubyid_field identifier id'>field</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='lbrack token'>[</span><span class='rubyid_field identifier id'>field</span><span class='dot token'>.</span><span class='rubyid_intern identifier id'>intern</span><span class='rbrack token'>]</span> <span class='rubyid_if if_mod kw'>if</span> <span class='rubyid_obj identifier id'>obj</span><span class='lbrack token'>[</span><span class='rubyid_field identifier id'>field</span><span class='dot token'>.</span><span class='rubyid_intern identifier id'>intern</span><span class='rbrack token'>]</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='lbrack token'>[</span><span class='string val'>'system_mtime'</span><span class='comma token'>,</span> <span class='string val'>'user_mtime'</span><span class='comma token'>,</span> <span class='string val'>'create_time'</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_field identifier id'>field</span><span class='bitor op'>|</span>
    <span class='rubyid_val identifier id'>val</span> <span class='assign token'>=</span> <span class='rubyid_obj identifier id'>obj</span><span class='lbrack token'>[</span><span class='rubyid_field identifier id'>field</span><span class='dot token'>.</span><span class='rubyid_intern identifier id'>intern</span><span class='rbrack token'>]</span>
    <span class='rubyid_next next kw'>next</span> <span class='rubyid_if if_mod kw'>if</span> <span class='notop op'>!</span><span class='rubyid_val identifier id'>val</span>

    <span class='rubyid_json identifier id'>json</span><span class='lbrack token'>[</span><span class='rubyid_field identifier id'>field</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rubyid_val identifier id'>val</span><span class='dot token'>.</span><span class='rubyid_getutc identifier id'>getutc</span><span class='dot token'>.</span><span class='rubyid_iso8601 identifier id'>iso8601</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="apply_nested_records-instance_method">
  
    #<strong>apply_nested_records</strong>(json, new_record = false)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Several JSONModels consist of logical subrecords that are stored as
separate models in the database (in separate tables).</p>

<p>When we get a JSON blob for a record with subrecords, we want to create a
database record for each subrecords (or, if a URI referencing an existing
subrecord was given, use the existing object), then associate those
subrecords with the main record.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/ASModel_crud.rb', line 60</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_apply_nested_records identifier id'>apply_nested_records</span><span class='lparen token'>(</span><span class='rubyid_json identifier id'>json</span><span class='comma token'>,</span> <span class='rubyid_new_record identifier id'>new_record</span> <span class='assign token'>=</span> <span class='rubyid_false false kw'>false</span><span class='rparen token'>)</span>

  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_remove_nested_records identifier id'>remove_nested_records</span> <span class='rubyid_if if_mod kw'>if</span> <span class='notop op'>!</span><span class='rubyid_new_record identifier id'>new_record</span>

  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_nested_records identifier id'>nested_records</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_nested_record identifier id'>nested_record</span><span class='bitor op'>|</span>
    <span class='comment val'># Read the subrecords from our JSON blob and fetch or create</span>
    <span class='comment val'># the corresponding subrecord from the database.</span>
    <span class='rubyid_model identifier id'>model</span> <span class='assign token'>=</span> <span class='rubyid_Kernel constant id'>Kernel</span><span class='dot token'>.</span><span class='rubyid_const_get identifier id'>const_get</span><span class='lparen token'>(</span><span class='rubyid_nested_record identifier id'>nested_record</span><span class='lbrack token'>[</span><span class='symbol val'>:association</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:class_name</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>

    <span class='rubyid_if if kw'>if</span> <span class='rubyid_nested_record identifier id'>nested_record</span><span class='lbrack token'>[</span><span class='symbol val'>:association</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:type</span><span class='rbrack token'>]</span> <span class='eqq op'>===</span> <span class='symbol val'>:one_to_one</span>
      <span class='rubyid_add_record_method identifier id'>add_record_method</span> <span class='assign token'>=</span> <span class='rubyid_nested_record identifier id'>nested_record</span><span class='lbrack token'>[</span><span class='symbol val'>:association</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_to_s identifier id'>to_s</span>
    <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_nested_record identifier id'>nested_record</span><span class='lbrack token'>[</span><span class='symbol val'>:association</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:type</span><span class='rbrack token'>]</span> <span class='eqq op'>===</span> <span class='symbol val'>:many_to_one</span>
      <span class='rubyid_add_record_method identifier id'>add_record_method</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;#{nested_record[:association][:name].to_s.singularize}=&quot;</span>
    <span class='rubyid_else else kw'>else</span>
      <span class='rubyid_add_record_method identifier id'>add_record_method</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;add_#{nested_record[:association][:name].to_s.singularize}&quot;</span>
    <span class='rubyid_end end kw'>end</span>

    <span class='rubyid_records identifier id'>records</span> <span class='assign token'>=</span> <span class='rubyid_json identifier id'>json</span><span class='lbrack token'>[</span><span class='rubyid_nested_record identifier id'>nested_record</span><span class='lbrack token'>[</span><span class='symbol val'>:json_property</span><span class='rbrack token'>]</span><span class='rbrack token'>]</span>

    <span class='rubyid_is_array identifier id'>is_array</span> <span class='assign token'>=</span> <span class='rubyid_true true kw'>true</span>
    <span class='rubyid_if if kw'>if</span> <span class='rubyid_nested_record identifier id'>nested_record</span><span class='lbrack token'>[</span><span class='symbol val'>:association</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:type</span><span class='rbrack token'>]</span> <span class='eqq op'>===</span> <span class='symbol val'>:one_to_one</span> <span class='orop op'>||</span> <span class='rubyid_nested_record identifier id'>nested_record</span><span class='lbrack token'>[</span><span class='symbol val'>:is_array</span><span class='rbrack token'>]</span> <span class='eqq op'>===</span> <span class='rubyid_false false kw'>false</span>
      <span class='rubyid_is_array identifier id'>is_array</span> <span class='assign token'>=</span> <span class='rubyid_false false kw'>false</span>
      <span class='rubyid_records identifier id'>records</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rubyid_records identifier id'>records</span><span class='rbrack token'>]</span>
    <span class='rubyid_end end kw'>end</span>

    <span class='rubyid_updated_records identifier id'>updated_records</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
    <span class='lparen token'>(</span><span class='rubyid_records identifier id'>records</span> <span class='rubyid_or or kw'>or</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_each_with_index identifier id'>each_with_index</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_json_or_uri identifier id'>json_or_uri</span><span class='comma token'>,</span> <span class='rubyid_i identifier id'>i</span><span class='bitor op'>|</span>
      <span class='rubyid_next next kw'>next</span> <span class='rubyid_if if_mod kw'>if</span> <span class='rubyid_json_or_uri identifier id'>json_or_uri</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span>

      <span class='rubyid_db_record identifier id'>db_record</span> <span class='assign token'>=</span> <span class='rubyid_nil nil kw'>nil</span>

      <span class='rubyid_begin begin kw'>begin</span>
        <span class='rubyid_needs_linking identifier id'>needs_linking</span> <span class='assign token'>=</span> <span class='rubyid_true true kw'>true</span>

        <span class='rubyid_if if kw'>if</span> <span class='rubyid_json_or_uri identifier id'>json_or_uri</span><span class='dot token'>.</span><span class='rubyid_kind_of? fid id'>kind_of?</span> <span class='rubyid_String constant id'>String</span>
          <span class='comment val'># A URI.  Just grab its database ID and look it up.</span>
                  <span class='rubyid_db_record identifier id'>db_record</span> <span class='assign token'>=</span> <span class='rubyid_model identifier id'>model</span><span class='lbrack token'>[</span><span class='rubyid_JSONModel constant id'>JSONModel</span><span class='lparen token'>(</span><span class='rubyid_nested_record identifier id'>nested_record</span><span class='lbrack token'>[</span><span class='symbol val'>:jsonmodel</span><span class='rbrack token'>]</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_id_for identifier id'>id_for</span><span class='lparen token'>(</span><span class='rubyid_json_or_uri identifier id'>json_or_uri</span><span class='rparen token'>)</span><span class='rbrack token'>]</span>
          <span class='rubyid_updated_records identifier id'>updated_records</span> <span class='lshft op'>&lt;&lt;</span> <span class='rubyid_json_or_uri identifier id'>json_or_uri</span>
        <span class='rubyid_else else kw'>else</span>
          <span class='comment val'># Create a database record for the JSON blob and return its ID</span>
          <span class='rubyid_subrecord_json identifier id'>subrecord_json</span> <span class='assign token'>=</span> <span class='rubyid_JSONModel constant id'>JSONModel</span><span class='lparen token'>(</span><span class='rubyid_nested_record identifier id'>nested_record</span><span class='lbrack token'>[</span><span class='symbol val'>:jsonmodel</span><span class='rbrack token'>]</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_from_hash identifier id'>from_hash</span><span class='lparen token'>(</span><span class='rubyid_json_or_uri identifier id'>json_or_uri</span><span class='comma token'>,</span> <span class='rubyid_true true kw'>true</span><span class='comma token'>,</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>

          <span class='comment val'># The value of subrecord_json can be mutated by the various</span>
          <span class='comment val'># transformations performed by the model layer.  Make sure we</span>
          <span class='comment val'># keep the modified version of the JSON here.</span>
          <span class='rubyid_updated_records identifier id'>updated_records</span> <span class='lshft op'>&lt;&lt;</span> <span class='rubyid_subrecord_json identifier id'>subrecord_json</span>

          <span class='rubyid_if if kw'>if</span> <span class='rubyid_model identifier id'>model</span><span class='dot token'>.</span><span class='rubyid_respond_to? fid id'>respond_to?</span> <span class='colon op'>:</span><span class='rubyid_ensure_exists identifier id'>ensure_exists</span>
            <span class='comment val'># Give our classes an opportunity to provide their own logic here</span>
            <span class='rubyid_db_record identifier id'>db_record</span> <span class='assign token'>=</span> <span class='rubyid_model identifier id'>model</span><span class='dot token'>.</span><span class='rubyid_ensure_exists identifier id'>ensure_exists</span><span class='lparen token'>(</span><span class='rubyid_subrecord_json identifier id'>subrecord_json</span><span class='comma token'>,</span> <span class='rubyid_self self kw'>self</span><span class='rparen token'>)</span>
          <span class='rubyid_else else kw'>else</span>
            <span class='rubyid_extra_opts identifier id'>extra_opts</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>

            <span class='rubyid_if if kw'>if</span> <span class='rubyid_nested_record identifier id'>nested_record</span><span class='lbrack token'>[</span><span class='symbol val'>:association</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:key</span><span class='rbrack token'>]</span>
              <span class='rubyid_extra_opts identifier id'>extra_opts</span><span class='lbrack token'>[</span><span class='rubyid_nested_record identifier id'>nested_record</span><span class='lbrack token'>[</span><span class='symbol val'>:association</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:key</span><span class='rbrack token'>]</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_id identifier id'>id</span>

              <span class='comment val'># We'll skip the call to the .add method because this step</span>
              <span class='comment val'># will have already linked the nested record to this one.</span>
              <span class='rubyid_needs_linking identifier id'>needs_linking</span> <span class='assign token'>=</span> <span class='rubyid_false false kw'>false</span>
            <span class='rubyid_end end kw'>end</span>

            <span class='rubyid_db_record identifier id'>db_record</span> <span class='assign token'>=</span> <span class='rubyid_model identifier id'>model</span><span class='dot token'>.</span><span class='rubyid_create_from_json identifier id'>create_from_json</span><span class='lparen token'>(</span><span class='rubyid_subrecord_json identifier id'>subrecord_json</span><span class='comma token'>,</span> <span class='rubyid_extra_opts identifier id'>extra_opts</span><span class='rparen token'>)</span>
          <span class='rubyid_end end kw'>end</span>
        <span class='rubyid_end end kw'>end</span>

        <span class='rubyid_if if kw'>if</span> <span class='rubyid_db_record identifier id'>db_record</span><span class='dot token'>.</span><span class='rubyid_system_modified? fid id'>system_modified?</span>
          <span class='comment val'># If the subrecord got changed by the system, mark ourselves as</span>
          <span class='comment val'># modified too.</span>
          <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_mark_as_system_modified identifier id'>mark_as_system_modified</span>
        <span class='rubyid_end end kw'>end</span>

        <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_send identifier id'>send</span><span class='lparen token'>(</span><span class='rubyid_add_record_method identifier id'>add_record_method</span><span class='comma token'>,</span> <span class='rubyid_db_record identifier id'>db_record</span><span class='rparen token'>)</span> <span class='rubyid_if if_mod kw'>if</span> <span class='lparen token'>(</span><span class='rubyid_db_record identifier id'>db_record</span> <span class='andop op'>&amp;&amp;</span> <span class='rubyid_needs_linking identifier id'>needs_linking</span><span class='rparen token'>)</span>
      <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_Sequel constant id'>Sequel</span><span class='colon2 op'>::</span><span class='rubyid_ValidationFailed constant id'>ValidationFailed</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_e identifier id'>e</span>
        <span class='comment val'># Modify the exception keys by prefixing each with the path up until this point.</span>
        <span class='rubyid_e identifier id'>e</span><span class='dot token'>.</span><span class='rubyid_instance_eval identifier id'>instance_eval</span> <span class='rubyid_do do kw'>do</span>
          <span class='rubyid_if if kw'>if</span> <span class='rubyid_@errors ivar id'>@errors</span>
            <span class='rubyid_prefix identifier id'>prefix</span> <span class='assign token'>=</span> <span class='rubyid_nested_record identifier id'>nested_record</span><span class='lbrack token'>[</span><span class='symbol val'>:json_property</span><span class='rbrack token'>]</span>
            <span class='rubyid_prefix identifier id'>prefix</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;#{prefix}/#{i}&quot;</span> <span class='rubyid_if if_mod kw'>if</span> <span class='rubyid_is_array identifier id'>is_array</span>

            <span class='rubyid_new_errors identifier id'>new_errors</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
            <span class='rubyid_@errors ivar id'>@errors</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_k identifier id'>k</span><span class='comma token'>,</span> <span class='rubyid_v identifier id'>v</span><span class='bitor op'>|</span>
              <span class='rubyid_new_errors identifier id'>new_errors</span><span class='lbrack token'>[</span><span class='dstring node'>&quot;#{prefix}/#{k}&quot;</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rubyid_v identifier id'>v</span>
            <span class='rubyid_end end kw'>end</span>

            <span class='rubyid_@errors ivar id'>@errors</span> <span class='assign token'>=</span> <span class='rubyid_new_errors identifier id'>new_errors</span>
          <span class='rubyid_end end kw'>end</span>
        <span class='rubyid_end end kw'>end</span>

        <span class='rubyid_raise identifier id'>raise</span> <span class='rubyid_e identifier id'>e</span>
      <span class='rubyid_end end kw'>end</span>
    <span class='rubyid_end end kw'>end</span>

    <span class='rubyid_json identifier id'>json</span><span class='lbrack token'>[</span><span class='rubyid_nested_record identifier id'>nested_record</span><span class='lbrack token'>[</span><span class='symbol val'>:json_property</span><span class='rbrack token'>]</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rubyid_is_array identifier id'>is_array</span> <span class='integer val'>? </span><span class='rubyid_updated_records identifier id'>updated_records</span> <span class='colon op'>:</span> <span class='rubyid_updated_records identifier id'>updated_records</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="delete-instance_method">
  
    #<strong>delete</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Delete the current record using Sequel&#8217;s delete method, but clean up
dependencies first.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/ASModel_crud.rb', line 236</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_delete identifier id'>delete</span>
  <span class='rubyid_object_graph identifier id'>object_graph</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_object_graph identifier id'>object_graph</span>

  <span class='rubyid_deleted_uris identifier id'>deleted_uris</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>

  <span class='rubyid_successfully_deleted_models identifier id'>successfully_deleted_models</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
  <span class='rubyid_last_error identifier id'>last_error</span> <span class='assign token'>=</span> <span class='rubyid_nil nil kw'>nil</span>

  <span class='rubyid_while while kw'>while</span> <span class='rubyid_true true kw'>true</span>
    <span class='rubyid_progressed identifier id'>progressed</span> <span class='assign token'>=</span> <span class='rubyid_false false kw'>false</span>
    <span class='rubyid_object_graph identifier id'>object_graph</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_model identifier id'>model</span><span class='comma token'>,</span> <span class='rubyid_ids_to_delete identifier id'>ids_to_delete</span><span class='bitor op'>|</span>
      <span class='rubyid_next next kw'>next</span> <span class='rubyid_if if_mod kw'>if</span> <span class='rubyid_successfully_deleted_models identifier id'>successfully_deleted_models</span><span class='dot token'>.</span><span class='rubyid_include? fid id'>include?</span><span class='lparen token'>(</span><span class='rubyid_model identifier id'>model</span><span class='rparen token'>)</span>

      <span class='rubyid_begin begin kw'>begin</span>
        <span class='rubyid_model identifier id'>model</span><span class='dot token'>.</span><span class='rubyid_handle_delete identifier id'>handle_delete</span><span class='lparen token'>(</span><span class='rubyid_ids_to_delete identifier id'>ids_to_delete</span><span class='rparen token'>)</span>
        <span class='rubyid_successfully_deleted_models identifier id'>successfully_deleted_models</span> <span class='lshft op'>&lt;&lt;</span> <span class='rubyid_model identifier id'>model</span>
        <span class='rubyid_progressed identifier id'>progressed</span> <span class='assign token'>=</span> <span class='rubyid_true true kw'>true</span>
      <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_Sequel constant id'>Sequel</span><span class='colon2 op'>::</span><span class='rubyid_DatabaseError constant id'>DatabaseError</span>
        <span class='rubyid_last_error identifier id'>last_error</span> <span class='assign token'>=</span> <span class='rubyid_$! gvar id'>$!</span>
        <span class='rubyid_next next kw'>next</span>
      <span class='rubyid_end end kw'>end</span>

      <span class='rubyid_if if kw'>if</span> <span class='rubyid_model identifier id'>model</span><span class='dot token'>.</span><span class='rubyid_my_jsonmodel identifier id'>my_jsonmodel</span><span class='lparen token'>(</span><span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
        <span class='rubyid_ids_to_delete identifier id'>ids_to_delete</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_id identifier id'>id</span><span class='bitor op'>|</span>
          <span class='rubyid_deleted_uri identifier id'>deleted_uri</span> <span class='assign token'>=</span> <span class='rubyid_model identifier id'>model</span><span class='dot token'>.</span><span class='rubyid_my_jsonmodel identifier id'>my_jsonmodel</span><span class='lparen token'>(</span><span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span><span class='dot token'>.</span>
                              <span class='rubyid_uri_for identifier id'>uri_for</span><span class='lparen token'>(</span><span class='rubyid_id identifier id'>id</span><span class='comma token'>,</span> <span class='symbol val'>:repo_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_model identifier id'>model</span><span class='dot token'>.</span><span class='rubyid_active_repository identifier id'>active_repository</span><span class='rparen token'>)</span>

          <span class='rubyid_if if kw'>if</span> <span class='rubyid_deleted_uri identifier id'>deleted_uri</span>
            <span class='rubyid_deleted_uris identifier id'>deleted_uris</span> <span class='lshft op'>&lt;&lt;</span> <span class='rubyid_deleted_uri identifier id'>deleted_uri</span>
          <span class='rubyid_end end kw'>end</span>
        <span class='rubyid_end end kw'>end</span>
      <span class='rubyid_end end kw'>end</span>
    <span class='rubyid_end end kw'>end</span>

    <span class='rubyid_break break kw'>break</span> <span class='rubyid_if if_mod kw'>if</span> <span class='rubyid_object_graph identifier id'>object_graph</span><span class='dot token'>.</span><span class='rubyid_models identifier id'>models</span><span class='dot token'>.</span><span class='rubyid_length identifier id'>length</span> <span class='eq op'>==</span> <span class='rubyid_successfully_deleted_models identifier id'>successfully_deleted_models</span><span class='dot token'>.</span><span class='rubyid_length identifier id'>length</span>

    <span class='rubyid_unless unless kw'>unless</span> <span class='rubyid_progressed identifier id'>progressed</span>
      <span class='rubyid_if if kw'>if</span> <span class='rubyid_last_error identifier id'>last_error</span> <span class='andop op'>&amp;&amp;</span> <span class='rubyid_DB constant id'>DB</span><span class='dot token'>.</span><span class='rubyid_is_retriable_exception identifier id'>is_retriable_exception</span><span class='lparen token'>(</span><span class='rubyid_last_error identifier id'>last_error</span><span class='rparen token'>)</span>
        <span class='comment val'># Give us a chance to retry after a deadlock</span>
        <span class='rubyid_raise identifier id'>raise</span> <span class='rubyid_last_error identifier id'>last_error</span>
      <span class='rubyid_end end kw'>end</span>

      <span class='rubyid_raise identifier id'>raise</span> <span class='rubyid_ConflictException constant id'>ConflictException</span><span class='dot token'>.</span><span class='rubyid_new identifier id'>new</span><span class='lparen token'>(</span><span class='dstring node'>&quot;Record deletion failed: #{last_error}&quot;</span><span class='rparen token'>)</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>


  <span class='rubyid_deleted_uris identifier id'>deleted_uris</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_uri identifier id'>uri</span><span class='bitor op'>|</span>
    <span class='rubyid_Tombstone constant id'>Tombstone</span><span class='dot token'>.</span><span class='rubyid_create identifier id'>create</span><span class='lparen token'>(</span><span class='symbol val'>:uri</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_uri identifier id'>uri</span><span class='rparen token'>)</span>
    <span class='rubyid_DB constant id'>DB</span><span class='dot token'>.</span><span class='rubyid_after_commit identifier id'>after_commit</span> <span class='rubyid_do do kw'>do</span>
      <span class='rubyid_RealtimeIndexing constant id'>RealtimeIndexing</span><span class='dot token'>.</span><span class='rubyid_record_delete identifier id'>record_delete</span><span class='lparen token'>(</span><span class='rubyid_uri identifier id'>uri</span><span class='rparen token'>)</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="eagerly_load!-instance_method">
  
    #<strong>eagerly_load!</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Do whatever is necessary to eaglerly load this object from the database.</p>

<p>This is designed to give mixins the options of eagerly loading an entire
record and its components.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


48
49
50</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/ASModel_crud.rb', line 48</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_eagerly_load! fid id'>eagerly_load!</span>
  <span class='comment val'># Do nothing by default</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="map_validation_to_json_property-instance_method">
  
    #<strong>map_validation_to_json_property</strong>(columns, property)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>When reporting a Sequel validation error against the set of &#8216;columns&#8217;,
report it against the JSONModel &#8216;property&#8217; instead.</p>

<p>For example, an identifier that must be unique to a repository might have a
constraint against the columns [:repository, :identifier], but when we
report this to the client we just want to tell them that the value for
&#8216;identifier&#8217; was incorrect.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


299
300
301
302
303
304
305
306
307
308
309
310
311</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/ASModel_crud.rb', line 299</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_map_validation_to_json_property identifier id'>map_validation_to_json_property</span><span class='lparen token'>(</span><span class='rubyid_columns identifier id'>columns</span><span class='comma token'>,</span> <span class='rubyid_property identifier id'>property</span><span class='rparen token'>)</span>
  <span class='rubyid_errors identifier id'>errors</span> <span class='assign token'>=</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_errors identifier id'>errors</span><span class='dot token'>.</span><span class='rubyid_clone identifier id'>clone</span>

  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_errors identifier id'>errors</span><span class='dot token'>.</span><span class='rubyid_clear identifier id'>clear</span>

  <span class='rubyid_errors identifier id'>errors</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_error identifier id'>error</span><span class='comma token'>,</span> <span class='rubyid_msg identifier id'>msg</span><span class='bitor op'>|</span>
    <span class='rubyid_if if kw'>if</span> <span class='rubyid_error identifier id'>error</span> <span class='eq op'>==</span> <span class='rubyid_columns identifier id'>columns</span>
      <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_errors identifier id'>errors</span><span class='lbrack token'>[</span><span class='rubyid_property identifier id'>property</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rubyid_msg identifier id'>msg</span>
    <span class='rubyid_else else kw'>else</span>
      <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_errors identifier id'>errors</span><span class='lbrack token'>[</span><span class='rubyid_error identifier id'>error</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rubyid_msg identifier id'>msg</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="mark_as_system_modified-instance_method">
  
    #<strong>mark_as_system_modified</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


326
327
328</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/ASModel_crud.rb', line 326</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_mark_as_system_modified identifier id'>mark_as_system_modified</span>
  <span class='rubyid_@system_modified ivar id'>@system_modified</span> <span class='assign token'>=</span> <span class='rubyid_true true kw'>true</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="remove_nested_records-instance_method">
  
    #<strong>remove_nested_records</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/ASModel_crud.rb', line 157</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_remove_nested_records identifier id'>remove_nested_records</span>
  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_nested_records identifier id'>nested_records</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_nested_record_defn identifier id'>nested_record_defn</span><span class='bitor op'>|</span>
    <span class='rubyid_if if kw'>if</span> <span class='lbrack token'>[</span><span class='symbol val'>:one_to_one</span><span class='comma token'>,</span> <span class='symbol val'>:one_to_many</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_include? fid id'>include?</span><span class='lparen token'>(</span><span class='rubyid_nested_record_defn identifier id'>nested_record_defn</span><span class='lbrack token'>[</span><span class='symbol val'>:association</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:type</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
      <span class='comment val'># If the current record &quot;owns&quot; its nested record, delete the nested record.</span>
      <span class='rubyid_model identifier id'>model</span> <span class='assign token'>=</span> <span class='rubyid_Kernel constant id'>Kernel</span><span class='dot token'>.</span><span class='rubyid_const_get identifier id'>const_get</span><span class='lparen token'>(</span><span class='rubyid_nested_record_defn identifier id'>nested_record_defn</span><span class='lbrack token'>[</span><span class='symbol val'>:association</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:class_name</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>

      <span class='comment val'># Tell the nested record to clear its own nested records</span>
      <span class='rubyid_Array constant id'>Array</span><span class='lparen token'>(</span><span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_send identifier id'>send</span><span class='lparen token'>(</span><span class='rubyid_nested_record_defn identifier id'>nested_record_defn</span><span class='lbrack token'>[</span><span class='symbol val'>:association</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span><span class='rparen token'>)</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_nested_record identifier id'>nested_record</span><span class='bitor op'>|</span>

        <span class='comment val'># not stoked on this ,but some one_to_one's (collection_management</span>
        <span class='comment val'># ) get indexed with an id that refs the parent. so we need to</span>
        <span class='comment val'># tombstone the uri that points back to the parent uri</span>
        <span class='rubyid_if if kw'>if</span> <span class='rubyid_nested_record_defn identifier id'>nested_record_defn</span><span class='lbrack token'>[</span><span class='symbol val'>:association</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:type</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='symbol val'>:one_to_one</span>
          <span class='rubyid_context_uri identifier id'>context_uri</span> <span class='assign token'>=</span>  <span class='dstring node'>&quot;#{self.uri}##{self.class.to_s.downcase}_#{nested_record.class.to_s.underscore}&quot;</span>
          <span class='rubyid_Tombstone constant id'>Tombstone</span><span class='dot token'>.</span><span class='rubyid_create identifier id'>create</span><span class='lparen token'>(</span><span class='symbol val'>:uri</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_context_uri identifier id'>context_uri</span><span class='rparen token'>)</span>
        <span class='rubyid_end end kw'>end</span>
        
        <span class='rubyid_nested_record identifier id'>nested_record</span><span class='dot token'>.</span><span class='rubyid_delete identifier id'>delete</span>
      <span class='rubyid_end end kw'>end</span>
    <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_nested_record_defn identifier id'>nested_record_defn</span><span class='lbrack token'>[</span><span class='symbol val'>:association</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:type</span><span class='rbrack token'>]</span> <span class='eqq op'>===</span> <span class='symbol val'>:many_to_many</span>
      <span class='comment val'># Just remove the links</span>
      <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_send identifier id'>send</span><span class='lparen token'>(</span><span class='dstring node'>&quot;remove_all_#{nested_record_defn[:association][:name]}&quot;</span><span class='dot token'>.</span><span class='rubyid_intern identifier id'>intern</span><span class='rparen token'>)</span>
    <span class='rubyid_elsif elsif kw'>elsif</span> <span class='rubyid_nested_record_defn identifier id'>nested_record_defn</span><span class='lbrack token'>[</span><span class='symbol val'>:association</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:type</span><span class='rbrack token'>]</span> <span class='eqq op'>===</span> <span class='symbol val'>:many_to_one</span>
      <span class='comment val'># Just remove the link</span>
      <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_send identifier id'>send</span><span class='lparen token'>(</span><span class='dstring node'>&quot;#{nested_record_defn[:association][:name].intern}=&quot;</span><span class='comma token'>,</span> <span class='rubyid_nil nil kw'>nil</span><span class='rparen token'>)</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="system_modified?-instance_method">
  
    #<strong>system_modified?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>that their local copy of the record includes the system-generated data too.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


321
322
323</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/ASModel_crud.rb', line 321</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_system_modified? fid id'>system_modified?</span>
  <span class='rubyid_@system_modified ivar id'>@system_modified</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_from_json-instance_method">
  
    #<strong>update_from_json</strong>(json, extra_values = {}, apply_nested_records = true)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/ASModel_crud.rb', line 188</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_update_from_json identifier id'>update_from_json</span><span class='lparen token'>(</span><span class='rubyid_json identifier id'>json</span><span class='comma token'>,</span> <span class='rubyid_extra_values identifier id'>extra_values</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='rubyid_apply_nested_records identifier id'>apply_nested_records</span> <span class='assign token'>=</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>

  <span class='rubyid_if if kw'>if</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_values identifier id'>values</span><span class='dot token'>.</span><span class='rubyid_has_key? fid id'>has_key?</span><span class='lparen token'>(</span><span class='symbol val'>:suppressed</span><span class='rparen token'>)</span>
    <span class='rubyid_if if kw'>if</span> <span class='rubyid_self self kw'>self</span><span class='lbrack token'>[</span><span class='symbol val'>:suppressed</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='integer val'>1</span>
      <span class='rubyid_raise identifier id'>raise</span> <span class='rubyid_ReadOnlyException constant id'>ReadOnlyException</span><span class='dot token'>.</span><span class='rubyid_new identifier id'>new</span><span class='lparen token'>(</span><span class='string val'>&quot;Can't update an object that has been suppressed&quot;</span><span class='rparen token'>)</span>
    <span class='rubyid_end end kw'>end</span>

    <span class='comment val'># No funny business.  If you want to set this you need to do it via the</span>
    <span class='comment val'># dedicated controller.</span>
    <span class='rubyid_json identifier id'>json</span><span class='lbrack token'>[</span><span class='string val'>&quot;suppressed&quot;</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rubyid_false false kw'>false</span>
  <span class='rubyid_end end kw'>end</span>


  <span class='rubyid_schema_defined_properties identifier id'>schema_defined_properties</span> <span class='assign token'>=</span> <span class='rubyid_json identifier id'>json</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_schema identifier id'>schema</span><span class='lbrack token'>[</span><span class='string val'>&quot;properties&quot;</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='rubyid_map identifier id'>map</span><span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='rubyid_prop identifier id'>prop</span><span class='comma token'>,</span> <span class='rubyid_defn identifier id'>defn</span><span class='bitor op'>|</span>
    <span class='rubyid_prop identifier id'>prop</span> <span class='rubyid_if if_mod kw'>if</span> <span class='notop op'>!</span><span class='rubyid_defn identifier id'>defn</span><span class='lbrack token'>[</span><span class='string val'>'readonly'</span><span class='rbrack token'>]</span>
  <span class='rbrace token'>}</span><span class='dot token'>.</span><span class='rubyid_compact identifier id'>compact</span>

  <span class='comment val'># Start by assuming all existing properties were nil, then overlay the</span>
  <span class='comment val'># updates plus any extra attributes.</span>
  <span class='comment val'>#</span>
  <span class='comment val'># This has the effect of unsetting (or setting to NULL) any properties that</span>
  <span class='comment val'># were removed by this update.</span>
  <span class='rubyid_updated identifier id'>updated</span> <span class='assign token'>=</span> <span class='rubyid_Hash constant id'>Hash</span><span class='lbrack token'>[</span><span class='rubyid_schema_defined_properties identifier id'>schema_defined_properties</span><span class='dot token'>.</span><span class='rubyid_map identifier id'>map</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='rubyid_property identifier id'>property</span><span class='bitor op'>|</span> <span class='lbrack token'>[</span><span class='rubyid_property identifier id'>property</span><span class='comma token'>,</span> <span class='rubyid_nil nil kw'>nil</span><span class='rbrack token'>]</span><span class='rbrace token'>}</span><span class='rbrack token'>]</span><span class='dot token'>.</span>
    <span class='rubyid_merge identifier id'>merge</span><span class='lparen token'>(</span><span class='rubyid_json identifier id'>json</span><span class='dot token'>.</span><span class='rubyid_to_hash identifier id'>to_hash</span><span class='rparen token'>)</span><span class='dot token'>.</span>
    <span class='rubyid_merge identifier id'>merge</span><span class='lparen token'>(</span><span class='rubyid_ASUtils constant id'>ASUtils</span><span class='dot token'>.</span><span class='rubyid_keys_as_strings identifier id'>keys_as_strings</span><span class='lparen token'>(</span><span class='rubyid_extra_values identifier id'>extra_values</span><span class='rparen token'>)</span><span class='rparen token'>)</span>

  <span class='rubyid_if if kw'>if</span> <span class='rubyid_updated identifier id'>updated</span><span class='dot token'>.</span><span class='rubyid_has_key? fid id'>has_key?</span><span class='lparen token'>(</span><span class='string val'>'lock_version'</span><span class='rparen token'>)</span> <span class='andop op'>&amp;&amp;</span> <span class='notop op'>!</span><span class='rubyid_updated identifier id'>updated</span><span class='lbrack token'>[</span><span class='string val'>'lock_version'</span><span class='rbrack token'>]</span>
    <span class='rubyid_raise identifier id'>raise</span> <span class='rubyid_ConflictException constant id'>ConflictException</span><span class='dot token'>.</span><span class='rubyid_new identifier id'>new</span><span class='lparen token'>(</span><span class='string val'>&quot;You must provide a lock_version in your request&quot;</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_strict_param_setting identifier id'>strict_param_setting</span> <span class='assign token'>=</span> <span class='rubyid_false false kw'>false</span>

  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_update identifier id'>update</span><span class='lparen token'>(</span><span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_prepare_for_db identifier id'>prepare_for_db</span><span class='lparen token'>(</span><span class='rubyid_json identifier id'>json</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='comma token'>,</span> <span class='rubyid_updated identifier id'>updated</span><span class='rparen token'>)</span><span class='dot token'>.</span>
              <span class='rubyid_merge identifier id'>merge</span><span class='lparen token'>(</span><span class='symbol val'>:user_mtime</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_Time constant id'>Time</span><span class='dot token'>.</span><span class='rubyid_now identifier id'>now</span><span class='comma token'>,</span>
                    <span class='symbol val'>:last_modified_by</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_RequestContext constant id'>RequestContext</span><span class='dot token'>.</span><span class='rubyid_get identifier id'>get</span><span class='lparen token'>(</span><span class='symbol val'>:current_username</span><span class='rparen token'>)</span><span class='rparen token'>)</span><span class='rparen token'>)</span>

  <span class='rubyid_if if kw'>if</span> <span class='rubyid_apply_nested_records identifier id'>apply_nested_records</span>
    <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_apply_nested_records identifier id'>apply_nested_records</span><span class='lparen token'>(</span><span class='rubyid_json identifier id'>json</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_fire_update identifier id'>fire_update</span><span class='lparen token'>(</span><span class='rubyid_json identifier id'>json</span><span class='comma token'>,</span> <span class='rubyid_self self kw'>self</span><span class='rparen token'>)</span>

  <span class='rubyid_self self kw'>self</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="validate-instance_method">
  
    #<strong>validate</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


31
32
33
34
35
36
37
38
39
40
41</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'backend/app/model/ASModel_crud.rb', line 31</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_validate identifier id'>validate</span>
  <span class='comment val'># Check uniqueness constraints</span>
  <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_class identifier id'>class</span><span class='dot token'>.</span><span class='rubyid_repo_unique_constraints identifier id'>repo_unique_constraints</span><span class='dot token'>.</span><span class='rubyid_each identifier id'>each</span> <span class='rubyid_do do kw'>do</span> <span class='bitor op'>|</span><span class='rubyid_constraint identifier id'>constraint</span><span class='bitor op'>|</span>
    <span class='rubyid_validates_unique identifier id'>validates_unique</span><span class='lparen token'>(</span><span class='lbrack token'>[</span><span class='symbol val'>:repo_id</span><span class='comma token'>,</span> <span class='rubyid_constraint identifier id'>constraint</span><span class='lbrack token'>[</span><span class='symbol val'>:property</span><span class='rbrack token'>]</span><span class='rbrack token'>]</span><span class='comma token'>,</span>
                     <span class='symbol val'>:message</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_constraint identifier id'>constraint</span><span class='lbrack token'>[</span><span class='symbol val'>:message</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
    <span class='rubyid_map_validation_to_json_property identifier id'>map_validation_to_json_property</span><span class='lparen token'>(</span><span class='lbrack token'>[</span><span class='symbol val'>:repo_id</span><span class='comma token'>,</span> <span class='rubyid_constraint identifier id'>constraint</span><span class='lbrack token'>[</span><span class='symbol val'>:property</span><span class='rbrack token'>]</span><span class='rbrack token'>]</span><span class='comma token'>,</span>
                                     <span class='rubyid_constraint identifier id'>constraint</span><span class='lbrack token'>[</span><span class='symbol val'>:json_property</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>

  <span class='rubyid_super super kw'>super</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  ArchivesSpace Version v1.5.3 Documentation Generated on Wed Feb 15 10:09:58 2017 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.0 (ruby-1.9.3).
</div>
    </div>
  </body>
</html>