//= require largetree
//= require tree_renderer

/* search form javascript support */

var $template, $as;
var plusText = "<%= I18n.t('actions.search_add_row') %>";
var minusText = "<%= I18n.t('actions.search_remove_row') %>";
var plusFACss = "fa fa-plus";
var minusFACss = "fa fa-minus";
var fn_plusminus = function(e){
    e.preventDefault();
    e.stopPropagation();

    const $button = $(this);
    const action = $button.attr('data-action');

    if (action === 'add') {
        set_button_state($button, 'remove');

        const $row = new_row_from_template();
        $button.closest('.search_row').after($row);
        $row.find(".bool select").focus();
    }
    else {
        $button.closest(".search_row").next(".search_row").remove();

        const $lastRow = $as.find('.search_row').last();
        const $lastButton = $lastRow.find('.plusminus-btn');
        set_button_state($lastButton, 'add');
    }

    return false;
}

function set_button_state($button, mode) {
    const $label = $button.closest('.search_row').find('.plusminus_label');

    if (mode === 'add') {
        $button.find('i').removeClass(minusFACss).addClass(plusFACss);
        $button.attr('title', plusText);
        $button.attr('aria-label', plusText);
        $button.attr('data-action', 'add');
        $label.html("<%= I18n.t('advanced_search.add_row') %>");
    } else {
        $button.find('i').removeClass(plusFACss).addClass(minusFACss);
        $button.attr('title', minusText);
        $button.attr('aria-label', minusText);
        $button.attr('data-action', 'remove');
        $label.html("<%= I18n.t('advanced_search.remove_row') %>");
    }
}

function update_all_button_states() {
    $as.find('.search_row').each(function(i) {
        const $button = $(this).find('.plusminus-btn');
        const isLastRow = (i == $as.find('.search_row').length - 1);
        set_button_state($button, isLastRow ? 'add' : 'remove');
    });
}

var submit_on_enter = function(e) {
    var key = e.which;
    if (key == 13) {
        $("#submit_search").click();
        return false;
    }
}

function initialize_search() {
    $as = $("#advanced_search");
    $as.find('.search_row .plusminus-btn').off('click').on('click', fn_plusminus);
    update_all_button_states();
    /* save the first_row, so we don't always have to find it */
    var $first = $($as.find("#search_row_0"));
    $template = $first.clone();
    $template.find(':input').each(function() {
        if ($(this).is('select')) {
            $(this).find('option[selected]').removeAttr('selected');
        } else {
            $(this).val(''); // empty all row values
        }
    });
    $template.find(".norepeat").each(function() {$(this).addClass("d-none"); });
    $template.find(".d-none.options-for-select").each(function() {$(this).removeClass("d-none"); });
    $template.find("#op0").prop('disabled', null); /* the disabled boolean operator */
    $template.find("#op0").val('AND');
    $template.find("#op_").remove();
    $(".js-search-box").keypress(submit_on_enter);

    // squash whitespace in rows
    $first.find('> .search-operator-field:first').hide();
    $first.find('> .col-sm-3:first').addClass('col-sm-4').removeClass('col-sm-3');
    $template.find('> .col-sm-3.norepeat').remove();
    $template.find('> .col-sm-3:first').addClass('col-sm-6').removeClass('col-sm-3');

    return true;
}

function new_row_from_template() {
    const num = $as.find(".search_row").size();
    const $row = $template.clone();
    replace_id_ref($row, 'label', 'for', num);
    replace_id_ref($row, 'input', 'id', num);
    replace_id_ref($row, 'select', 'id', num);
    replace_id_ref($row, 'button', 'id', num);
    $row.attr("id", "search_row_" + num);

    const $button = $row.find('.plusminus-btn');
    $button.find('i').removeClass(minusFACss).addClass(plusFACss);
    $button.attr('title', plusText);
    $button.attr('aria-label', plusText);
    $button.attr('data-action', 'add');
    $button.off('click').on('click', fn_plusminus);

    $row.keypress(submit_on_enter);

    return $row;
}

function add_search_line() {
    $row = new_row_from_template();

}

function replace_id_ref($row, selector, type, num) {
    $row.find(selector).each(function() {
            $(this).attr(type, $(this).attr(type).replace('0', num));
	});
}

// show subgroups within search results on demand
function toggle_subgroups(event) {
    var $button = $(this);
    var $result = $button.closest('.recordrow');
    var $container = $result.find('.classification-subgroups');
    var $tree = $result.find('.classification-subgroups-tree');

    if ($tree.is(':visible')) {
        $tree.hide();
        $button.attr('aria-pressed', 'false').removeClass('active');
        $button.find('.fa').removeClass('fa-minus').addClass('fa-plus');
    } else {
        $tree.show();

        if ($tree.is(':empty')) {
            var root_uri = $result.data('uri');
            var should_link_to_record = true;

            var tree = new LargeTree(new TreeDataSource(AS.app_prefix(root_uri + '/tree')),
                $tree,
                root_uri,
                true,
                new SimpleRenderer(should_link_to_record),
                $.noop,
                $.noop);
        }

        $button.attr('aria-pressed', 'true').addClass('active');
        $button.find('.fa').removeClass('fa-plus').addClass('fa-minus');
    }
};

$(function() {
    $('.search-results').on('click',
        '.recordrow .classification-subgroups button.subgroup-toggle',
        toggle_subgroups);
});


$(function() {
    $('#toggleRefineSearch').on('click', function(event) {
        event.preventDefault();

        var $btn = $(this);
        var $refine = $btn.closest('.searchstatement').find('#refineSearchPanel');
        if ($refine.is(':visible')) {
            $refine.css('display', 'none');
            $refine.attr('aria-hidden', 'true');
            $btn.removeClass('active');
            $btn.attr('aria-expanded', 'false');
        } else {
            $refine.css('display', 'block');
            $refine.attr('aria-hidden', 'false');
            $btn.addClass('active');
            $btn.attr('aria-expanded', 'true');
        }
    });
});
